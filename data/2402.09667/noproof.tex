\documentclass[11pt]{amsart}
\usepackage[ruled]{algorithm2e} \usepackage[sort]{natbib}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{graphicx}
\usepackage{tikz}
\usepackage{xcolor}
\usepackage{float}
\usepackage{wrapfig}
\usepackage{hyperref}
\allowdisplaybreaks
\usepackage{bookmark}
\usepackage{enumitem} \newcommand{\Ex}[1]{ \mathbb{E} \left[#1\right] }
\newtheorem{theorem}{Theorem}
\newtheorem*{theorem*}{Theorem}
\newtheorem{open}{Open Problem}
\newtheorem*{conjecture*}{Conjecture}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{observation}[theorem]{Observation}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{claim}[theorem]{Claim}
\newtheorem*{claim*}{Claim}
\newtheorem{fact}[theorem]{Fact}
\renewcommand{\epsilon}{\varepsilon}


\newcommand{\quotebox}[1]
{\medbreak
\fcolorbox{white}{blue!15!gray!15}
{\begin{minipage}{0.95\linewidth}
{\emph{#1}}
\end{minipage}}
\medbreak}

\newcommand{\pparagraph}[1]{
\vspace{0.13in}\noindent{\textbf{\boldmath #1}}~}  

\newcommand{\cal}[1]{\mathcal{#1}}
\newcommand\numberthis{\addtocounter{equation}{1}\tag{\theequation}}

\newcommand{\E}{\mathbb{E}}
\renewcommand{\Pr}{\mathbb{P}}

\newcommand{\defn}{\textbf}
\newif\ifnotes
\notestrue
\ifnotes
\newcommand{\shikha}[1]{\textcolor{blue}{{\footnotesize #1}}\marginpar{\raggedright\tiny \textcolor{blue}{Shikha}}}
\else
\newcommand{\shikha}[1]{}
\fi

\newif\ifnotes
\notestrue
\ifnotes
\newcommand{\aditya}[1]{\textcolor{purple}{{\footnotesize #1}}\marginpar{\raggedright\tiny \textcolor{purple}{Aditya}}}
\else
\newcommand{\aditya}[1]{}
\fi
 \allowdisplaybreaks

\usepackage[margin=1in]{geometry}
\parskip   4pt

\usepackage{bookmark}



\title{Unbalanced Random Matching Markets with Partial Preferences}


\author{Aditya Potukuchi}
\address[AP]{Department of Electrical Engineering and Computer Science, York University, Toronto, ON M3J 1P3, Canada}
\email{apotu@yorku.ca}



\author{Shikha Singh}
\address[SS]{Department of Computer Science, Williams College, Williamstown, MA 01267, USA}
\email{shikha@cs.williams.edu}




\begin{document}

\maketitle


\begin{abstract}

Properties of stable matchings in the popular random-matching-market model have been studied for over 50 years. In a random matching market, each agent has complete preferences drawn uniformly and independently at random.  Wilson (1972), Knuth (1976) and Pittel (1989) proved that in balanced random matching markets, the proposers are matched to  their $\ln n$th choice on average.  In this paper, we consider markets where agents have partial (truncated) preferences, that is, the proposers only rank their top $d$ partners. Despite the long history of the problem, the following fundamental question remained unanswered: \emph{what is the smallest value of $d$ that results in a perfect stable matching with high probability?}  In this paper, we answer this question exactly---we prove that a degree of $\ln^2 n$ is necessary and sufficient.  That is, we show that if $d < (1-\epsilon) \ln^2 n$ then no stable matching is perfect and if $d > (1+ \epsilon) \ln^2 n$, then every stable matching is perfect with high probability. This settles a recent conjecture by Kanoria, Min and Qian (2021).



We generalize this threshold for unbalanced markets: we consider a matching market with $n$ agents on the shorter side and $n(\alpha+1)$ agents on the longer side. We show that for markets with $\alpha =o(1)$, the sharp threshold characterizing the existence of perfect stable matching occurs when $d$ is $\ln n \cdot \ln \left(\frac{1 + \alpha}{\alpha + (1/n(\alpha+1))} \right)$.  
 

Finally, we extend the line of work studying the effect of imbalance on the expected rank of the proposers (termed the ``stark effect of competition''). We establish the regime in unbalanced markets that forces this stark effect to take shape in markets with partial preferences.

\end{abstract}
 \section{Introduction}\label{sec:intro}

The stable matching problem is a classic problem in computer science, economics and mathematics.  In the standard and perhaps antiquated description of the problem as the ``stable marriage problem'', the two sides of the market are men and women, each with complete preferences over each other.  A matching is considered to be \defn{stable} if no pair of agents would prefer to break off from their current match and match with each other instead. Stability has proved to be an extremely robust notion in the success of centralized two-sided matching markets~\cite{roth2002economist}.  The first stable matching algorithm proposed by~\cite{gale1962college} has since been used in many real-life matching markets such as matching doctors to hospitals, students to schools, and applicants to jobs; see for example~\cite{roth1999redesign,abdulkadirouglu2005new,abdulkadirouglu2005boston,correa2019school}.  



Initiated by~\cite{wilson1972analysis,knuth1976mariages}, there has over 50 years of fascinating research to understand the properties of stable matchings in random-matching markets, where the preferences of the agents are generated uniformly and independently at random.  


\subsection{Our Results} 
In this paper, we study a fundamental and natural question about random matching markets with partial preference lists: 
\quotebox{If each agent ranks only their top $d$ choices (uniformly and independently at random), how big does $d$ have to be to ensure that all agents are matched?} 
We consider a two-sided market, with potentially unequal number of agents on each side, and say that a stable matching is \defn{perfect} if it matches all agents on the short side. 


As our main result, we tightly characterize the existence of perfect stable matchings.






\begin{theorem*}(Informal)
Given a stable matching market with $n+k$ candidates, $n$ jobs and uniform-random preference lists of length $d$, there exists a \defn{threshold} $d_0$ such that for any (constant) $\epsilon > 0$, 
\begin{itemize}
\item if $d > (1 + \epsilon)d_0$, then all stable matchings are {perfect} with high probability, and
\item if $d < (1 - \epsilon)d_0$, then no stable matching is perfect  with high probability.
\end{itemize}
Moreover, we determine $d_0$ asymptotically:

\begin{enumerate}
    \item\label{part:balanced} for \defn{\em balanced markets} with $k = 0$,~~ $d_0 = \ln^2 n$
    \item\label{part:unbalanced} for \defn{\em unbalanced markets} with $k = o(n)$,~~ $d_0 = \ln n \ln \frac{1 +(k/n)}{(k/n) + 1/(n+k)}$
\end{enumerate}
\end{theorem*}


For balanced markets, the above result settles a recent conjecture by~\cite{kanoria2021matching} who prove an weaker bound---they show $d = o(\ln^2 n)$ is not sufficient and $d = \Omega(\ln^2 n)$ is sufficient for a perfect stable matching to exist.  Even for complete preference lists, the best-known bound on the maximum number of proposals any agent has to make is $\Theta(\log^2 n)$ by~\cite{pittel2019likely}.

For unbalanced markets, Theorem~\ref{thm:unbalancedmain} provides a fundamentally new understanding of perfect stable matchings. Prior to this work, the best-known bounds are from~\cite{kanoria2021matching} who show that the threshold $d_0 = \Theta(\ln^ 2 n)$ continues to hold even in the presence of polynomially-small imbalance.  In particular, for imbalance $k = \Omega(n^{1-\epsilon})$, it was unknown whether (a) such a phenomenon of a sharp threshold continues to persist, and (b) how the existence of perfect stable matchings depends on the imbalance $k$ and preference list $d$ (even asymptotically). 

Finally, we also analyze how the competition in the market affects the best-possible stable partner that the candidates can obtain.


 \begin{theorem*}(Informal)
Given a stable matching market with $n+k$ candidates, $n$ jobs and uniform-random preference lists of length $d$, the expected rank of the best-possible stable partner each candidate can obtain is at least $(1-o(1)) d/(\ln \frac{1 +(k/n)}{(k/n) + 1/(n+k)})$.
\end{theorem*}
 Theorem~\ref{thm:ranklower} captures the intuitive property that the more the competition between the $n+k$ candidates for the $n$ jobs, the worse their stable outcome (as a function of the imbalance $k$).  Thus, it generalizes part of the results in the line of work studying the ``stark effect of competition'' in unbalanced matching markets~\cite{ashlagi2017unbalanced, cai2022short, kanoria2021matching}.

\subsection{Background on Stable Matchings}
To provide some context for our results, we first review the classic \defn{deferred-acceptance (DA) algorithm}  by~\cite{mcvitie1970stable, gale1962college} to find a stable matching.  
Given the preference lists of each candidate and job, consider the following procedure in which the candidates ``propose'' to jobs on their list. At each point, a candidate without a potential match (chosen arbitrarily) proposes to the highest job on their list that they have not been rejected by yet. On receiving a proposal from a candidate $c$, a job $j$ becomes potentially matched to $c$ if $c$ is the highest ranked among the candidates that have proposed to $j$ so far, otherwise $j$ rejects $c$. The process goes on until every candidate has either been rejected by every job on their list, or has a potential match. At the end, the potential matches are final.  

The DA algorithm has some interesting properties that those unfamiliar may find surprising: (a) it always find a stable matching, and (b) this stable matching results in the best-possible stable partner for all candidates, and the worst-possible stable partner for the jobs.  Beyond algorithmic application, these properties also make the DA algorithm an important tool in the study of random instances. Notably, some of the early results by \cite{wilson1972analysis, knuth1976mariages, pittel1989average} on balanced matching markets with uniform-random and complete preference lists show that each candidate on average is matched to their $\ln n$th ranked job and each job is matched to their $(n/\ln n)$th ranked candidate. 

The DA algorithm readily generalizes to partial preferences, which were first studied by~\cite{gusfield1989stable}.  Notice that if the preference list length $d$ is too small, some candidates/jobs may remain unmatched.  Remarkably, the set of unmatched agents stays the same in every stable matching (this is referred to as the Lone Wolf Theorem~\cite{mcvitie1971stable}).  Thus, if a perfect stable matching exists, then all stable matchings are perfect.  


\subsection{Model and Formal Statement of Results}
Before we proceed, we formally define the model. Consider a two-sided matching instance $M_{n, d, \alpha}$ with $n(\alpha+1)$ candidates and $n$ jobs, where $\alpha \geq 0$. For balanced markets with $\alpha = 0$, we omit it from the instance and write $M_{n,d}$.

An edge $(c, j)$ between a candidate $c$ and job $j$ occurs independently with probability $d/n$  (thus the resulting graph is a bipartite Erd\"{o}s-R\'{e}nyi graph $G_{n(\alpha+1),n,d/n}$ graph). 
Each candidate and job have random ranking over their neighbors, chosen uniformly and independently. So, $M_{n,n}$ is just the random stable matching instance with complete preference lists.\footnote{We abuse notation and use $M_{n,d}$ to refer both to the stable matching instance (graph and rankings) and the graph itself.} 


We refer to $d$ as the \defn{degree} of the underlying random graph.   One may easily deduce that for a perfect stable matching, $d$ needs to be at least $(1-o(1))\ln n$, since otherwise, $M_{n,d}$ has no perfect matching with high probability. It turns out that the critical threshold for perfect stable matchings is a bit higher, and is $\ln^2 n$. 

This is the formal statement of our first main theorem.


\begin{theorem}\label{thm:balancedmain}
For each $\epsilon > 0$,
\begin{enumerate}
\item if $d \geq (1 + \epsilon)\log^2 n$, then w.h.p., all stable matchings in $M_{n,d}$ are perfect, and
\item if $d \leq (1 - \epsilon)\log^2 n$, then w.h.p., no stable matching in $M_{n,d}$ is perfect.
\end{enumerate}
\end{theorem}


The DA algorithm also naturally motivates another distribution over random stable matching instances, where each candidate chooses a set of $d$ (chosen in advance) jobs along with a uniform ranking independently, and each job ranks the candidates uniformly and independently. Let us use $M_{n,d}^{\mathcal{C}}$ to describe this model. This model of \emph{partial} preferences ($d<n$) was first considered by~\cite{immorlica2005marriage, immorlica2015incentives}, who assume that the proposing side has preference lists consisting of only $O(1)$ jobs (drawn independently at random using an arbitrary distribution).  They show that the number of candidates with more than one stable partner makes up a vanishingly small fraction. The study of $M_{n,d}^{\mathcal{C}}$ was revisited recently by~\cite{kanoria2021matching}, who showed that if $d = o(\ln^2 n)$, then w.h.p. no stable matching is perfect and if $d = \Omega(\ln^2 n)$, then w.h.p. every stable matching is perfect. Empirically, they observe that the threshold is about $\ln ^2 n$ for reasonable values of $n$.

It turns out that these different models are closely related to each other in the sense that some results (particularly, the type we are interested in) often translate between them when $d \gg \ln n$. Indeed, we prove that in this regime, a random instance from one of these models can be ``sandwiched'' using instances of another model that are close enough; see Lemma~\ref{lem:sandwich}.

We now formally state our general theorem on threshold for perfect stable matching.

\begin{theorem}\label{thm:unbalancedmain}
Consider a stable matching instance $M_{n, d, \alpha}$ where $0 \leq \alpha$ and $\alpha = o(1)$ and $1 \leq d \leq n$.  Then, for each $\epsilon >0$, 
\begin{enumerate}
    \item\label{part:unbalancedlower} if $d > (1 + \epsilon) \ln n \cdot \ln \left(\frac{1 + \alpha}{\alpha + (1/n(1+\alpha))} \right)$, then w.h.p, all stable matchings are perfect, and

    \item\label{part:unbalancedupper} if $d < (1- \epsilon) \ln n \cdot \ln \left(\frac{1 + \alpha}{\alpha + (1/n(1+\alpha))} \right)$, then w.h.p, no stable matching is perfect.
\end{enumerate}

\end{theorem}






\pparagraph{Competition in unbalanced matching markets.}  A particularly remarkable result by~\cite{ashlagi2017unbalanced} reveals the striking effect of even a small imbalance on random stable matching markets.  They consider random markets with $n+1$ candidates and $n$ jobs and complete preference lists---that is, a stable matching instance $M_{n, n, 1/n}$.  They show that on average each candidate is matched to their $\Omega(n/\ln n)$th ranked job, a stark drop from their $O(\ln n)$th ranked job in the balanced setting.\footnote{Part of this result was later simplified by~\cite{cai2022short}.} 
 Likewise, each job get's its $O(\ln n)$th ranked candidate, a stark rise from the $\Omega(n/\ln n)$ in the balanced case.  Thus, the huge advantage of being on the proposing side (over the non-proposing side) is lost as soon as there is {\em any} competition.  This intriguing discovery further motivates our study of stable matchings in a general $M_{n,d,\alpha}$ setting.  



The relationship between imbalance $\alpha$ and degree $d$ was recently studied by~\cite{kanoria2021matching}.  The focus of their work was to study 
the effect of competition as the degree $d$ becomes smaller.  They study stable matching instances $M_{n, d, \alpha}^{\cal{C}}$ with \emph{polynomially small imbalance}, that is, $1/n \leq \alpha \leq 1/n^{\epsilon}$, and show the following dichotomy:  (a) when $d = o(\ln ^2 n)$, there is no perfect matching and both candidates and jobs are matched to the $\sqrt{d}(1+ o(1))$-ranked partner on average and thus there is no effect of competition, and (b) when $d = \Omega(\ln^2 n)$, then all stable matchings are perfect and there is a stark effect of competition---in a candidate-proposing DA, the candidates are matched to their $(d/\ln n)$th ranked job and the jobs to their $\ln n$th ranked candidate.  


Our results complements their findings. 
 Theorem~\ref{thm:unbalancedmain} determines the exact threshold for the existence of perfect stable matchings, and, as a function of imbalance $\alpha$ that can be much larger than $1/n^{\epsilon}$.  Finally, Theorem~\ref{thm:ranklower} below improves the lower bound of $(d/\ln n)$ on the expected rank of the candidates in a candidate-proposing DA, and shows how it degrades as the competition grows.
 
 \begin{theorem}\label{thm:ranklower}
Consider a stable matching instance $M_{n, d, \alpha}^{\mathcal{C}}$ where $0 \leq \alpha$ and $\alpha = o(1)$ and $1 \leq d \leq n$. Then, the expected rank of the candidates in the candidate-proposing DA is lower bounded by 
\[(1-o(1)) \frac{d}{\ln \left( \frac{1+\alpha}{\alpha + 1/n(1+\alpha)}\right)}.\]
\end{theorem}

A brief, but rather curious, technical remark: the methods of~\cite{kanoria2021matching} prove a lower bound of $\sqrt{d}(1+o(1))$ (with imbalance $\alpha$ being a lower-order term). This bound is better than the one in Theorem~\ref{thm:ranklower} when $\alpha \ll e^{-\sqrt{d}}$. Interestingly enough, the regime that they work in, $\alpha = n^{-\epsilon}$ and $d = o(\log^2 n)$, reflects this and the competition in this regime plays a negligible role. It would be a natural guess that $\alpha \approx e^{-\sqrt{d}}$ is where the ``stark effect of competition'' phenomenon starts to take shape.  So, we conjecture that the bound in Theorem~\ref{thm:ranklower} is tight when $\alpha \gg e^{-\sqrt{d}}$.




\subsection{Technical Contributions} 
We develop the following technical tools in our analysis.  



 First, we compare the proposals in the DA algorithm to a balls-in-bins process. This comparison itself is not new: analyzing the DA as a balls-and-bins or coupon-collector game dates back to the original papers by~\cite{wilson1972analysis, knuth1976mariages}. We add to this approach by providing some general bounds using simple methods that could simplify similar proofs in the future.

 Second, to establish whether or not a stable matching exists, we focus on which of the two competing forces in the DA algorithm occurs first:  each of the $n$ jobs receiving a proposal or some candidate exhausting all $d$ of their proposals. We analyze this competition by defining a simple probabilistic game on the ``rejection chains'' in the DA algorithm. \cite{kanoria2021matching} also analyzes rejection chains, but at a conceptual level, understanding the competing forces seems to offer a fundamentally different approach. For instance, the analysis in~\cite{kanoria2021matching} requires a bound on the total number of proposals made in the DA algorithm. The aforementioned game lets us circumvent this and isolate the event of interest (the existence of a perfect stable matching).
 
 
Finally, we study three closely related random models: the symmetric case $M_{n, d, \alpha}$ which is arguably the most natural to state as it is independent of which side of the market proposes,  
 and the asymmetric models $M_{n, d, \alpha}^{\cal{C}}$ and $M_{n, d, \alpha}^{\cal{J}}$ in which the candidates and jobs choose preference lists of length $d$ respectively.  Switching between these models helps analyze the problem from both sides: in particular, we analyze the candidate-proposing DA on $M_{n, d, \alpha}^{\cal{C}}$ and the job-proposing DA on $M_{n, d, \alpha}^{\cal{J}}$.  We combine these results to obtain a bound for $M_{n, d, \alpha}$  using a ``sandwiching lemma'' (Lemma~\ref{lem:sandwich}).  We believe that this approach of analyzing the DA on different random stable-matching instances provides new insights as past work has only studied the instance $M_{n, d, \alpha}^{\cal{C}}$.


 

\subsection{Additional Related Work}\label{sec:related}
The original stable matching algorithm by~\cite{gale1962college} was extended to the imbalanced case by~\cite{mcvitie1970stable}, and to the case of partial preferences by~\cite{gusfield1989stable}. Stable matchings have since been extensively studied over 60 years with several books on the topic;  we refer to the readers to~\cite{manlove2013algorithmics}.


Here we present closely related results on random-matching markets. \cite{wilson1972analysis, knuth1976mariages}  reduce the problem of running deferred acceptance in random balanced matching markets with complete lists, $M_{n,n}$, to the coupon-collector problem and use it to compute its average complexity.  This technique is used in various works (including this paper), e.g.~\cite{kanoria2021matching, ashlagi_et_al:LIPIcs.ITCS.2021.46,ashlagi2017unbalanced}. \cite{Wilson1972AnAO} showed that the expected number of proposals in the candidate-proposing DA is at most $n H_n$. \cite{knuth1976mariages} improved this upper bound to $(n-1) H_n +1$ and proved a matching lower bound of $n H_n - O(\ln^4 n)$.  Thus, the candidates side are matched to their $\ln n$th ranked partner in expectation. In contrast, \cite{pittel1989average} showed that the receiving side is a lot worse and is matched to their $(n/\ln n)$th partner in expectation.  


 The algorithm to enumerate all stable partners of an agent (by breaking matches and continually running deferred acceptance) was suggested by McVittie~\cite{mcvitie1971stable} and Gusfield~\cite{gusfield1987three}.  In this paper, we use the simplified version by~\cite{knuth1990stable}.  This technique has also often used to show that each agent has a unique stable partner~\cite{immorlica2005marriage, ashlagi2017unbalanced}, the phenomenon referred to as ``core convergence''.

 Non-uniform preference distributions have been studied, such as tiered preferences~\cite{ashlagi_et_al:LIPIcs.ITCS.2021.46} or correlated preferences~\cite{gimbert2021two}. Partial preference lists based on public scores was recently studied by~\cite{agarwal2023stable}. 
 
 For a recent survey on the history and results on random matching markets, see~\cite{mauras2021analysis}.




\subsection{Organization} We describe the model, the deferred acceptance algorithm, as well the main building blocks of our analyses---the probability game---in Section~\ref{sec:prelim}.
We give the the tight upper and lower bounds on the threshold in Section~\ref{sec:threshold}.  Finally, we analyze the expected rank in Section~\ref{sec:expected}.  











 \section{Preliminaries}\label{sec:prelim}

In this section, we formally define our model, the stable matching algorithm used and other definition and notation used in the rest of the paper.

\pparagraph{Stable matchings.}  Consider a stable matching instance $M$ with $n(\alpha+1)$ candidates $\mathcal{C}$ and $n$ jobs $\mathcal{J}$. Without loss of generality assume that $\alpha \geq 0$. Each candidate $c \in \mathcal{C}$ has a (partial) preference list of length $d_c^M$ over a subset of jobs ranking them from the most to lease preferred.  Similarly, each job $j \in \mathcal{J}$ has a (partial) preference list of length $d_j^M$ over a subset of candidates ranking them from most to lease preferred. Consider the undirected bipartite graph $G^M$ on $\mathcal{C} \cup \mathcal{J}$ where the edge $(c, j)$ is present if $c$ appears on $j$'s preference list and vice versa. Let $L_c^M= (j_1,\ldots,j_{d_c^M})$ to denote the list of the candidate $c$ in $M$. We define $L_j^M$ for jobs analogously. 

For stable matching instances $M_1$ and $M_2$ on $\mathcal{C} \cup \mathcal{J}$, we say that $M_1 \subseteq_{\mathcal{C}}M_2$ if for each candidate $c \in C$, we have that $d_{c}^{M_1} \leq d_c^{M_2}$ and the first $d_{c}^{M_1}$ elements and their order in $L_c^{M_2}$ is the same as in $L_c^{M_1}$. Moreover, for every job $j$, the relative ranking of the candidates in $L_j^{M_1}$ remains the same. Similarly, we say that $M_1\subseteq_{\mathcal{J}}M_2$ if the same holds for every $j \in \mathcal{J}$.

A \defn{matching} $\mu$ is a set of vertex-disjoint edges in $G^M$.  A matching $\mu$ is \defn{perfect} if each job $j$ is an endpoint of some edge in $\mu$.
For simplicity, we let $\mu(c)$ denote a candidate $c$'s match in $\mu$ (let $\mu(c) = \emptyset$ if $c$ is unmatched).  We define $\mu(j)$ similarly for a job $j$.
A matching $\mu$ is \defn{stable} if there exists no \defn{blocking pair} with respect to $\mu$.  A pair $(c, j)$ where $c \in \mathcal{C}$ and $j \in \mathcal{J}$ is \defn{a blocking pair} with respect to the matching $\mu$ if any one of the following conditions hold:  (a) $c$ prefers $j$ to $\mu(c)$  and $j$ prefers $c$ to $\mu(j)$, (b) $c$ prefers $\emptyset$ to $\mu(c)$, and (c)  $j$ prefers $\emptyset$ to $\mu(j)$.

\pparagraph{Deferred-acceptance algorithm.}
We describe the \defn{candidate-proposing deferred-acceptance} (CPDA) algorithm in Algorithm~\ref{alg:cpda}.  The job-proposing DA (JPDA) is analogous.  

Let $\cal{U}$ be the set of unmatched candidates.  Let $\cal{R}$ be the set of candidates who have \defn{exhausted} their preference list, that is, have been rejected by all jobs on their preference list.  


\begin{algorithm}
\caption{Candidate Proposing Deferred-Acceptance (CPDA) Algorithm }\label{alg:cpda}
Fix an ordering over $\cal{C}$;   Initialize $\cal{U} \gets \cal{C}$ and $\cal{R} \gets \emptyset$ and $\mu(j) \gets \emptyset$ for all $j \in \cal{J}$

\While{$\cal{U} \setminus \cal{R} \neq \emptyset$}{
    Pick a candidate $c \in \cal{U}$ with the lowest index  

    \If{$c \notin \cal{R}$}{

    Let $j$ be the most preferred job on $c$'s list that $c$ has not yet proposed to
    
    \If{\emph{$j$ is the last job on $c$'s list}}
        {add $c$ to $\cal{R}$}
        
    $c$ \defn{proposes} to $j$;  Let $c' = \mu(j)$
    
    \If{\emph{$j$ prefers $c$ to $c'$}}
          {
          $j$ \defn{rejects} $c'$
          
          \If{$c' \neq \emptyset$}
            {add $c'$ to $\cal{U}$}
          $j$ \defn{accepts} $c$;
    
       Set $\mu(j) = c$ and remove $c$ from $\cal{U}$
          }
    }
  }
\end{algorithm}





We use the following properties of the CPDA algorithm.
\begin{theorem}\label{thm:DAfacts}{\cite{gale1962college,mcvitie1970stable}}
The CPDA algorithm has the following properties:
\begin{enumerate}
\item It outputs a stable matching $\mu^*$.  The matching $\mu*$ is \defn{candidate optimal}, that is, each candidate is matched to their best-possible stable match.  Moreover, $\mu^*$ is \defn{job pessimal}, that is, each job is matched to their worst-possible stable match. 
\item\label{label:order} The matching $\mu^*$ is independent of the order of the proposals.  Moreover, the {same proposals} are made during the algorithm, regardless of which candidate is chosen to propose at each step.
\item\label{label:lonewolf} (\textbf{Lone Wolf Theorem}) The candidates and jobs that are unmatched in $\mu^*$ do not have any possible stable partner. That is, the set of unmatched agents is the same across all stable matchings.
\end{enumerate}
\end{theorem}


\pparagraph{Algorithm terminology.}  
We define the current \defn{time step} of the CPDA algorithm as the number of proposals made so far. Since the next proposal is always from a currently unmatched candidate with the lowest index, a candidate keeps proposing until either they are matched or exhaust their preference list. 
Moreover, if the $t$th proposal results in a rejection of a candidate $c$ (either because $c$ made the proposal, or because the $t$th proposal causes a previously-matched $c$ to become unmatched) the next proposal is always from $c$.  This sequence of proposals is termed as the \defn{rejection chain} in the literature.   We use rejection chains in our analysis and define it more formally below.




\begin{definition}(Rejection Chain)\label{def:rejectionchain}
Fix any time step $t$ in CPDA (Algorithm~\ref{alg:cpda}) and let $c$ be the next candidate in line to propose. The rejection chain $R(t)$ starting at time step $t$ is empty if $c$ has been rejected by all jobs on their preference list.  Otherwise, let $j$ the job $c$ proposes to next.
\begin{itemize}
    \item If  $j$ is currently unmatched, then $R(t) = (c, j, \emph{accept})$.
\item Otherwise, if $j$ prefers $\mu(j)$ to $c$, then $R(t) = (c, j, \emph{reject}) \circ R(t+1)$.  
    \item Otherwise, if $j$ prefers $c$ to $\mu(j)$, then
    $R(t) = ((c, j, \emph{accept}), (c', j, \emph{reject})) \circ R(t+1)$.
\end{itemize}
\end{definition}


We use the following two observations about rejection chains in our analysis.
\begin{observation}\label{obs:rejectchain}
Consider the rejection chain $R(t)$ at time step $t$ defined in Definition~\ref{def:rejectionchain}.
\begin{enumerate}
    \item\label{obs:part1} $R(t)$ terminates when either previously unmatched job receives a proposal and thus will remain matched till the end, or a candidate is rejected by all jobs on their preference list and thus will remain unmatched till the end.
    \item\label{obs:part2} In a rejection chain, if $d$ contiguous proposals result in a rejection, then some candidate must have been rejected $d$ times and must remain unmatched.  
\end{enumerate}
\end{observation}
Note that Part~(\ref{obs:part2}) of the above observation was also used by~\cite{kanoria2021matching}.


\pparagraph{Deferred Acceptance on Random Instances.}
We recall the random stable matching instance $M_{n, d, \alpha}$ defined in Section~\ref{sec:intro}.
In this instance, there are $m = n(\alpha+1)$ candidates and $n$ jobs.  The underlying graph is a Erd\"{o}s-R\'{e}nyi graph $G_{n(\alpha+1), n, d/n}$. Thus, an edge $(c, j)$ between a candidate $c$ and job $j$ occurs with independent probability $d/n$. Moreover, each candidate and job have a random ranking over their neighbors, chosen uniformly and independently.  The stable matching instance $M_{n, d, \alpha}$ refers to the graph $G_{n(\alpha+1), n, d/n}$ and the preferences over the edges.  

Let us define two other related models of random stable matching instances. 
 Let us define $M^{\mathcal{C}}_{n,\alpha,d}$ to denote a stable matching instance with $n$ jobs, $n(1+\alpha)$ candidates, and each candidates chooses a preference list of $d$ jobs uniformly and independently. This is the model in~\cite{kanoria2021matching}.
 
 Similarly, we also define $M^{\mathcal{J}}_{n,\alpha,d}$ where each job chooses a preference list of $d$ candidates uniformly and independently.

We analyze the CPDA algorithm on $M^{\mathcal{C}}_{n,\alpha,d}$ and the JPDA algorithm on $M^{\mathcal{J}}_{n,\alpha,d}$.  To obtain the final result on the symmetric stable matching instance  $M_{n, d, \alpha}$, we relate all three random instances using the following ``sandwiching'' lemma.


\begin{lemma}(Sandwiching Lemma)\label{lem:sandwich}
For every $\delta > 0$, there is a joint distribution
$(M^{\mathcal{C}}_{n,\alpha,d(1-\delta)},$ $M_{n,\alpha,d},M^{\mathcal{C}}_{n,\alpha,d(1 + \delta)})$ such that with probability at least $1 - O\left(n\exp\{-\delta^2 d/3\}\right)$, we have 
\[
M^C_{n,\alpha,d(1-\delta)} \subseteq_{\mathcal{C}} M_{n,\alpha,d} \subseteq_{\mathcal{C}} M^C_{n,\alpha,d(1 + \delta)}.
\]
The same claim also holds for $(M^{\mathcal{J}}_{n,\alpha, d(1-\delta)}, M_{n,\alpha,d(1+\alpha)},M^{\mathcal{J}}_{n,\alpha, d(1+\delta)})$.
\end{lemma}

Since we (eventually) analyze the DA algorithm on a random instance $M_{n,\alpha, d}^{\mathcal{C}}$, we reveal the next job $j$ in the list of candidate $c$ when they are called up to propose, uniformly among all jobs that have not already rejected $c$. We also reveal $c$'s relative ranking among all the proposals received by $j$ (including from $c$) when $c$ proposes to $j$.


\subsection{A Probability Game}
\label{sec:game}

Define a multi-round probabilistic game as follows. In each round, there are three events that can occur: $G$ (Good), $B$ (Bad), and $N$ (Neutral).  Given an input parameter $d$,  for each round, conditioned on the events in previous rounds, define
$\Pr(G) = p_G$, $\Pr(B) \geq p_B$ and $\Pr(N) = p_N$.  The game is \defn{won} if $G$ occurs.  The game is \defn{lost} if $B$ occurs $\delta$ times \emph{in a row}.  

Let $\Pr_{\text{win}}(p_G, p_B)$ denote the probability of winning this game.  Then, we prove the following.

\begin{lemma}\label{lem:probgame}
\begin{equation*}
  \Pr_{\text{\em win}}(p_G, p_B) 
\leq \frac{p_G}{p_B^d}
\end{equation*}
\end{lemma}

\begin{proof}\textcolor{red}{TOPROVE 0}\end{proof}

\pparagraph{Notation.}  
We say an event $\mathcal{E}$ occurs \defn{with high probability} if $\mathbb{P}(\mathcal{E}) = 1-o(1)$. 

 \section{Proof of Theorem~\ref{thm:unbalancedmain}}\label{sec:threshold}
In this section, we prove Theorem~\ref{thm:unbalancedmain}.  That is, we prove tight upper and lower bounds on the degree $d$ that determines whether or not a stable matching exists in a random matching market with imbalance $\alpha$ and average degree $d$. As alluded to earlier, we prove the lower bound on $M_{n,\alpha,d(1+o(1))}^{\mathcal{C}}$, and upper bound on $M_{n,\alpha,d(1-o(1))}^{\mathcal{J}}$.



\begin{theorem}\label{thm:threshlower}
For any $\gamma>0$, if $d < (1-\gamma) \log n \cdot \log \left( \frac {1 + \alpha}{\alpha + (1/n(1+\alpha))} \right)$, then 
\[
\mathbb{P}\left(M_{n, \alpha, d}^{\cal{C}}~\emph{has no perfect stable matching}\right) \geq 1 - (\alpha + 1/n)^{-\Omega(\gamma)}.
\]
\end{theorem}


\begin{theorem}\label{thm:threshupper}
 For any $\gamma > 0$, if $d > (1+\gamma) \log n \cdot \log \left( \frac {1+\alpha}{\alpha + (1/n(1+\alpha))} \right)$, then 
 \[\mathbb{P}(M_{n, \alpha, d}^{\cal{J}} \emph{ has a perfect stable matching}) \geq 1 -{n^{-\Omega(\gamma)}}\]
\end{theorem}

We prove Theorems~\ref{thm:threshlower} and~\ref{thm:threshupper} in Section~\ref{sec:lower} and Section~\ref{sec:upper} respectively.  Using them, we finish the proof of Theorem~\ref{thm:unbalancedmain} below.

\begin{proof}\textcolor{red}{TOPROVE 1}\end{proof}


\subsection{High-Level Overview}
We first describe the high-level idea of the upper and lower bound proofs for the balanced case ($\alpha=0$) to give some intuition.  

\pparagraph{Lower bound.}  To show that a perfect stable matching does not exist when the average degree $d < (1- \gamma) \log^2 n$ in $M_{n, d}$, we analyze the proposals when the CPDA algorithm is run on the random instance $M_{n, d}^{\mathcal{C}}$.  Thus, each candidate has a preference list of length $d$. Notice that in the CPDA, as soon as all $n$ jobs receive even a single proposal, the final matching must be perfect.  This is because jobs only upgrade their potential matches as the algorithm proceeds. On the other hand, a candidate $c$ remains unmatched if $c$ has been rejected by all $d$ jobs on their preference list.  Thus, to show that a perfect stable matching does not exist, we show that some candidate exhausts all $d$ of their proposals \emph{before} all $n$ jobs receive a proposal.  We model this using the probability game from Section~\ref{sec:game}.  Finally, we set the probabilities in the game using a careful coupling between CPDA and a balls-in-bins process.


This proof naturally extends to the unbalanced case:  we simply analyze the probability that $\alpha n + 1$ candidates exhaust all $d$ of their proposals before all $n$ jobs receive a proposal.

\pparagraph{Upper bound.} To show that a perfect stable matching exists when the average degree $d > (1+ \gamma) \log^2 n$ in $M_{n, d}$, we analyze the proposals in the JPDA algorithm is run on the random instance $M_{n, d}^{\mathcal{J}}$.  Thus, each job has a preference list of length $d$.
To prove that each job gets matched, we look at all the proposals made by the last job $j$ in JPDA and compute the probability that $j$ gets rejected from all $d$ candidates on its list and show that it is small.  For a single proposal from $j$ to a candidate $c$ to be successful, not only must $c$ accept it but the resulting rejection chain must not knock $j$ off.  We use the probability game to compute the probability of the latter.  

\subsection{Lower Bound: Proof of Theorem~\ref{thm:threshlower}}\label{sec:lower}



\begin{proof}\textcolor{red}{TOPROVE 2}\end{proof}


\subsection{Upper Bound: Proof of Theorem~\ref{thm:threshupper}}\label{sec:upper}
In particular, we prove the following.



\begin{proof}\textcolor{red}{TOPROVE 3}\end{proof}



 \section{Effect of Competition: Proof of Theorem~\ref{thm:ranklower}}\label{sec:expected}

In this section, we prove a lower bound on the expected ranks of the candidates and the number of proposals in CPDA in an unbalanced random matching market with imbalance $\alpha$.  In particular, we prove Theorem~\ref{thm:ranklower}.


\begin{proof}\textcolor{red}{TOPROVE 4}\end{proof}






 \section{Conclusion}\label{sec:conclusion}
In this paper, we study a fundamental question about the existence of perfect stable matching in random matching markets with imbalance and partial preferences.  We prove sharp upper and lower bounds on the length of the preference list $d$ that results in a perfect stable matching.  



Partial preferences and imbalance are common occurrences in real matching markets.
We believe that the new insights from this paper about the interplay between them will serve as guiding principles in market design.


%
 \section{Acknowledgements}
This paper was supported in part by NSF CCF 1947789.  

We would like to thank Jackson Ehrenworth and Max Enis for their contributions to a 
related project which led us to work on this paper.
 \bibliographystyle{ACM-Reference-Format}
\bibliography{stablematching}
\section{Appendix: Omitted Proofs}\label{sec:appendix}
In this section, we include the proofs omitted from the main paper of the paper.

\pparagraph{Notation.} We use $[n]$ to denote $\{1, \ldots, n\}$ and $[a, b]$ to
denote $\{a, a+1, \ldots, b\}$ for integers $b\geq a$.


\subsection{Large deviation inequalities}
We recall the Chernoff bound (\cite{DP09} Theorem $1.1$). Let $X$ be a $\operatorname{Bin}(n,p)$ random variable. Then
\[
\mathbb{P}(|X - \mathbf{E}[X]| \geq \delta \mathbf{E}[X]) \leq 2\exp\left\{\delta^2\mathbf{E}[X]/3\right\}.
\]
We say a function $f:\mathcal{X}^n \rightarrow \mathbb{R}$ is $k$-Lipschitz if for every $x_1,\ldots,x_n \in \mathcal{X}$, we have
\[
\max_{x_i'\in \mathbf{X}}|f(x_1,\ldots,x_{i-1},x_i,x_{i+1},\ldots,x_n) - f(x_1,\ldots,x_{i-1},x_i',x_{i+1},\ldots,x_n)| \leq k.
\]
McDiarmid's inequality (\cite{DP09} Corollary $5.2$) states that for randomly and independently chosen $X_1,\ldots,X_n \in \mathcal{X}$, we have
\[
\mathbb{P}(|f(X_1,\ldots,X_n) - \mathbf{E}[f(X_1,\ldots,X_n)]| \geq t) \leq 2\exp\left\{-\frac{2t^2}{k^2n}\right\}
\]


\subsection{Sandwiching: Proof of Lemma~\ref{lem:sandwich}}

\begin{proof}\textcolor{red}{TOPROVE 5}\end{proof}

\subsection{Probability Bounds for the Deferred Acceptance Algorithms: Proof of Claim~\ref{claim:probbounds}}

\begin{proof}\textcolor{red}{TOPROVE 6}\end{proof}

\subsection{Expected number of rounds in JPDA: Proof of Claim~\ref{lem:jpda-balls-bins}}

\begin{proof}\textcolor{red}{TOPROVE 7}\end{proof}
 \end{document}
