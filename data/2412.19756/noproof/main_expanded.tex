\documentclass[notitlepage]{scrartcl}
\usepackage[shortlabels]{enumitem}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{abstract}
\usepackage{xcolor}
\usepackage{comment}
\usepackage{mathtools}
\usepackage{graphicx}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{float}
\usepackage{enumitem}
\usepackage{hyperref}
\usepackage{stmaryrd} \hypersetup{
    colorlinks=true,
    linkcolor=blue,
    filecolor=magenta,      
    urlcolor=cyan
    }
\makeatletter
\newcommand*{\barfix}[2][.175ex]{\mathpalette{\@barfix{#1}}{#2}}
\newcommand*{\@barfix}[3]{\vbox{\kern#1\relax
    \hbox{$#2#3\m@th$}}}
\makeatother

\long\def\mz#1{\textcolor{red}{\textbf{[MZ comments:} #1\textbf{]}}}


\newcommand{\cF}{F}
\newcommand{\cH}{H}
\newcommand{\cG}{\mathcal{G}}
\newcommand{\sat}{\textit{sat}}
\renewcommand{\exp}{\text{exp}}

\newcommand{\br}[1]{\llbracket{#1}\rrbracket}

\newtheorem{theorem}{Theorem}
\newtheorem{thm}{Theorem}[section]
\newtheorem{observation}[thm]{Observation}
\newtheorem{corollary}[thm]{Corollary}
\newtheorem{lemma}[thm]{Lemma}
\newtheorem{proposition}[thm]{Proposition}
\newtheorem{claim}[thm]{Claim}
\newtheorem{remark}[thm]{Remark}
\newtheorem{conjecture}[thm]{Conjecture}
\newtheorem{question}[thm]{Question}
\newcommand{\footremember}[2]{\footnote{#2}
    \newcounter{#1}
    \setcounter{#1}{\value{footnote}}}
\newcommand{\footrecall}[1]{\footnotemark[\value{#1}]} 
\newcommand\wsat{\mathop{\mbox{$w$-$\mathit{sat}$}}}
\newcommand{\At}{\Tilde{A}}
\newcommand{\hA}{\hat{A}}
\newcommand{\Aht}{\hat{\tilde{A}}}

\newcommand{\IH}[1]{{\color{blue}{\large #1}}}
\newcommand{\SD}[1]{\textcolor{red}{ \large #1}}
\renewcommand{\Pr}{\mathbb{P}}
\DeclareMathOperator*{\argmax}{arg\,max}
\usepackage[toc,page]{appendix}

\usepackage[margin=1in]{geometry}
\begin{document}

\title{\vspace{-2em}Tree tilings in random regular graphs}
\author{Sahar Diskin \footremember{alley}{School of Mathematical Sciences, Tel Aviv University, Tel Aviv 6997801, Israel.}\and Ilay Hoshen \footrecall{alley}\and Maksim Zhukovskii \footremember{alley2}{School of Computer Science, The University of Sheffield, Sheffield S1 4DP, United Kingdom.}
}


\date{}
\maketitle
\begin{abstract}
We show that for every $\epsilon>0$ there exists a sufficiently large $d_0\in \mathbb{N}$ such that for every $d\ge d_0$, \textbf{whp} the random $d$-regular graph $G(n,d)$ contains a $T$-factor for every tree $T$ on at most $(1-\epsilon)d/\ln d$ vertices. This is best possible since, for large enough integer $d$, \textbf{whp} $G(n,d)$ does not contain a $\frac{(1+\epsilon)d}{\ln d}$-star-factor. Our method gives a randomised algorithm which \textbf{whp} finds said $T$-factor and whose expected running time is $O(n^{1+o(1)})$, as well as an efficient deterministic counterpart.
\end{abstract}


\section{Introduction}
Let $G$ be an $n$-vertex graph and $H$ be an $s$-vertex graph. An \textit{$H$-factor} in $G$ is a union of $\lfloor\frac{n}{s}\rfloor$ vertex-disjoint isomorphic copies of $H$ in $G$. 

There has been an extensive study into the threshold of appearance of $H$-factors in the binomial random graph $G(n,p)$. The case where $H = K_2$ corresponds to finding a perfect matching in $G(n, p)$. The sharp threshold for appearence of a perfect matching was established by Erd\H{o}s and R\'enyi \cite{ER66}. 
Early results for general $H$ were obtained by Alon and Yuster~\cite{alon1993threshold} and Ruci\'nski~\cite{R92}; they determined the threshold up to a constant factor for a specific family of graphs and gave bounds for the general case. For the case where $H$ is a tree, \L{}uczak and Ruci\'nski \cite{LR91} characterised `pendant' structures, and proved that in the random graph process (that is, when edges are added one after the other uniformly at random), the hitting time of the appearance of an $H$-factor is the same as the hitting time of the disappearance of these forbidden `pendant' structures. In particular, one is able to infer the precise threshold for the appearance of an $H$-factor in this case. In 2008, Johansson, Kahn and Vu \cite{johansson2008factors} determined the threshold (up to a multiplicative constant) for the existence of an $H$-factor for every strictly-1-balanced\footnote{A graph $H$ is strictly-1-balanced if $\frac{|E(H)|}{|V(H)| - 1} > \frac{|E(J)|}{|V(J)| - 1}$ for every proper subgraph $J \subsetneq H$ with $|V(J)| \ge 2$.} graph $H$ and determined the threshold up to a logarithmic factor for an arbitrary graph $H$. In the case of cliques $K_s$, Heckel (for $s=3$)~\cite{H21} and Riordan (for $s\ge 4$)~\cite{R22} determined the \textit{sharp} threshold for the appearance of an $H$-factor. Recently, a hitting time result for the appearance of a $K_s$-factor was proved~\cite{HKMP}, and the sharp threshold for the appearance of an $H$-factor for every strictly-1-balanced graph $H$ was determined~\cite{BHKMP}.

Much less is known in the case of \textit{random $d$-regular graphs}. The random $d$-regular graph $G(n,d)$ is a graph chosen uniformly at random among all simple $d$-regular graphs on the vertex set $\br{n}:=\{1,\ldots,n\}$ (throughout the paper, we treat $d$ as fixed and consider the asymptotics in $n$). Since, for every pair of integers $d \ge 2$ and $k \ge 3$, the number of cycles of length $k$ in $G(n, d)$ is asymptotically distributed as a Poisson random variable with mean $(d-1)^k/(2k)$ (see \cite{W81}), \textbf{whp}\footnote{With high probability, that is, with probability tending to one as $n$ tends to infinity.} there are $o(n)$ cycles of length $k$ in $G(n, d)$. Thus, we may (and will) restrict our attention to tree factors.

For the case of $H=K_2$, Bollob\'as~\cite{B81} proved that whp there exists an $H$-factor (that is, a perfect matching) in $G(n, d)$ for every $d \ge 3$.
There has been some research on the more general case of stars. Naturally, one cannot hope for a $K_{1,t}$-factor for $t>d$, since the graph is $d$-regular. For $d\ge 3$, using a first moment argument, one can show that \textbf{whp} $G(n,d)$ does not contain a $K_{1,d}$-factor (see \cite[Corollary 2]{assiyatun20063}). Robinson and Wormald \cite{robinson1994almost} showed that for $d\ge 3$, \textbf{whp} $G(n,d)$ contains a Hamilton cycle, and thus a $K_{1,2}$-factor. In a subsequent work, Assiyatun and Wormald \cite{assiyatun20063} showed that for $d\ge 4$, \textbf{whp} $G(n,d)$ contains a $K_{1,3}$-factor. One may then suspect that for any $d\ge 3$, typically $G(n,d)$ contains a $K_{1,d-1}$-factor. However, using first moment calculations, one can show that this is not the case for $d\ge 5$ (see Appendix~\ref{appendix}).

There are then two natural avenues to venture into: first, for sufficiently large $d$, to determine all $k$ such that \textbf{whp} $G(n,d)$ contains a factor of stars on $k$ vertices; second, more ambitiously, one could try to find all trees $T$ for which \textbf{whp} $G(n, d)$ contains a $T$-factor.

Considering a related but slightly different problem, Alon and Wormald \cite{alon2010high} showed that for any $d$-regular graph $G$, there exists an absolute constant $c'$, such that $G$ contains a star-factor, in which every star has at least $c'd/\log d$ vertices (not necessarily all stars are of the same size). We stress that here, and throughout the paper, all logarithms are with respect to the natural basis. They further noted that this is optimal up the choice of the constant $c'>0$. Indeed, the existence of a factor of stars on at least $k$ vertices implies the existence of a dominating set of size at most $\frac{n}{k-1}$, and for any $\epsilon>0$ and sufficiently large $d$, \textbf{whp} the smallest dominating set in $G(n,d)$ is of size at least $\frac{(1-\epsilon)n\log d}{d}$ (see \cite[page 3]{alon2010high}). Let us note here that if one only assumes that $G$ is $d$-regular, then one cannot hope to obtain a factor of stars of size exactly $k$ for any $3\leq k=O(d/\log d)$. Indeed, consider for example a $d$-regular graph $G$ formed by a collection of vertex disjoint copies of $K_{d+1}$ and vertex disjoint copies of complete bipartite graphs $K_{d,d}$. Then, since $\text{gcd}(d+1,2d)\in \{1,2\}$, for any choice of $k>2$, one cannot find a factor of stars of size $k$.

Our first main result shows that typically a random $d$-regular graph $G$ contains a star-factor with the asymptotically \textit{optimal} possible size. In fact, we extend this result to factors of \textit{any} tree (not necessarily a star).

\begin{theorem}\label{th: main}
For every constant $0< \epsilon<1$, there exists a sufficiently large integer $d_0$ such that the following holds for any $d\ge d_0$. \textbf{Whp}, for every tree $T$ on at most $\frac{(1-\epsilon) d}{\log d}$ vertices, there exists a $T$-factor in $G(n,d)$.
\end{theorem}
We note that throughout the paper, we will assume that $|V(G)|$ is divisible by $|V(T)|$, to avoid unnecessary technical details, however all proofs can be directly extended to the general case. Further, we note that we may fix the tree $T$ and show that \textbf{whp} there is a $T$-factor in $G(n,d)$; since there are at most $d^2\cdot 4^{d}$ such trees (see~\cite{Otter}) and $d$ is fixed, by the union bound the statement then holds for every tree $T$.

A detailed sketch of the proof of Theorem \ref{th: main} is presented in Section \ref{s: outline}. Let us briefly recap the main strategy here. We show that \textbf{whp}, there exists a balanced partition of $|V(G)|$ into $|V(T)|$ parts so that, for every pair of parts $V_i,V_j$ where $\{i,j\}\in E(T)$, every vertex in $V_i\cup V_j$ has the number of neighbours in the other part concentrated around the mean $d/|V(T)|$. We say that such a partition is \textit{nice}. We obtain this nice partition through four different applications of the algorithmic version of the Lov\'asz Local Lemma, due to Moser and Tardos~\cite{MT10}. In particular, this allows us to find such a nice partition which is \textit{close} to a random partition; further, this gives us a randomised algorithm to find this partition whose average running time is $\tilde{O}(n)$ \textbf{whp} (see Theorem \ref{th: LLL} and Corollary \ref{cor: lll}). In fact, we show that, in \emph{any} $d$-regular graph, which does not have short cycles close to each other, a fraction of the possible partitions are close to nice partitions. Utilising a description of the distribution of edges in random graphs with specified degree sequences (\cite{gao2023subgraph}, see also \cite[Theorem 2.2]{McKaySurvey}), we conclude that \textbf{whp} almost all partitions of a random regular graph induce multipartite graphs with good expansion properties. This allows us to find a partition with such expansion properties which is also close to a nice partition, ensuring the existence of a perfect matching between pairs of sets. Using an algorithm as in~\cite{chen2022maximum}, we can find these perfect matchings in time $n^{1+o(1)}$. This gives us our second main result.
\begin{theorem}\label{cor: running time}
For every constant $0< \epsilon<1$, there exists a sufficiently large integer $d_0$ such that the following holds for any $d\ge d_0$. There is a randomised algorithm that \textbf{whp} finds a $T$-factor in $G(n,d)$ in expected time $n^{1+o(1)}$, for every tree $T$ on at most $\frac{(1-\epsilon) d}{\log d}$ vertices.
\end{theorem}
Since the events that we consider in our applications of the algorithmic version of the Lov\'asz Local Lemma are determined by $\text{poly}(d)$ random variables over domains of size at most $d$, \cite[Theorem 1.4]{MT10} shows that there exists a \textit{deterministic} algorithm that \textbf{whp} finds these $T$-factors in polynomial in $n$ time in $G(n,d)$. 

Let us make some additional remarks.
\begin{itemize}
    \item It is not hard to verify that our proof follows through for a uniformly chosen graph on $n$ vertices with a given degree sequence, whose degrees lie in the interval $[d,(1+\delta)d]$ for some small $\delta>0$. We believe slight modifications of our technique, specifically in Section~\ref{s: theorems proof}, should allow us to obtain the same result for such graphs whose degrees are between $d$ and $O(d)$.
     \item We stress that in order to show the existence of a perfect matching between relevant sets in the partition, we need our partition to be close to a random partition, and thus the application of the algorithmic version of the Lov\'asz Local Lemma is crucial, even if we do not aim to get Theorem~\ref{cor: running time}.
\end{itemize} 
A possible simplification, which allows using a non-constructive version of the Lov\'asz Local Lemma, is applying `sprinkling' due to the contiguity result from~\cite{Janson:contiguity} instead of applying the direct estimation of probabilities in $G(n,d)$. As soon as a nice partition is obtained, we add independently edges of $G(n,\epsilon' d)$, where $\epsilon'\ll\epsilon$. Although it simplifies the proof, it does not allow deriving Theorem~\ref{cor: running time} and the generalisation to non-regular random graphs with specified degree sequences. Moreover, this does not allow obtaining any probability bounds, in contrast to our approach. Indeed, our proof gives that the probability a random $d$-regular graph has a $T$-factor (for any tree $T$ with $|V(T)|\le (1-\epsilon)d/\log d$) is at least $1-n^{-\Theta_d(1)}$.
In fact, the latter probability bound is tight. Indeed, consider the vertices $\{1,...,10d\}\in \br{n}$, say. The probability they form a connected component without a $T$-factor in $G(n,d)$ is at least $n^{-100 d^2}$. We thus obtain the following corollary.
\begin{corollary}
For every constant $0< \epsilon<1$, there exists a sufficiently large integer $d_0$ such that the following holds for any $d\ge d_0$. For any tree $T$ on at most $\frac{(1-\epsilon)d}{\log d}$, the probability that $G(n,d)$ contains a $T$-factor is $1-n^{-\Theta_d(1)}$.
\end{corollary}

One key complication that arises when using any variant of the Lov\'asz Local Lemma to prove Theorem~\ref{th: main} is that it is impossible to directly apply it, as every `bad' event has too many dependencies. A similar issue was addressed independently in the paper by Dragani\'c and Krivelevich~\cite{DK} on connected dominating sets, where they proposed a (significantly different and shorter) proof strategy to show that a $d$-regular graph without short close cycles has a nice partition. Notably, their method requires $\Theta(n)$ applications of the Lov\'asz Local Lemma (and consequently $O(n^2)$ resamples in the algorithmic version), which precludes a linear time reduction to finding perfect matchings. In contrast, our approach applies the Lov\'asz Local Lemma only a constant number of times, enabling such a reduction.











Let us finish this section with several avenues for future research. While in this general setting Theorem~\ref{th: main} is asymptotically best possible, for the case where $T$ is a path on $k$ vertices one can achieve a better result. Indeed, since $G(n,d)$ is typically Hamiltonian \cite{robinson1994almost}, one can \textbf{whp} obtain a factor of paths of any size. In fact, this observation can be generalised to all trees of bounded degree (see below). It would be interesting to try characterising, for every value of $k=k(n)$, families of trees $T$ on $k$ vertices for which one can \textbf{whp} obtain a $T$-factor in $G(n,d)$. 

As mentioned above, our proof uses results \cite{McKaySurvey, gao2023subgraph} on the distribution of edges in graphs chosen uniformly at random given a degree sequence. It would be interesting to see whether this step can be amended to allow our result to hold for pseudo-random $(n,d,\lambda)$-graphs, with $\lambda\ll d$ (see \cite{KS06} for background and many results on pseudo-random graphs). While a slight adjustment of our methods (with, in fact, a much simpler proof) yields that $\left(n,d,O(\sqrt{d})\right)$-graphs contain a star-factor for any star of size at most $\frac{d}{10\log d}$, this could be far from a complete answer. In fact, we are inclined to believe that Theorem \ref{th: main} should hold for $(n,d,\lambda)$-graphs with $\lambda=o(d)$. Let us mention here that, answering a question of Krivelevich \cite{K23}, Pavez-Sign\'e \cite{p23} showed that for $\lambda=o(d)$, an $(n,d,\lambda)$-graph contains a copy of every $n$-vertex tree with bounded degree and $\Theta(n)$ leaves. Subsequent work by Hyde, Morrison, M\"uyesser, and Pavez-Sign\'e \cite{HMMPM23} showed that for $\lambda=o(d/\log^3n)$, an $(n,d,\lambda)$-graph contains a copy of every $n$-vertex tree with bounded degree --- and thus, in particular, contains a $T$-factor for any tree $T$ of bounded degree. 

Another possible direction would be to consider the typical existence of any spanning forests in $G(n,d)$ whose degree is bounded by $(1-\epsilon)d/\log d$. Here, it might be interesting to attempt this first in the model of the binomial random graph, $G(n,p)$, for $p$ above the connectivity threshold, that is, $p\ge \frac{(1+\epsilon)\log n}{n}$. Is it true that it contains any spanning forest $F$ whose degree is bounded by $O(np/\log(np))$ \textbf{whp}? This is naturally tightly related to the universality question, with perhaps one key example being the result of Koml\'os, S\'ark\"{o}zy, and Szemer\'edi~\cite{KSS}, showing that that for every positive $\alpha,\Delta$ and sufficiently large $n$, every graph with minimum degree at least $(1/2+\alpha)n$ contains every tree on $n$ vertices with maximum degree at most $\Delta$.

\subsection{Organisation}
In Section \ref{s: notation} we set out some notation which will be of use throughout the paper. We then discuss the proof's structure and strategy in Section \ref{s: outline}.  In Section \ref{s: prelim} we collect some lemmas which we will utilise in subsequent sections. Section \ref{s: proposition} is devoted to the proof of the key proposition (Proposition \ref{prop: main path}), and is perhaps the most involved and novel part of the paper. Finally, in Section \ref{s: theorems proof} we prove two typical properties of $G(n, d)$ and show how to deduce Theorem~\ref{th: main} from these properties and Proposition \ref{prop: main path}.

\subsection{Notation}\label{s: notation}
Given a graph $H$, a vertex $v\in V(H)$, and a set $A\subseteq V(H)$, we denote by $d_H(v)$ the degree of $v$ and by $d_H(v,A)$ the number of neighbours of $v$ in $A$ (in $H$). When the graph in question is clear we may omit the subscript. We write $d(A)=\sum_{v\in A}d(v)$. Given $A,B\subseteq V(H)$, we denote by $e(A,B)$ the number of edges with one endpoint in $A$ and the other endpoint in $B$. When $A=B$, $e(A)=e(A,A)$ is the number of edges induced by $A$. We denote by $N(A,B)$ the neighbourhood of $A$ in $B$, that is, the set of vertices in $B$ which are adjacent to some vertex in $A$. All logarithms are with the natural base. Moreover, for every positive integer $n$, define $\br{n} \coloneqq \{1, 2, \dots, n\}$. We use the fairly standard notation that given sequences $a=(a_n)$ and  $b=(b_n)\geq 0$, $a=o(b)$ if, for every $\varepsilon>0$ there exists $n_0$ such that $|a_n|\leq\varepsilon b_n$ for all $n\ge n_0$. Given sequences $a'=(a'_d=a'_d(n))$ and $b'=(b'_d=b'_d(n))\geq 0$, we sometimes also use $a=o_d(b)$ to say that, for every $\varepsilon>0$ there exists $d_0,n_0$ such that $|a'_d|\leq\varepsilon b'_d$ for all $d\ge d_0$ and $n\ge n_0$. We systematically ignore rounding signs when it does not affect computations.

 
\section{Proof outline}\label{s: outline}
Unsurprisingly, finding a tree factor is much harder when the size of the tree is close to the optimal size (that is, $d/\log d$). In this section, we will present the proof outline for Theorem \ref{th: main} in the case when $k\geq\frac{\log d}{10d}$. We will further point out the steps where the proof becomes simpler for trees of smaller size.

Let $T$ be a tree on $k$ vertices and let us label these vertices by $V(T) \coloneqq \br{k}$. The overall strategy for finding a $T$-factor in $G \sim G(n, d)$ is quite intuitive. We will find $k$ disjoint sets $V_1, \dots, V_k \subseteq V(G)$ of equal size and show that \textbf{whp} there exists a perfect matching between every $V_i$ and $V_j$ such that $\{i,j\} \in E(T)$. To do so, our proof proceeds in two main steps. In the first step, we find `good' sets $V_1, \dots, V_k$ (in fact, we show such a partition typically exists in any $d$-regular graph $G$ without two short cycles close to each other). In the second step, we show the typical existence of a perfect matching between every relevant pair of these sets. The properties achieved in the first step facilitate the execution of the second step.

The first step of the proof, presented in Section \ref{s: proposition}, is perhaps the most involved and novel part. In this step, we establish key properties of the sets $V_1,\ldots, V_k$ which will be crucial in verifying the typical existence of perfect matchings in the second step. First, we show that for every $\{i,j\}\in E(T)$, the degree of every $v \in V_i$ into $V_j$ is around $d/k$. Notice that, this property alone does not suffice to establish the existence of a perfect matching between $V_i$ and $V_j$. To that end, we will also make sure that the sets $V_1, \dots, V_k$ are `close' to uniformly chosen sets. 

In the second step, presented in Section \ref{s: theorems proof}, we show that \textbf{whp}, for every $\{i,j\}\in E(T)$, there exists a perfect matching between $V_i$ and $V_j$ by showing that Hall's condition is satisfied. That is, we will show that \textbf{whp}, for every $W \subseteq V_i$, we have $|N(W, V_j)| \ge |W|$. To that end, we utilise a useful bound on the distribution of edges in graphs chosen uniformly at random given a degree sequence (see Theorem~\ref{th:gao} in Section \ref{s: prelim}, see also \cite{McKaySurvey}). First, we will show that \textbf{whp} for every two `small' sets $U,W\subseteq V(G)$ with $|U|=|W|$, there are not too many edges going from $U$ to $W$. Moreover, since the sets $V_1,\ldots, V_k$ were constructed in the first step in a way such that the degree of every vertex $v \in V_i$ to appropriate $V_j$'s is not too small, we obtain a lower bound on $e(W, V_j)$ for every $W \subseteq V_i$. In particular, if $|N(W, V_j)| < |W|$, we will get a contradiction for small sets $W\subseteq V_i$. In the same spirit, Theorem~\ref{th:gao} together with the properties of the sets $V_1,\ldots, V_k$ allows us to bound $|N(W, V_j)|$ for every `large' $W \subseteq V_i$ \textit{if} the sets $V_1, \dots, V_k$ were chosen uniformly at random. Indeed, given randomly chosen disjoint sets $A$ and $B$ (that is, sets formed without first exposing $G(n,d)$), the graph $G[A\cup B]$, given its degree sequence, has a uniform distribution. Luckily, the first step ensures that the sets $V_1.\ldots, V_k$ behave similarly to uniformly chosen sets.

Let us return to the first step of the proof and describe the broad strategy of showing the typical existence of the `good' sets $V_1, \dots, V_k$. We begin with a random partition of the vertices into $k$ parts, $S_1,\ldots, S_k$. A key tool in establishing the existence of such sets $V_1, \ldots, V_k$ is the Lov\'asz Local Lemma. Since we want our sets to be close to the initial random sets $S_1,\ldots, S_k$ (so that we may later be able to apply Theorem \ref{th:gao}), we will in fact utilise the algorithmic version of the Lov\'asz Local Lemma, due to Moser and Tardos (see Theorem \ref{th: LLL} in Section \ref{s: prelim}). Utilising the algorithmic version of the Lov\'asz Local Lemma, we can show that in each step of the algorithm we resample a small number of random variables assigned to vertices, and thus the initial random sets $S_1, \dots, S_k$ will not be `far' from $V_1,\ldots, V_k$. Let us note here that when applying the algorithmic version of the Lov\'asz Local Lemma, in the initial step of the algorithm one evaluates all `bad' events (requires $\tilde O(n)$ time), and then, at each `resampling' step, one re-evaluates only those $O(1)=O_d(1)$ events that depend on the resampled random variables. Since the expected number of steps of the algorithm of Moser and Tardos is $O(n)$, this gives the overall expected running time $\tilde{O}(n)$.

Now, for every vertex $v \in V(G)$, sample $X_v\in \br{k}$ uniformly at random, and independently for all vertices. For every $i \in \br{k}$, set $S_i \coloneqq \{v \in V(G) \colon X_v = i\}$. Moreover, for every vertex $v \in V(G)$, denote by $B_v$ the event that there exists $\{i, j\} \in E(T)$ such that $v \in S_i$ and $d(v, S_j) \notin [\delta d/k, C d/k]$ where $\delta>0$ is a sufficiently small constant and $C>0$ is a sufficiently large constant. Notice that if $\neg B_v$ occurs for every $v \in V(G)$, then we get the desired bounds on the degrees which is the first key point in the first step.

Note that, for every vertex $v \in V(G)$ and $j \in \br{k}$, we have $d(v, S_j) \sim \text{Bin}\left(d, 1/k\right)$. This distribution is the heart of the obstacle concerning `large' trees. The reason for it is that whenever $k \le \frac{d}{10\log d}$, then the probability that the degree of $v$ into $S_j$, for some $j \in \br{k}$, is not in the interval $[\delta d/k, C d/k]$ is at most $d^{-8}$. Furthermore, the event $B_v$ is determined by $d+1$ random variables $X_u$, and $B_v$ is independent of all but at most $d^2$ other events $B_u$. Therefore, we can apply the Lov\'asz Local Lemma. It is worth noting here that if $k\le \frac{d}{10\log d}$, we may omit the requirement that $\{i, j\} \in E(T)$ in the definition of $B_v$ (see Section \ref{s: small prop}). Then, if for every vertex $v \in V(G)$ we have that $\neg B_v$ holds, then $d(v, S_j) \in [\delta d/k, C d/k]$ for every vertex $v \in V(G)$ and index $j \in \br{k}$. 

However, as $k$ gets closer to $\frac{(1-\epsilon)d}{\log d}$, the probability that $\text{Bin}\left(d, 1/k\right) < \delta d/k$ is not smaller than $d^{-1-\epsilon'}$, for some $\epsilon' > 0$ tending to zero as $\epsilon$ tends to zero. Thus, the treatment of this case is much more delicate and involves several rounds of applications of the algorithmic version of the Lov\'asz Local Lemma, in order to refine the initial random partition. In the rest of this section, we describe these rounds.

Notice that, for every $i \in \br{k}$, the event $B_v$ conditioned on $v \in S_i$ is more likely to occur as the degree of the $i$-th vertex in $T$ gets larger. For this reason, we will treat vertices of small degree and vertices of large degree in $T$ differently (this treatment is in Section \ref{s: high deg}). Assume that $\br{h}$ is the set of vertices of $T$ with `large' degrees. We slightly decrease the probability that $X_v = i$, for every $i \in \br{h}$. Then, after one application of the Lov\'asz Local Lemma we will be able to get rid of vertices which have more than $C d/k$ neighbours into $S_j$, for some $j \in \br{h}$. Next, we consider the neighbourhood of the vertices which have degree less than $\delta d/k$ into $S_j$, for some $j \in \br{h}$. We `resample' the vertices in this neighbourhood outside of $S_1,\ldots, S_h$ into $S_1, \dots, S_h$, that is, we move them into one of the sets $S_1,\ldots, S_h$ uniformly at random. In this way, once again using the Lov\'asz Local Lemma, we will have that $d(v, S_j) \in [\delta d/k, C d/k]$ for every $v \in V(G)$ and $j \in \br{h}$.

Next, in Section \ref{s: low degree}, we partition the remaining vertices among $S_{h+1}, \dots, S_k$. In this third application of the Lov\'asz Local Lemma, we will ensure that after the resampling we have the property that $d(v, S_j) \in [\delta d/k, Cd/k]$ for every vertex $v \in V(G)$ and for all but at most $\epsilon^{-2}$ indices $j \in \br{k}$. At this point, there will still be vertices $v \in S_i$ which have less than $\delta d/k$ neighbours into some $S_j$ where $\{i,j\}\in E(T)$. After the fourth application of the Lov\'asz Local Lemma, we will be able to obtain a partition with no such vertices (that is, $d(v, S_j) \in [\delta d/k, Cd/k]$ for every $v\in S_i$ and $\{i,j\}\in E(T)$).

Finally, in Section \ref{s: equal size}, we adjust the sets $S_1, \dots, S_k$ to be of size $n/k$ each. This is the purpose of the fifth and final round of the Lov\'asz Local Lemma. In this round, we will move vertices from sets of size bigger than $\frac{n}{k}$ to sets of size smaller than $\frac{n}{k}$ in a random manner. We will do so while ensuring the vertices $v$ we move satisfy that $d(v, S_j)\in [\delta d/k, Cd/k]$ for every $j\in \br{k}$. After this round, while keeping the bounds over the degrees of the vertices, we will be able to make each set $S_i$ to be close to $n/k$ up to and additive $n/d^{100}$ error term. Finally, to make the sets exactly of size $\frac{n}{k}$, we introduce a deterministic argument adjusting the sets $S_1,\ldots,S_k$ while changing the degree of every vertex to every set $S_i$ by at most one. We thus obtain the required sets $V_1,\ldots, V_k$.




\section{Preliminaries}\label{s: prelim}
We will make use of the following fairly standard Chernoff-type probabilistic bounds (see, for example, Appendix A in \cite{AS16}).
\begin{lemma}\label{lemma:binomial-bounds}
Let $p_1,\ldots, p_n\in [0,1]$. For every $i\in \br{n}$, let $X_i\sim Bernouli(p_i)$, and set $X=\sum_{i=1}^nX_i$. Then,
\begin{enumerate}
    \item For every $b > 0$, 
    \[
        \Pr(X > b\mathbb{E}[X]) \le \left(\frac{e}{b}\right)^{b\mathbb{E}[X]}.
    \]
    \item For any $\delta\ge 0$,
    \[
        \Pr\left(X\ge (1+\delta)\mathbb{E}[X]\right)\le e^{-\frac{\delta^2\mathbb{E}[X]}{2+\delta}}.
    \]
    \item For any $0\le t \le \mathbb{E}[X]$,
    \[
        \Pr\left(X\le \mathbb{E}[X]-t\right)\le e^{-\frac{t^2}{3\mathbb{E}[X]}}.
    \]
\end{enumerate}
\end{lemma}

We also require the following bound on the lower tail of the Binomial distribution.
\begin{lemma}\label{l: binom lower tail}
For every $\xi>0$ there exists $\delta_0>0$ such that for every $\delta\le \delta_0$ the following holds. Let $t\coloneqq t(\xi,\delta)>0$ be sufficiently large. Suppose that $np\ge (1+\xi)t$ and $p\le \frac{1}{2}$. Then,
\begin{align*}
    \mathbb{P}\left(\text{Bin}\left(n,p\right)\le \delta t\right)\le e^{-(1+2\xi/3)t}.
\end{align*}
\end{lemma}
\begin{proof}\textcolor{red}{TOPROVE 0}\end{proof}



We will also make extensive use of the algorithmic version of the Lov\'asz Local Lemma, due to Moser and Tardos \cite{MT10}. 
\begin{theorem}[Theorem 1.2 of \cite{MT10}, rephrased]\label{th: LLL}
Let $U$ be a finite set. Let $X=(\xi_u)_{u\in U}$ be a tuple of mutually independent random variables. Let $\mathcal{F}$ be a finite set of events determined by $X$. Suppose that there exists $q$ such that for every event $F\in \mathcal{F}$, $\mathbb{P}_X(F)\le q$. Moreover, suppose that every $F\in \mathcal{F}$ depends on at most $\Delta$ other events $F'\in \mathcal{F}$. Suppose that $\beta\in (0,1)$ satisfies $q\le \beta(1-\beta)^{\Delta}$. Then, there exists an evaluation of $X$ which does not satisfy any event in $\mathcal{F}$. 

Furthermore, let $(X_n)_{n\in \mathbb{N}}$ be a sequence of mutually independent copies of $X$, that is, for every $n\in \mathbb{N}$, $X_n\sim X$. Initially, we sample $X_0$ and let $Z_0\coloneqq X_0$. At step $t\ge 1$, we pick one $F\in \mathcal{F}$ satisfied by $Z_{t-1}$  (if one exists) in an arbitrary manner. Then, we consider all $u\in U$ such that this witness $F$ depends on the $u$-th coordinate of $Z_{t-1}$, and set $(Z_t)_u=(X_t)_u$ for all such $u$ and $(Z_t)_u=(Z_{t-1})_u$ for all other $u$. If no such $F \in \mathcal{F}$ exists, the process halts and we set $\tau\coloneqq t$. Then, $\mathbb{E}\left[\tau\right]\le |\mathcal{F}|\frac{\beta}{1-\beta}$.
\end{theorem}

In fact, we will utilise the following corollary.
\begin{corollary}\label{cor: lll}
Let $U$ be a finite set. Let $m\in \mathbb{N}$. Let $X=(\xi_u)_{u\in U}$ be a set of mutually independent random variables, supported on $\br{m}$. Let $S_1,\ldots, S_{m}$ be a partition of $U$ satisfying $S_i=\{u\in U\colon \xi_u=i\}$ for every $i \in \br{m}$. Let $\mathcal{F}$ be a finite set of events determined by $S_1,\ldots, S_m$. Suppose that there exists $q$ such that $\mathbb{P}_X(F)\le q$ for every event $F\in \mathcal{F}$. Moreover, suppose that every $F\in \mathcal{F}$ is determined by at most $\Delta_1$ random variables $\xi_u$, and depends on at most $\Delta_2$ other events $F'\in \mathcal{F}$. Furthermore, suppose that $\beta\in (0,1)$ satisfies that $q\le \beta(1-\beta)^{\Delta_2}$. 
Then, the probability (under the measure of $X$) that there exists a partition of $U$ into $U_1,\ldots, U_m$ which does not satisfy any event in $\mathcal{F}$ and $\big|S_i\triangle U_i\big|\le 2\Delta_1|\mathcal{F}|\frac{\beta}{1-\beta}$ for every $i\in \br{m}$, is at least $\frac{1}{2}$.
\end{corollary}
\begin{proof}\textcolor{red}{TOPROVE 1}\end{proof}

Finally, let us conclude this section with a few statements on the distribution of edges in random graphs which are uniformly chosen among all graphs with a given degree sequence.
\begin{theorem}[Corollary 8 in \cite{gao2023subgraph}]\label{th:gao}
    Given a degree sequence $\mathbf{d} = (d_1, \dots, d_n)$ such that $d_1 \ge d_2 \ge \dots \ge d_n$, let $G$ be a uniform random graph on vertex set $\br{n}$ where vertex $i$ has degree $d_i$. Set $M \coloneqq \sum_{i=1}^{n} d_i$. If an integer $1 \le \ell \le M/2$ satisfies $\sum_{i=1}^{d_1} d_i = o(M - 2\ell)$, then, for every $S_1, S_2 \subseteq V(G)$,
    \[
        \mathbb{P}\left(e(S_1, S_2) \ge \ell\right) \le \binom{d(S_1)}{\ell} \cdot \frac{(d(S_2))_\ell}{(M/2)_\ell (2 + o(1))^\ell} = \binom{d(S_1)}{\ell} \cdot \frac{\binom{d(S_2)}{\ell}}{\binom{M/2}{\ell} (2 + o(1))^\ell}\,.
    \]
\end{theorem}
We will also use the following corollary.
\begin{corollary}\label{cor: gao}
Under the same setting as in the statement of Theorem \ref{th:gao}, if $d(S_2)\le M/2$, we further have
    \begin{align*}
        \mathbb{P}\left(e(S_1, S_2) \ge \ell\right) &\le \binom{d(S_1)}{\ell} \cdot \left(\frac{d(S_2)}{M (1 + o(1))}\right)^\ell.
    \end{align*}. 
\end{corollary}
\begin{proof}\textcolor{red}{TOPROVE 2}\end{proof}

We will further utilise the following lemma.
\begin{lemma}\label{lemma:Gao-usage}
    There exists a sufficiently small constant $\xi>0$ such that the following holds. Given a degree sequence $\mathbf{d} = (d_1, \dots, d_n)$ such that $d_1 \ge d_2 \ge \dots \ge d_n$, let $G$ be a uniform random graph on vertex set $\br{n}$ where vertex $i$ has degree $d_i$. Set $M \coloneqq \sum_{i=1}^{n} d_i$. For every $t\in \br{n}$ and every two disjoint sets $A$ and $B$ satisfying
    \[
        M \ge 8(1-3\xi)t, \quad d(A), d(B) \le 2(1+2\xi)t, \quad \text{and} \quad d_1=o\left(\sqrt{t}\right),
    \]
    we have
    \[
        \Pr\left(e(A, B) \ge (1-2\xi)t\right) \le 0.95^{t}.
    \]
\end{lemma}
\begin{proof}\textcolor{red}{TOPROVE 3}\end{proof}

\section{Planting the seeds}\label{s: proposition}
As mentioned in Section \ref{s: outline}, the proof of Theorem \ref{th: main} consists of two main steps. In order to find a $T$-factor in $G(n, d)$, we will partition the vertices of $G(n, d)$ into $|V(T)|$ sets of the same size, each set represents a different vertex in the tree $T$, and find a perfect matching between the $i$-th set and the $j$-th set for every $\{i, j\} \in E(T)$. In this section, we find a partition of the vertices into $|V(T)|$ sets which satisfies two crucial properties, which in turn will allow us to find the desired perfect matchings in the second step in Section \ref{s: theorems proof}.


For every pair of integers $d$ and $n$, let $\mathcal{G}_d$ be the family of all $d$-regular graphs on $n$ vertices, such that there are no two cycles of length at most $10$ at distance less than $10$ from each other. Recall that we treat $d$ as fixed, and consider the asymptotic as $n\to\infty$. Note that \textbf{whp} $G(n,d)\in \mathcal{G}_d$ (see, for example, \cite{W99}). 

The main result of this section, which is the first step in the proof of Theorem \ref{th: main}, is the following.
\begin{proposition}\label{prop: main path}
For every $\epsilon > 0$, there exist a sufficiently small constant $\delta\coloneqq \delta(\epsilon)>0$, a sufficiently large constant $C\coloneqq C(\epsilon)>0$, and a sufficiently large integer $d_0$ such that the following holds for any $d\ge d_0$. 

Let $T$ be a tree on $k \le (1-\epsilon) \frac{d}{\log d}$ vertices. Let $G\in \mathcal{G}_d$ and suppose that $n$ is divisible by $k$. Let $S_1,\ldots, S_k$ be a uniformly random partition of $V(G)$: $\mathbb{P}\left(v\in S_i\right)= \frac{1}{k}$ for every $i\in \br{k}$, $v\in V(G)$ and the random choice of $i\in\br{k}$ for $v\in V(G)$ is performed independently of all the other vertices.

Then, with probability bounded away from zero, there are disjoint sets $V_1,\ldots, V_k\subseteq V(G)$, each of size $\frac{n}{k}$, with the following properties.
\begin{enumerate}[(P\arabic*{})]
    \item $|S_i\triangle V_i|=o_d(n/k)$ for every $i\in \br{k}$. \label{p: close to uniform}
    \item $d(v,V_j)\in \left[\frac{\delta d}{k},\frac{Cd}{k}\right]$ for every $\{i, j\} \in E(T)$ and $v \in V_i$. \label{p: good degree between}
\end{enumerate}
\end{proposition}

The proof of Proposition \ref{prop: main path} is composed of five steps. Let us present here the overview of the proof and the organisation of this section.

In the first step of the proof of Proposition \ref{prop: main path}, appearing in Section \ref{s: high deg}, we take care of the sets $V_i$ under construction which correspond to vertices of high degree in $T$.

In the second step of the proof of Proposition \ref{prop: main path}, appearing in Section \ref{s: low degree}, we construct the remaining sets in the partition of $V(G)$ (that is, the sets corresponding to vertices of low degree in $T$). After this step, for every $\{i, j\} \in E(T)$, we will no longer have vertices in the $i$-th set in the partition whose degree into the $j$-th set is greater than $Cd/k$. However, we may still have a small amount of vertices with degree less than $\delta d/k$. In the third step of the proof of Proposition \ref{prop: main path}, appearing in Section \ref{s: bad vertices}, we get rid of all such vertices. Lastly, in the final step of the proof of Proposition \ref{prop: main path}, appearing in Section \ref{s: equal size}, we will balance the sets of the partition to be of size exactly $n/k$ while we ensure that the requested properties are kept. 

As discussed in Section \ref{s: outline}, the proof is much simpler whenever one assumes $k \le \frac{d}{10\log d}$. Indeed, then some of the above steps may be skipped. In Sections~\ref{s: high deg} through \ref{s: equal size}, we focus on the case where $k \ge \frac{d}{10 \log d}$. In Section \ref{s: small prop}, we provide a proof for the smaller values of $k$.

In Sections~\ref{s: high deg} through \ref{s: equal size}, we let $T$ be a tree on $\br{k}$, and (unless explicitly stated otherwise) we assume that $k\ge \frac{d}{10\log d}$. 

\subsection{Vertices of high degree in the tree}\label{s: high deg} 
In this section, we build the sets in the partition of $V(G)$ that correspond to vertices of high degree in the tree. Let $\beta\coloneqq \beta(\epsilon) > 0$ be a sufficiently small constant. Denote by $H_{deg}(T)$ the set of vertices of $T$ whose degree is at least $d^{1-\beta}$, and let $h\coloneqq |H_{deg}(T)|$, noting that $h < d^{\beta}$, since $k=|V(T)|<d$. Assume WLOG that $\br{h} \subseteq V(T) = \br{k}$ is exactly the set $H_{deg}(T)$. We construct the first $h$ sets of the partition, ensuring that every $v\in V(G)$ will have degree between $\delta d/k$ and $Cd/k$ into each one of these sets.

A key tool here is the algorithmic version of the Lov\'asz Local Lemma. We build the first $h$ sets in two rounds. First, we construct random $h$ sets by assigning each vertex into each one of them with probability $(1-\alpha)/k$ for a suitable choice of $\alpha$. After this sample, \textbf{whp} we will not have vertices with degree larger than $C d/k$ into any of the sets. However, we will have a small amount of vertices of degree smaller than $\delta d / k$ into some of the sets. We denote this set of vertices by $B$. In the next round, we will resample the neighbourhood of $B$ outside of the first $h$ sets in the partition, and put each vertex into each one of the first $h$ sets with an appropriate probability, ensuring the expected size of the sets is $n/k$. As we will see, this probability will be at least $900/k$. This, in turn, will allow us to get rid of vertices with less than $\delta d/k$ neighbours into any of the first $h$ sets in the partition.

The next lemma determines the value of $\alpha$ which should be considered.
\begin{lemma}\label{l:alpha-choice}
There exists $c \in [\epsilon/4, 5]$ such that $\alpha = d^{-c}$ satisfies
\[
        \mathbb{P}\left(\text{Bin}\left(d, \frac{1 - \alpha}{k}\right) \le \delta \log d\right) = \frac{\alpha^2}{d\cdot h}.
\]
\end{lemma}
In relation to Theorem \ref{cor: running time}, we note that for the proof to follow, it is sufficient to $n^{-3}$-approximate $\alpha$. As we know that $c\in [\epsilon/4,5]$, the bisection method   (see, for example, \cite{BF93}) gives us an algorithm of finding an $n^{-3}$-approximation of $\alpha$ within $O_{\epsilon}(\log n)$ steps.  
\begin{proof}\textcolor{red}{TOPROVE 4}\end{proof}

Throughout the rest of the section, we let $\alpha$ be as in the statement of Lemma \ref{l:alpha-choice}. For every vertex $v \in V(G)$, define the random variable $X_v$ with the following distribution.
\begin{align*}
    \Pr(X_v = i) = \begin{cases}
        \frac{1 - \alpha}{k}, \quad & i \in \br{h} \\
        1-\frac{(1-\alpha)h}{k}, \quad & i = 0.
    \end{cases}
\end{align*}
For every $i \in \br{h}$, let $S_i \coloneqq \{v\in V(G)\colon X_v=i\}$. For every vertex disjoint sets $U_1,\ldots, U_h$, let 
\begin{align*}
    B(U_1,\ldots, U_h)&\coloneqq \left\{v\in V(G)\colon \exists i\in \br{h}, d(v, U_i)\le \delta\log d\right\},\\
    W(U_1,\ldots, U_h)&\coloneqq \left\{v\in V(G)\colon \exists i \in \br{h}, d(v,U_i)\ge C\log d\right\}.
\end{align*}
Set $B_1\coloneqq B(S_1,\ldots, S_h)$ and $W_1\coloneqq W(S_1,\ldots, S_h)$.

Let us first estimate several probabilities that will be useful for us in the proof. 
\begin{lemma}\label{l: probabilities of b1 and w1}
For every $v\in V(G)$, we have the following.
\begin{enumerate}
    \item $\mathbb{P}\left(v\in W_1\right)\le d^{-100}$.
    \item $\mathbb{P}\left(v\in B_1\right)\le \frac{\alpha^2}{d}$.
    \item $\mathbb{P}\left(v\in N(B_1)\setminus \bigcup_{i\in \br{h}}S_i\right)\le 2\left(1-\frac{h(1-\alpha)}{k}\right)\alpha^2$.
\end{enumerate}
\end{lemma}
\begin{proof}\textcolor{red}{TOPROVE 5}\end{proof}


We are now ready for the first (out of several) key step in the proof.
\begin{lemma}\label{l: first LLL large degree}
With probability at least $\frac{1}{2}-o(1)$, there exist disjoint sets $A_1^{(1)},\ldots, A_h^{(1)}\subseteq V(G)$ which satisfy the following. Let $B_2=B\left(A_1^{(1)},\ldots, A_h^{(1)}\right)$ and let $W_2=W\left(A_1^{(1)},\ldots, A_h^{(1)}\right)$. Then,
\begin{enumerate}
    \item $\left|S_i\triangle A_i^{(1)}\right|\le \frac{n}{d^{50}}$ and $\left||A_i^{(1)}|-\frac{(1-\alpha)n}{k}\right|\le \frac{n}{d^{50}}$ for every $i\in \br{h}$.
    \item $W_2=\varnothing$.
    \item $\left|N(B_2)\setminus\bigcup_{i\in \br{h}} A_i^{(1)}\right|\le 3\alpha^2n.$
\end{enumerate}
\end{lemma}
\begin{proof}\textcolor{red}{TOPROVE 6}\end{proof}

Recall that, in order to prove Proposition \ref{prop: main path}, we need to show that the sets $V_1,\ldots, V_k$ exist with positive probability (bounded away from zero). We will actually prove that such sets exist with probability $1/4-o(1)$. In particular, by Lemma \ref{l: first LLL large degree}, the sets $A_1^{(1)},\ldots, A_h^{(1)}$ (satisfying the statement of the lemma) exist with probability $1/2-o(1)$. For every possible tuple of disjoint sets $(S_1,\ldots,S_h)$, if there exists a tuple of sets $(A_1^{(1)},\ldots,A_h^{(1)})$, satisfying the conclusion of Lemma~\ref{l: first LLL large degree}, we fix such a tuple. Otherwise, we let $A_i^{(1)}=S_i$ for all $i\in \br{h}$. Further in this section, we assume that the event from Lemma~\ref{l: first LLL large degree}, that has probability at least $1/2-o(1)$, actually occurs; we call the tuple $(S_1,\ldots,S_h)$ \emph{nice} in this case.
Note that, under this assumption, the sets $A_i^{(1)}$ satisfy that no vertex has more than $C\log d$ neighbours in each one of them.

We turn to show that with probability bounded away from zero, there exist sets $A_1^{(2)},\ldots,A_h^{(2)}$ that are `not far' from $S_1,\ldots, S_h$, and every vertex has between $\delta\log d$ and $2C\log d$ neighbours in each one of $A_1^{(2)},\ldots, A_h^{(2)}$. Let $U$ be a set of size $\frac{\alpha n}{1000}$ which contains $N(B_2)\setminus \bigcup_{i\in \br{h}}A_i^{(1)}$ (note that by Lemma \ref{l: first LLL large degree}, $\left|N(B_2)\setminus \bigcup_{i\in \br{h}}A_i^{(1)}\right|\le 3\alpha^2n<\frac{\alpha n}{1000}$). We will make use of the following lemma.
\begin{lemma}\label{l: sprinkling probability}
There exist $\frac{900}{k}\le p_1,\ldots, p_h\le \frac{1100}{k}$ such that, for every $i\in \br{h}$, 
\begin{align*}
    |A_i^{(1)}|+p_i|U|=\frac{n}{k}.
\end{align*}
\end{lemma}
\begin{proof}\textcolor{red}{TOPROVE 7}\end{proof}

Let $p_1,\ldots, p_h$ be the probabilities from the statement of Lemma \ref{l: sprinkling probability}. Let us note that $\sum_{i\in \br{h}}p_i\le \frac{1100h}{k}<1$, since $h< d^\beta$ and $k\ge \frac{d}{10\log d}$. Further, for every $v\in U$ we define a random variable $X_v$ such that $\mathbb{P}\left(X_v=i\right)=p_i$ for every $i\in \br{h}$. Moreover, for every $i\in \br{h}$, we set $U_i\coloneqq\left\{v\in U\colon X_v=i\right\}$, and let $\tilde{A}_i^{(1)}\coloneqq A_i^{(1)}\cup U_i$. Let $W_3$ be the set of vertices $v\in V(G)$ such that there exists $i\in \br{h}$ for which $d(v,\tilde{A}_i^{(1)})\notin (\delta\log d, 2C\log d)$. 

Let us first bound the probability that $v\in W_3$. Recall that we have already conditioned on the existence of the sets $A_1^{(1)}, \ldots, A_h^{(1)}$ satisfying the properties as in the statement of Lemma~\ref{l: first LLL large degree}. Further, note that the probability measure in the following lemma is induced by the random variables $\{X_v\}_{v \in U}$ given in the previous paragraph.
\begin{lemma}\label{l: W_2 probability}
$\mathbb{P}\left(v\in W_3\right)\le \frac{1}{d^{100}}$ for every $v\in V(G)$.
\end{lemma}
\begin{proof}\textcolor{red}{TOPROVE 8}\end{proof}

We can now apply Corollary \ref{cor: lll} and obtain the required sets.
\begin{lemma}\label{l: second lll}
With probability at least $1/2-o(1)$, there exist disjoint subsets $A_1^{(2)},\ldots, A_h^{(2)}\subseteq V(G)$ which satisfy the following.
\begin{enumerate}
    \item $\left|S_i\triangle A_i^{(2)}\right|=o_d(n/k)$ for every $i\in \br{h}$.
    \item $\left|A_i^{(2)}-\frac{n}{k}\right|=O(n/d^{50})$ for every $i\in \br{h}$. 
    \item $d(v, A_i^{(2)})\in \left[\delta \log d, 2C\log d\right]$ for every $i\in \br{h}$ and $v\in V(G)$.
\end{enumerate}
\end{lemma}
\begin{proof}\textcolor{red}{TOPROVE 9}\end{proof}

\subsection{Vertices of low degree in the tree}\label{s: low degree}

We have proved that, if $(S_1,\ldots,S_h)$ is nice (this happens with probability at least $1/2-o(1)$), then there exist sets $A_1^{(2)},\ldots, A_h^{(2)}$ satisfying the properties as in the statement of Lemma \ref{l: second lll}.
Throughout this section, we fix a nice tuple $(S_1,\ldots,S_h)$ and a tuple $(A_1^{(2)},\ldots,A_h^{(2)})$, satisfying the conclusion of Lemma \ref{l: second lll}.




Recall that the sets $A_1^{(2)},\ldots, A_h^{(2)}$ correspond to the high-degree vertices in $T$, and every vertex has between $\delta\log d$ and $2C\log d$ neighbours in each of these sets. As described in the beginning of Section \ref{s: proposition}, in this section we aim to establish similar sets for low-degree vertices.

Let 
\begin{equation}
    U\coloneqq V(G)\setminus \bigcup_{i \in \br{h}} A_i^{(2)}.
    \label{eq:U-def}
\end{equation}
    Note that, by Lemma \ref{l: second lll},
\begin{align}
  |U|&\in \left[n-h\cdot\left(\frac{n}{k}+O\left(\frac{n}{d^{50}}\right)\right), n-h\cdot\left(\frac{n}{k}-O\left(\frac{n}{d^{50}}\right)\right)\right]\nonumber\\
  &=\left[\left(1-\frac{h}{k}-O(d^{-49})\right)n, \left(1-\frac{h}{k}+O(d^{-49})\right)n\right]. \label{eq: size y}
\end{align}
For every $v \in U$, let $X_v$ be the random variable such that $\mathbb{P}\left(X_v=i\right)=\frac{1}{k-h}$, for every index $i\in\{h+1,\ldots,k\}$. All $X_v$ are independent. For every $i\in\{h+1,\ldots,k\}$, set 
\[
    S_i \coloneqq \{v \in U \colon X_v = i\}.
\]
For convenience, let us also set $A_i^{(2)}\coloneqq S_i$ for every $i\in \{h+1,\ldots,k\}$ (recall that $A_i^{(2)}$ is already defined for every $i\in \br{h}$).


Given a partition $U_1,\ldots, U_k$ of $V(G)$, let $B(U_1,\ldots, U_k)$ be the set of vertices $v\in V(G)$ satisfying the following. There exist $i\in \br{k}$ and $j\in \{h+1,\ldots, k\}$ such that $\{i,j\}\in E(T), v\in U_i$ and $d(v,U_j)\le \delta \log d$. Further, let $W(U_1,\ldots, U_k)$ be the set of vertices $v\in V(G)$ that satisfy at least one of the following.
\begin{enumerate}
    \item There exists $i \in \br{k}$ such that $d(v, U_i )\ge 2C \log d$.
    \item There exist more than $1 / \epsilon^2$ indices $i \in \{h+1,\ldots,k\}$ such that $d(v, U_i) < \delta \log d$.
    \item There exists $i \in \br{k}$ such that $d\left(v, U_i \cap B(U_1,\ldots,U_k)\right) > \log \log d$.    
\end{enumerate}
Set $B_4\coloneqq B(A_1^{(2)},\ldots, A_k^{(2)})$ and $W_4\coloneqq W(A_1^{(2)},\ldots, A_k^{(2)})$.

Let us first show that it is quite unlikely for a vertex to be in $W_4$.
\begin{lemma}\label{l: prob w0}
    $\Pr(v \in W_4) \le d^{-100}$ for every vertex $v \in V(G)$.
\end{lemma}
\begin{proof}\textcolor{red}{TOPROVE 10}\end{proof}

We also require the following lemma.
\begin{lemma}\label{l: typical tilde a}
\textbf{Whp} the following holds.
    \begin{enumerate}
        \item $|B_4| \le n d^{-(1 + \epsilon/4)}$.
        \item For every $i\in \br{k}$, we have $\left||A_{i}^{(2)}|-\frac{n}{k}\right|=O(n/d^{49})$.
        \item For every $i\in \br{k}$, there are at least $\frac{n}{3k}$ vertices $v\in A_i^{(2)}$ such that for every $j\in \br{k}$, $d(v,A_j^{(2)})\ge \delta\log d$.  
    \end{enumerate}
\end{lemma}
\begin{proof}\textcolor{red}{TOPROVE 11}\end{proof}

We now turn to use Corollary \ref{cor: lll} to show that there exists a `good' partition $A_1^{(3)},\ldots, A_k^{(3)}$, which is not far from $S_1,\ldots, S_k$.
\begin{lemma}\label{l: third lll}
With probability at least $1/2-o(1)$, there exists a partition of $V(G)$ into $A_1^{(3)},\ldots, A_k^{(3)}$ which satisfies the following. Let 
$$
B_5=B\left(A_1^{(3)},\ldots, A_k^{(3)}\right)
\quad\text{ and }\quad
W_5=W\left(A_1^{(3)},\ldots, A_k^{(3)}\right).
$$
Then,
\begin{enumerate}
    \item $\left|A_i^{(3)}\triangle S_i\right|=o_d(n/k)$ for every $i\in \br{k}$.\label{l: item third lll}
    \item $\left||A_i^{(3)}|-\frac{n}{k}\right|=O(n/d^{49})$ for every $i\in \br{k}$.
    \item $W_5=\varnothing$.
    \item $|B_5|\le nd^{-1-\epsilon/5}$.
    \item For every $i\in \br{k}$, there are at least $\frac{n}{4k}$ vertices $v \in A_i^{(3)}$ which satisfy that for every $j\in \br{k}$, $d(v,A_j^{(3)})\ge \delta\log d$. 
    \item $d(v, A_i^{(3)})\in \left[\delta \log d, 2C\log d\right]$ for every $i\in \br{h}$ and $v\in V(G)$.
\end{enumerate}
\end{lemma}
\begin{proof}\textcolor{red}{TOPROVE 12}\end{proof}

\subsection{Eliminating bad vertices}\label{s: bad vertices}

We now say that a tuple $(S_1,\ldots,S_k)$ is \emph{nice} if $(S_1,\ldots,S_h)$ is nice and there exist sets $A_i^{(3)}$, $i\in \br{k}$, satisfying the conclusion of Lemma~\ref{l: third lll}. Due to Lemmas~\ref{l: first LLL large degree} and~\ref{l: third lll}, with probability at least $1/4-o(1)$, the considered random tuple of sets $(S_1,\ldots,S_k)$ is nice. As in the previous section, for every nice tuple $(S_1,\ldots,S_k)$, we fix the corresponding sets $A_i^{(3)}$, $i\in \br{k}$, satisfying the conclusion of Lemma~\ref{l: third lll}. If $(S_1,\ldots,S_k)$ is not nice, then we simply set $A_i^{(3)}=S_i$ for all $i\in \br{k}$.


Further in this section, we assume that the event from Lemma~\ref{l: third lll} (that has probability at least $1/4-o(1)$ due to Lemma~\ref{l: first LLL large degree}), actually occurs; i.e. the tuple $(S_1,\ldots,S_k)$ is \emph{nice}. We recall that $A_1^{(3)},\ldots, A_k^{(3)}$ satisfy that for every vertex $v \in V(G)$ and an index $i \in \br{h}$, we have $d(v, A_i^{(3)}) \in [\delta \log d, 2C \log d]$. Further, for every vertex $v \in V(G)$ and an index $i\in \br{k}$, we have $d(v, A_i^{(3)}) \le 2C \log d$. We now show that after several resamples, we may obtain sets $A_1^{(4)}, \ldots, A_k^{(4)}$ such that for every $\{i, j\} \in E(T)$ and for every $v \in A_i^{(4)}$, the number of neighbours of $v$ in $A_j^{(4)}$ is concentrated around its expectation. More precisely, 
\begin{lemma}\label{l: no b}
There exist sets $A_1^{(4)}, \dots, A_k^{(4)}$ such that the following holds:
    \begin{enumerate}
        \item $\left|A_i^{(4)}\triangle A_i^{(3)}\right|\le nd^{-1-\epsilon/5}$ for every $i\in \br{k}$.\label{l: no b item}
        \item $d(v, A_j^{(4)}) > \frac{\delta \log d}{2}$ for every $\{i,j\} \in E(T)$ and for every $v \in A_i^{(4)}$.
        \item $d(v, A_j^{(4)}) < 3C \log d$ for every vertex $v \in V(G)$ and every $j \in \br{k}$.
        \item For every $i\in \br{k}$, there are at least $\frac{n}{5k}$ vertices $v\in A_i^{(4)}$ which satisfy that for every $j\in \br{k}$, $d(v,A_j^{(4)})\ge \frac{\delta\log d}{2}$. 
    \end{enumerate}
\end{lemma}
\begin{proof}\textcolor{red}{TOPROVE 13}\end{proof}

\subsection{Balancing the sets}\label{s: equal size} 

We have proved that, if $(S_1,\ldots,S_k)$ is nice (this happens with probability at least $1/4-o(1)$), then there exist sets $A_1^{(4)},\ldots, A_k^{(4)}$ satisfying the properties as in the statement of Lemma \ref{l: no b}.
Throughout this section, we fix a nice tuple $(S_1,\ldots,S_k)$ and a tuple $(A_1^{(4)},\ldots,A_k^{(4)})$, satisfying the conclusion of Lemma \ref{l: no b}.


Recall that the sets $A_1^{(4)},\ldots, A_k^{(4)}$ have good degree distribution in between them, yet their size could be up to $nd^{-1-\epsilon/5}$-far from $n/k$. We now turn to show that there exist sets $A_1^{(5)},\ldots, A_k^{(5)}$, all `close' to $A_1^{(4)},\ldots, A_k^{(4)}$, and all of size $\frac{n}{k}\pm O(nd^{-50})$, which still satisfy the `good degrees' assumption. This will, in turn, allow us to complete the balancing of the sets deterministically, and obtain sets of size exactly $\frac{n}{k}$ which satisfy the `good degrees' assumption. 

To that end, let us reorder the sets such that $A_1^{(4)},\ldots, A_m^{(4)}$ are of size at least $\frac{n}{k}$, and $A_{m+1}^{(4)},\ldots,A_k^{(4)}$ are of size less than $\frac{n}{k}$, for some $m\in \br{k}$. Further, for every $i\in \br{k}$, let $\Delta_i=\left||A_i^{(4)}|-\frac{n}{k}\right|$, noting that by the first item in Lemma \ref{l: no b} and by the second item in Lemma~\ref{l: third lll}, 
\begin{equation}
\Delta_i\le nd^{-1-\epsilon/6}.
\label{eq:Delta_i_upper_bound}
\end{equation} 
We have that for every $i\in \br{k}$, there are at least $\frac{n}{5k}$ vertices $v\in A_i^{(4)}$ such that $d(v,A_j^{(4)})\in \left[\frac{\delta\log d}{2}, 3C\log d\right]$ for every $j\in \br{k}$. For every $i\in \br{m}$, let $Q_i\subseteq A_i(4)$ be a set of exactly $\frac{n}{5k}$ such vertices, and set $Q\coloneqq\bigcup_{i\in \br{m}}Q_i$. 

For every $i \in \br{m}$ and $v \in Q_i$, set $M_v \sim \text{Bernoulli}(p_i)$ where $p_i = \frac{\Delta_i}{n/5k}$. This Bernoulli random variable represents whether the vertex $v$ is moved to the $j$-th set, for some $j \in \{m+1,\ldots, k\}$, or not. In addition, let $Z_v$ be the random variable over the set $\{m+1,\ldots,k\}$ defined by $\Pr(Z_v = j) = \frac{\Delta_j}{\Delta_1 + \ldots  + \Delta_m}$ for every $j \in \{m+1,\ldots, k\}$. Note that $\sum_{j\in\{m+1,\ldots,k\}}\Pr(Z_v=j)=1$ since $\Delta_1+\ldots +  \Delta_m=\Delta_{m+1}+\ldots+\Delta_k$. The random variable $Z_v$ represents the index $j \in \{m+1,\ldots,k\}$ for which the vertex $v$ may move (it will indeed move to $A_j^{(4)}$ if and only if $M_v=1$). We stress that for every $v\in Q$, $M_v$ and $Z_v$ are independent, and are also independent over different $v$. Let
\begin{align*}
    \tilde{A}_i^{(4)} \coloneqq \begin{cases}
        A_i^{(4)} \setminus \{v \in Q_i \colon M_v = 1\}, \quad i \in \br{m} \\
        A_i^{(4)} \cup \{v \in Q \colon M_v = 1 \text{ and } Z_v = i\}, \quad i \in \{m+1,\ldots,k\}.
    \end{cases}
\end{align*}
Note that by the above construction, if $A_i^{(4)}$ is of size smaller than $\frac{n}{k}$, then we may only move vertices into it, whereas when $A_i^{(4)}$ is of size larger than $\frac{n}{k}$ we may only move vertices outside of it. Further, if the set $A_i^{(4)}$ is of size exactly $\frac{n}{k}$, then $\Delta_i=0$, and thus the set will remain unchanged.

We first show some typical properties of the sets $\Tilde{A}_1^{(4)},\ldots, \Tilde{A}_k^{(4)}$, noting that the probability measure here is induced by the random variables $M_v$ and $Z_v$.
\begin{lemma}\label{l: typical aht properties}
\textbf{Whp}, the sets $\tilde{A}_1^{(4)},\ldots, \tilde{A}_k^{(4)}$ satisfy the following for every $i\in \br{k}$.
\begin{enumerate}
    \item $\left|\tilde{A}_i^{(4)}\triangle A_i^{(4)}\right|=o_d(n/k)$.
    \item $\left||\tilde{A}_i^{(4)}|-\frac{n}{k}\right|\le n^{2/3}$.
\end{enumerate}
\end{lemma}
\begin{proof}\textcolor{red}{TOPROVE 14}\end{proof}


Let $\hat{B}$ be the set of vertices $v\in V(G)$ satisfying at least one of the following.
\begin{itemize}
    \item That there exists $\{i,j\}\in E(T)$ such that $v\in \tilde{A}_i^{(4)}$ and $d(v,\tilde{A}_j^{(4)})\notin \left[\frac{\delta\log d}{3}, 4C\log d\right]$.
    \item $v$ satisfies that $d(v,A_i^{(4)})>\delta \log d/2$ for every $i\in \br{k}$. Further, there is some $i\in \br{k}$ such that $d(v,\tilde{A}_i^{(4)})\le \delta\log d/3$.
\end{itemize} 
\begin{lemma}\label{l: hat B}
For every $v\in V(G)$, $\mathbb{P}\left(v\in \hat{B}\right)\le d^{-100}$.
\end{lemma}
\begin{proof}\textcolor{red}{TOPROVE 15}\end{proof}

We are now ready to apply Corollary \ref{cor: lll}.
\begin{lemma}\label{l: final lll}
With probability at least $\frac{1}{2}-o(1)$ (in the product measure induced by $M_v$ and $Z_v$, $v\in Q$), there exist disjoint sets $A_1^{(5)},\ldots, A_k^{(5)}$ such that the following holds.
\begin{enumerate}
    \item For every $\{i,j\}\in E(T)$ and for every $v\in A_i^{(5)}$, we have that $d(v,A_j^{(5)})\in \left[\frac{\delta\log d}{3},4C\log d\right]$.
    \item For every $i\in \br{k}$, we have $\left|A_i^{(5)}\triangle \tilde{A}_i^{(4)}\right|=O\left(\frac{n}{d^{50}}\right)$.\label{l: final lll item distance}
    \item For every $i\in \br{k}$, there are at least $\frac{n}{6k}$ vertices $v\in A_i^{(5)}$ which satisfy that $d(v,A_j^{(5)})\in \left[\frac{\delta\log d}{3},4C\log d\right]$ for every $j \in \br{k}$. 
\end{enumerate}
\end{lemma}
\begin{proof}\textcolor{red}{TOPROVE 16}\end{proof}
We have just proved that there exist sets $A_1^{(5)},\ldots, A_k^{(5)}$ satisfying the properties as in the statement of Lemma \ref{l: final lll}. We are now ready to complete the proof of Proposition \ref{prop: main path}. To that end, let us first show we can move the vertices between the sets $A_1^{(5)},\ldots, A_k^{(5)}$ to obtain sets $V_1,\ldots,V_k$, each with exactly $\frac{n}{k}$ vertices, while maintaining the degree distribution between the sets.
\begin{lemma}\label{l: final round}
There exists sets $V_1,\ldots,V_k$ such that the following holds.
\begin{enumerate}
    \item For every $\{i,j\}\in E(T)$ and for every $v\in V_i$, we have that $d(v,V_j)\in \left[\frac{\delta\log d}{4},5C\log d\right]$.
    \item $\left|V_i\triangle A_i^{(5)}\right|=o_d(n/k)$ for every $i\in \br{k}$.\label{l: final item distance}
    \item $|V_i|=\frac{n}{k}$ for every $i\in \br{k}$.
\end{enumerate}
\end{lemma}
\begin{proof}\textcolor{red}{TOPROVE 17}\end{proof}

\begin{proof}\textcolor{red}{TOPROVE 18}\end{proof}

\subsection{Small trees}\label{s: small prop}
For small trees we prove a stronger version of Proposition \ref{prop: main path}:
\begin{proposition}\label{prop: main small k}
Let $k\le \frac{d}{10\log d}$. Let $G\in \mathcal{G}_d$, and suppose that $n$ is divisible by $k$. Then, there exists a sufficiently large constant $C\coloneqq C(\epsilon)>0$ and a sufficiently small constant $\delta\coloneqq \delta(\epsilon)>0$ such that the following holds.

Let $S_1,\ldots, S_k$ be a uniformly random partition of $V(G)$: for every $i\in\br{k}$ and for every $v\in V(G)$, the vertex $v$ belongs to $S_i$ with probability $1/k$, independently of all the other vertices. Then, with probability bounded away from zero, there are disjoint sets $V_1,\ldots, V_k\subseteq V(G)$, each of size $\frac{n}{k}$, with the following properties.
\begin{enumerate}[(P\arabic*{})]
    \item $|S_i\triangle V_i|=o_d(n/k)$ for every $i\in \br{k}$. \label{p: close to uniform small}
    \item $d(v,V_i)\in \left[\frac{\delta d}{k},\frac{Cd}{k}\right]$ for every $i\in \br{k}$ and $v\in V(G)$. \label{p: good degree between small}
\end{enumerate}
\end{proposition}
\begin{proof}\textcolor{red}{TOPROVE 19}\end{proof}

\section{Growing the trees}\label{s: theorems proof}
In this section, we show how to construct the tree factor, given the vertex partition guaranteed by Propositions \ref{prop: main path} and \ref{prop: main small k}. 

In Section \ref{subsection:typical-properties}, we collect typical properties of $G(n, d)$ which are important for proving Theorem \ref{th: main}. In Section \ref{subsection:proof-of-main-thm}, we prove Theorem~\ref{th: main}. We do so by applying Proposition \ref{prop: main path} (or its stronger version, Proposition \ref{prop: main small k}, when trees are small) and, using the typical properties we have shown in Section \ref{subsection:typical-properties}, we will find a perfect matching between $V_i$ and $V_j$ for every $\{i,j\} \in E(T)$.

\subsection{Typical Properties of random regular graphs}\label{subsection:typical-properties}
The following claim shows that typically there are not `too many' edges between any two small sets of equal size. 
\begin{claim}\label{claim:global-event-between-small-sets}
    For every $\epsilon, \delta > 0$, there exists $\eta > 0$ such that, for sufficiently large $d$, \textbf{whp} the following holds in $G\sim G(n, d)$. Let $k \le \frac{(1-\epsilon)d}{\log d}$ be an integer. Then, for every two disjoint sets $A,B\subseteq V(G)$ satisfying $|A| = |B| < \eta \cdot \frac{n}{k}$,
    \[
        e(A, B) < |A| \cdot \delta \cdot \frac{d}{k}.
    \]    
\end{claim}
\begin{proof}\textcolor{red}{TOPROVE 20}\end{proof}

Claim \ref{claim:global-event-between-small-sets} is useful in showing Hall's condition between small sets in $V_i$ and $V_j$ (that is, every small set $U \subseteq V_i$ has many neighbours in $V_j$). We would like to bound the neighbourhoods of large sets as well. This is the essence of the next claim.

\begin{claim}\label{claim:typical neighbourhood-S}      
    For every $\epsilon, \eta > 0$, there exist $\epsilon_1, \epsilon_2 > 0$ such that, for sufficiently large $d$, the following holds in $G \sim G(n, d)$. Let $2\le k \le \frac{(1-\epsilon)d}{\log d}$ be an integer and let $S_1,\ldots, S_k$ be a uniformly random partition of $V(G)$. Then, \textbf{whp}, for every $i \neq j \in \br{k}$ and $A \subset S_i$ satisfying  $\eta \frac{n}{k} \le |A| \le 0.5(1 + \epsilon_1)\frac{n}{k}$, we have
    $|N(A, S_j)| \ge (1 + \epsilon_2) |A|$.    
\end{claim}
\begin{proof}\textcolor{red}{TOPROVE 21}\end{proof}

\subsection{Proof of Theorem \ref{th: main}}\label{subsection:proof-of-main-thm}
Let $\epsilon > 0$ be a constant and let $d$ be a sufficiently large integer. Let $T$ be a tree on $k\le \frac{(1-\epsilon)d}{\log d}$ vertices. We will show that \textbf{whp} $G \sim G(n, d)$ contains a $T$-factor. Let $\delta = \delta(\epsilon) > 0$ and $C = C(\epsilon) > 0$ be the constants guaranteed by Proposition \ref{prop: main path}. In addition, let $\eta = \eta(\epsilon, \delta)$ be the constant guaranteed by Claim \ref{claim:global-event-between-small-sets} and let $\epsilon_1 = \epsilon_1(\eta^2,\epsilon)$ and $\epsilon_2 = \epsilon_2(\eta^2,\epsilon)$, be the constants guaranteed by Claim \ref{claim:typical neighbourhood-S}.

Now, let $S_1,\ldots, S_k$ be such that every $v\in V(G)$ is assigned to $S_i$ for an index $i\in \br{k}$ chosen uniformly at random, independently from all the other vertices. Note that \textbf{whp} $G(n,d)\in \mathcal{G}_d$ (see, for example, \cite{W99}) and the statements of Claims \ref{claim:global-event-between-small-sets} and \ref{claim:typical neighbourhood-S}, are satisfied. We then fix a deterministic $G\in \mathcal{G}_d$ that satisfies conclusions of both claims.

Let $\Sigma$ be the set of all partitions of $V(G)$ into $k$ ordered sets. Let $\Sigma'\subset\Sigma$ be the set of all \emph{nice} $(S_1,\ldots,S_k)$, i.e. those that satisfy the conclusion of Proposition~\ref{prop: main path}. Due to Proposition~\ref{prop: main path}, there exists a constant $\gamma>0$ such that $|\Sigma'|/|\Sigma|\geq\gamma$. On the other hand, let $\Sigma''\subset\Sigma$ be the set of all good $(S_1,\ldots,S_k)$, i.e. those that satisfy the conclusion of Claim~\ref{claim:typical neighbourhood-S}. We know that $|\Sigma''|/|\Sigma|=1-o(1)$. We immediately get that there exists a tuple $(S_1,\ldots,S_k)$ which is simultaneously nice and good. Since this tuple is nice,
there exist sets $V_1, \dots, V_k$ which satisfy all the desired requirements. Under these assumptions, we will be able to show deterministically that there exists a perfect matching between $V_i$ and $V_j$ for every $\{i,j\} \in E(T)$ which implies the existence of a $T$-factor. One way to show the latter implication is, for example, by induction on $k$. Assume without loss of generality that $k \in V(T)$ is a leaf and that, by induction assumption, we have a $T'$-factor in $\cup_{i=1}^{k-1} V_i$ where $T' = T \setminus \{k\}$. We may then complete $T'$ to a $T$-factor via the perfect matching between $V_k$ and $V_i$ where $i$ is the only neighbour of $k$ in $T$.

Fix $\{i,j\} \in E(T)$. We will show that Hall's condition is satisfied between $V_i$ and $V_j$ in $G$. Let $W \subseteq V_i$. We will prove that $|N(W, V_j)| \ge |W|$. By Proposition \ref{prop: main path}, for every $v \in V_i$, we have $d(v, V_j) \in \left[\delta \cdot \frac{d}{k}, C \cdot \frac{d}{k}\right]$. Hence, 
\begin{align}\label{eq:W-A_j-edges}
    e(W, V_j) \ge |W| \cdot \delta \cdot \frac{d}{k}.
\end{align}
We split the proof into three parts depending on the size of $|W|$.

First of all, we show that if $|W| < \eta \cdot \frac{n}{k}$, then $|N(W, V_j)| > |W|$. Assume towards contradiction that this is false. Then, there exists a set $B \subseteq V_j$ satisfying $N(W, V_j) \subseteq B$ and $|B| = |W|$. By Claim \ref{claim:global-event-between-small-sets}, we have $e(W, B) = e(W, V_j) < |W| \cdot \delta \cdot \frac{d}{k}$, a contradiction to \eqref{eq:W-A_j-edges}.

Next, assume that $\eta \cdot \frac{n}{k} \le |W| \le 0.5(1 + \epsilon_1) \frac{n}{k}$. We have
\begin{align*}        
    |W \cap S_i| \ge |W| - |V_i \setminus S_i| \ge \eta \cdot \frac{n}{k} - |V_i \setminus S_i| \ge \eta^2 \cdot \frac{n}{k},
\end{align*}
where the last inequality is true since $|V_i \setminus S_i| = o_d(n/k)$ by Proposition \ref{prop: main path}. Thus,
\begin{align*}
    |N_{V_j}(W)| &\ge |N_{S_j}(W \cap S_i) \cap V_j| \ge (1 + \epsilon_2) |W \cap S_i| - |V_j \setminus S_j| \\
    &\ge (1 + \epsilon_2)(|W| - |V_i \setminus S_i|) - |V_j \setminus S_j| > |W|,
\end{align*}
where the second inequality is true by Claim \ref{claim:typical neighbourhood-S} and the last inequality is true since $|V_i \setminus S_i|, |V_j \setminus S_j| = o_d(n/k)$ and $|W| = \Omega(n/k)$.

Finally, assume that $0.5(1 + \epsilon_1) \frac{n}{k} < |W| \le \frac{n}{k}$. Assume towards contradiction that $|N(W, V_j)| < |W|$. Let $B \subseteq V_j \setminus N(W, V_j)$ be an arbitrary set of size $|V_i \setminus W|$. Notice that $N(B, V_i) \subseteq V_i \setminus W$, otherwise there exists $v \in B$ which is adjacent to $u \in W$. This in turn implies that $v \in N(W, V_j)$ and, in particular, $v \notin B$ --- a contradiction. Moreover, 
\[
    |B| = |V_i| - |W| < |V_i| - 0.5(1 + \epsilon_1) \frac{n}{k} = 0.5(1-\epsilon_1) \frac{n}{k}.
\]
Therefore, by the previous argument (with $i$ and $j$ reversed), $|N(B, V_i)| > |B|$. However, since $N(B, V_i) \subseteq V_i \setminus W$, we have $|N(B, V_i)| \le |V_i \setminus W| = |B|$ --- contradiction.



\paragraph{Acknowledgements} The authors thank Itai Benjamini for bringing the question to our attention. The authors wish to thank Michael Krivelevich and Noga Alon for fruitful discussions. In particular, we thank Michael Krivelevich for showing us the alternative argument from~\cite{DK}, after the first version of this paper was uploaded. It allowed us to improve the presentation significantly.


    
\bibliographystyle{abbrv}
\bibliography{sat}

\appendix
\section[d-1-star-factor]{$K_{1,d-1}$-factor}
\label{appendix}
Let us show that, for $d\ge 5$, $G(n,d)$ \textbf{whp} does not contain a $K_{1,d-1}$-factor. Setting $N=nd$, $M=\frac{n}{d}+\frac{n(d-1)^2}{d}=N-2n+2n/d$, we have that the expected number of graphs that correspond to $K_{1,d-1}$-factors in the configuration model (see, for example, ~\cite{Bol_book}) is at most
\begin{align*}
    \frac{\binom{n}{n/d}d^{n/d}(n\frac{d-1}{d})!d^{n(d-1)/d}M!/(2^{M/2}(M/2)!}{N!/(2^{N/2}(N/2)!)}&=\left(\sqrt{d}+o(1)\right)\frac{n^nd^n(M/N)^{M/2}e^{n-n/d}}{(n/d)^{n/d}e^{n(d-1)/d}(nd)^{n-n/d}}\\
    &=\left(\sqrt{d}+o(1)\right)\left(d^{2/d}\left(1-\frac{2}{d}+\frac{2}{d^2}\right)^{d/2-1+1/d}\right)^n\\
    &=o(1).
\end{align*}
Indeed, $g(d)=d^{2/d}\left(1-\frac{2}{d}+\frac{2}{d^2}\right)^{\frac{d}{2}-1+\frac{1}{d}}$ decreases in $d$ on $[5,\infty)$, and $g(5)<1$.
\end{document}