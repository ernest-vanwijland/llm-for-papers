\documentclass[a4paper, UKenglish, cleveref, autoref, thm-restate]{lipics-v2021}

\usepackage{cite}
\usepackage{graphicx}
\usepackage{textcomp}
\usepackage{xcolor}

\usepackage{xspace}
\usepackage{bbm}
\usepackage{comment}
\usepackage{amsmath}
\usepackage{booktabs}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{thmtools,thm-restate}
\usepackage[textsize=small]{todonotes}
\usepackage{tikz}
\usetikzlibrary{arrows,arrows.meta,automata,positioning} 
\usepackage{stmaryrd}
\usepackage{mathdots}
\usepackage{algorithm}
\usepackage[noend]{algpseudocode}
\usepackage{thmtools}
\usepackage{lineno}
\usepackage{enumerate}
\usepackage{apxproof}
\usepackage{hyperref}
\usepackage{url}
\renewcommand{\appendixprelim}{\newpage}

\addtolength{\textwidth}{1cm}
\addtolength{\oddsidemargin}{-0.5cm}
\addtolength{\evensidemargin}{-0.5cm}

\addtolength{\textheight}{0.5cm}
\addtolength{\topmargin}{0.5cm}


\title{Reachability in 3-VASS is Elementary}




\author{Wojciech Czerwi\'nski}
{University of Warsaw}
{wczerwin@mimuw.edu.pl}
{https://orcid.org/0000-0002-6169-868X}
{Supported by the ERC grant INFSYS, agreement no. 950398.}

\author{Isma{\"e}l Jecker}
{FEMTO-ST, CNRS, Univ. Franche-Comté, France}
{ismael.jecker@gmail.com}
{}
{}

\author{Sławomir Lasota}
{University of Warsaw}
{s.lasota@uw.edu.pl}
{https://orcid.org/0000-0001-8674-4470}
{Supported by the ERC grant INFSYS, agreement no. 950398 and by the NCN grant 2021/41/B/ST6/00535.}

\author{Łukasz Orlikowski}
{University of Warsaw}
{l.orlikowski@mimuw.edu.pl}
{https://orcid.org/0009-0001-4727-2068}
{Supported by the ERC grant INFSYS, agreement no. 950398.}


\authorrunning{W. Czerwi{\'n}ski, I. Jecker, S. Lasota, and {\L}. Orlikowski} 
\Copyright{Wojciech Czerwi{\'n}ski, Isma{\"e}l Jecker, S{\l}awomir Lasota, and {\L}ukasz Orlikowski}

\ccsdesc[500]{Theory of computation~Parallel computing models}
\keywords{vector addition systems, Petri nets, reachability problem, dimension three, doubly exponential space, length of shortest path} 



\pagestyle{plain}
\pagenumbering{arabic}

\newcommand{\wojtek}[1]{\todo[color=teal]{W: #1}}
\newcommand{\lukasz}[1]{\todo[color=cyan]{Ł: #1}}

\newcommand{\ignore}[1]{}

\newcommand{\Sandwich}{Polynomially approximable\xspace}
\newcommand{\sandwich}{polynomially approximable\xspace}
\newcommand{\parsandwich}[1]{#1-approximable\xspace}

\newcommand{\C}{\mathcal{C}}
\newcommand{\Oo}{\mathcal{O}}
\newcommand{\D}{\mathbb{D}}
\newcommand{\F}{\mathcal{F}}
\newcommand{\W}{\mathcal{W}}
\newcommand{\A}{\mathcal{A}}
\newcommand{\B}{\mathcal{B}}
\newcommand{\I}{\mathcal{I}}
\renewcommand{\S}{\mathcal{S}}
\newcommand{\M}{\mathcal{M}}
\newcommand{\N}{\mathbb{N}}
\newcommand{\Z}{\mathbb{Z}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\Q}{\mathbb{Q}}
\newcommand{\U}{\mathcal{U}}
\newcommand{\ind}{\mathbbm{1}}
\newcommand{\Qpos}{\Q_{>0}}
\renewcommand{\P}{\mathbb{P}}

\newcommand{\set}[1]{\{#1\}}
\newcommand{\setof}[2]{\set{#1 \mid #2}}
\newcommand{\card}[1]{\left|#1\right|}
\newcommand{\prettyexists}[2]{\exists_{#1} \, #2}
\newcommand{\prettyforall}[2]{\forall_{#1} \, #2}
\newcommand{\source}[1]{\textsc{source}(#1)}
\newcommand{\target}[1]{\textsc{target}(#1)}
\newcommand{\runs}[1]{\textsc{Runs}(#1)}  \newcommand{\runord}{\unlhd}
\newcommand{\fin}{\textup{fin}}
\newcommand{\prof}{\textsc{profile}}
\newcommand{\lab}{\textsc{label}}
\newcommand{\parimage}{\textsc{pi}}
\newcommand{\rsmall}{\textsc{small}}
\newcommand{\rbig}{\textsc{big}}
\newcommand{\reachvas}{\textsc{Reach}(\mathrm{VAS})}
\newcommand{\secreachvas}{\textsc{SecReach}(\mathrm{VAS})}
\newcommand{\reachvass}{\textsc{Reach}(\mathrm{VASS})}
\newcommand{\secreachvass}{\textsc{SecReach}(\mathrm{VASS})}
\newcommand{\reach}{\textsc{Reach}}
\newcommand{\secreach}{\textsc{SecReach}}
\newcommand{\vas}{VAS\xspace}
\newcommand{\vases}{{\vas}es\xspace}
\newcommand{\petrinet}{PN\xspace}
\newcommand{\posit}{\textsc{pos}}
\newcommand{\negat}{\textsc{neg}}
\newcommand{\pre}{\textsc{pre}}
\newcommand{\post}{\textsc{post}}
\renewcommand{\sec}[2]{\textsc{sec}_{#1}(#2)}
\newcommand{\cc}{\textsc{cc}}
\newcommand{\trans}[1]{\stackrel{#1}{\longrightarrow}}
\newcommand{\tran}{\trans{*}}
\newcommand{\Tran}{\Longrightarrow}
\newcommand{\llra}{\longleftrightarrow}

\newcommand{\up}{\textup{up}}
\newcommand{\trg}{\textup{trg}}
\newcommand{\src}{\textup{src}}
\newcommand{\comp}{\textup{comp}}
\newcommand{\depth}{\textup{depth}}
\newcommand{\down}{\textup{down}}
\newcommand{\negative}{\textsc{negative}}
\newcommand{\zero}{\textsc{zero}}
\newcommand{\sml}{\textsc{small}}
\newcommand{\bg}{\textsc{big}}
\newcommand{\slps}{\textsc{slps}\xspace}
\newcommand{\pref}{\textup{pref}}
\newcommand{\suff}{\textup{suff}}
\newcommand{\midd}{\textup{mid}}
\newcommand{\low}{\textup{low}}
\newcommand{\high}{\textup{high}}
\newcommand{\init}{\textup{init}}
\newcommand{\rank}{\textup{rank}}
\newcommand{\tree}{\textup{tree}}
\newcommand{\alp}{\textup{alph}}
\newcommand{\fresh}{\textup{fresh}}
\newcommand{\dis}{\textup{dis}}
\newcommand{\ratio}{\textup{ratio}}
\newcommand{\norm}{\textsc{norm}}
\newcommand{\supp}{\textup{supp}}
\newcommand{\trash}{\textup{trash}}
\newcommand{\proj}{\textup{proj}}
\newcommand{\conf}{\textup{Conf}}
\newcommand{\atrans}{\textup{AnTrans}}
\newcommand{\inp}{\textup{inp}}
\newcommand{\out}{\textup{out}}
\newcommand{\size}{\textsc{size}}
\newcommand{\spn}{\textsc{span}}
\newcommand{\flush}{\textbf{\textup{flush}}}
\newcommand{\ztest}{\textbf{\textup{zero-test}}}
\newcommand{\mult}{\textbf{\textup{multiply}}}
\newcommand{\reaches}{\longrightarrow}
\newcommand{\nreaches}{\centernot\longrightarrow}
\newcommand{\lin}{\textup{Lin}}
\newcommand{\ds}{\textup{data}}\newcommand{\alleven}{\textup{AllEven}\xspace}
\newcommand{\allodd}{\textup{AllOdd}\xspace}
\newcommand{\limsupeven}{\textup{LimsupEven}\xspace}
\newcommand{\limsupodd}{\textup{LimsupOdd}\xspace}

\newcommand{\addeq}{\mathrel{+}=}
\newcommand{\subeq}{\mathrel{-}=}
\newcommand\tab{\;\;\;\;}
\newcommand{\loopp}{\textup{\textbf{loop}}\xspace}
\newcommand{\body}{\textup{\textbf{body}}\xspace}
\newcommand{\dop}{\textup{\textbf{do}}\xspace}
\newcommand{\downto}{\textup{\textbf{downto}}\xspace}
\newcommand{\ampl}{\textup{\textbf{ampl}}\xspace}


\newcommand{\eff}{\textsc{eff}}
\newcommand{\drop}{\textsc{drop}}
\newcommand{\leff}{\textup{left-eff}}
\newcommand{\reff}{\textup{right-eff}}
\newcommand{\maxeff}{\textup{max-eff}}
\newcommand{\maxreach}{\textup{max-reach}}
\newcommand{\pump}{\textup{pump}}
\newcommand{\lleft}{\textup{left}}
\newcommand{\rright}{\textup{right}}
\newcommand{\lift}{\textup{lift}}
\newcommand{\lsize}{\textup{leaf-size}}
\newcommand{\sm}{\textup{small}}
\newcommand{\rt}{\textup{root}}
\newcommand{\ver}{\textup{ver}}
\newcommand{\poly}{\textup{poly}}
\newcommand{\bottom}{\textup{bottom}}
\newcommand{\topp}{\textup{top}}
\newcommand{\shape}{\textup{shape}}
\newcommand{\graph}{\textup{graph}}

\newcommand{\fra}[3]{\left(\frac{#1}{#2}\right)^{#3}}

\newcommand{\eps}{\varepsilon}

\newcommand{\Nplus}{\N_{\geq 0}}	
\newcommand{\zeroel}[1]{0_{#1}}
\newcommand{\floor}[1]{\lfloor #1 \rfloor}
\newcommand{\ceil}[1]{\lceil #1 \rceil}




\renewcommand{\enspace}{}






\newcommand{\nl}{\textsc{NL}\xspace}
\newcommand{\nctwo}{\textsc{NC$^2$}\xspace}
\newcommand{\ptime}{\textsc{PTime}\xspace}
\newcommand{\np}{\textsc{NP}\xspace}
\newcommand{\pspace}{\textsc{PSpace}\xspace}
\newcommand{\exptime}{\textsc{ExpTime}\xspace}
\newcommand{\expspace}{\textsc{ExpSpace}\xspace}
\newcommand{\twoexptime}{\textsc{2-ExpTime}\xspace}
\newcommand{\twoexpspace}{\textsc{2-ExpSpace}\xspace}
\newcommand{\tower}{\textsc{Tower}\xspace}
\newcommand{\ackermann}{\textsc{Ackermann}\xspace}
\newcommand{\hypackermann}{\textsc{HyperAckermann}\xspace}

\newcommand{\myparagraph}[1]{\vskip 0.3cm\textbf{#1.}}



\newcommand{\goto}[2]{\textbf{goto} {\footnotesize #1} \textbf{or} {\footnotesize #2}}
\newcommand{\gotod}[1]{\textbf{goto} {\footnotesize #1}}
\newcommand{\zerotest}[1]{\textbf{zero-test}($#1$)}
\newcommand{\testm}[1]{\textbf{max?}~$#1$}
\newcommand{\inc}[1]{\add{#1}{1}}
\newcommand{\dec}[1]{\sub{#1}{1}}
\newcommand{\add}[2]{$\coreadd{\vr{#1}}{#2}$}
\newcommand{\sub}[2]{$\coresub{\vr{#1}}{#2}$}
\newcommand{\coreadd}[2]{#1 \,\, +\!\!= \, #2}
\newcommand{\coresub}[2]{#1 \,\, -\!\!= \, #2}
\newcommand{\vr}[1]{#1}
\newcommand{\halt}{\textbf{halt}}
\newcommand{\haltz}[1]{{\halt} \textbf{if} $#1 = 0$}
\newcommand{\initialise}{\textbf{initialise to} $0$}

 



\renewcommand{\vec}[1]{\overrightarrow{#1}}

\newcommand{\subseteqfin}{\subseteq_{\fin}}
\newcommand{\LPS}{\lps}
\newcommand{\SLPS}{\slps}
\newcommand{\kanapka}[2]{(#1, #2)-approximately semi-linear}
\newcommand{\lb}{length-bounded\xspace}
\newcommand{\plb}{polynomially length-bounded\xspace}

\newcommand{\kbound}[2]{{#1}^{2^{2^{#2}}}}
\newcommand{\HH}[2]{H_{#1}(#2)}

\newcommand{\slawek}[1]{\textcolor{blue}{\bf S: #1}}
\newcommand{\slawekinline}[1]{\slawek{#1}}
\newcommand{\sltodo}{\slawek{TODO}}
\newcommand{\Lin}[1]{\textsc{Lin}(#1)}
\newcommand{\Len}[3]{\textsc{Len}(#1, #2, #3)}
\newcommand{\OO}{{\cal O}}
\newcommand{\trim}{$(a, B, c)$-trim }
\newcommand{\mytrim}[2]{(#1, #2)-trim}
\newcommand{\vass}{{\sc vass}\xspace}
\newcommand{\zvass}{$\Z$-{\sc vass}\xspace}
\newcommand{\lps}{\textsc{lps}\xspace}
\newcommand{\dlps}{2-\lps}
\newcommand{\dslps}{2-\slps}
\newcommand{\dvass}{\parvass 2}
\newcommand{\tvass}{\parvass 3}
\newcommand{\geomvass}{geometrically 2-dimensional \tvass}
\newcommand{\Geomvass}{Geometrically 2-dimensional \tvass}
\newcommand{\tzvass}{\parzvass 3}
\newcommand{\parvass}[1]{{$#1$-\vass}\xspace}
\newcommand{\parzvass}[1]{{$#1$-$\Z$-\vass}\xspace}
\newcommand{\ltvass}{(V_1) u_1 (V_2) u_2 \ldots u_{\ell-1} (V_\ell)}
\newcommand{\ktvass}{(V_1) u_1 (V_2) u_2 \ldots u_{k-1} (V_k)}
\newcommand{\ktvasstwo}{(V_2) u_2 \ldots u_{k-1} (V_k)}
\newcommand{\ktvassmod}{(\essdvass V_i) \essdvass u_{i, b} (V_2) u_2 \ldots u_{k-1} (V_k)}
\newcommand{\ktvassmodmod}{(\essdvass V) \essdvass u_{b} (V_2) u_2 \ldots u_{k-1} (V_k)}
\renewcommand{\C}{\mathcal{C}}
\newcommand{\para}[1]{\vspace{-3mm}\subparagraph*{\bf #1.}}
\newcommand{\setfromto}[2]{[#1, #2]}
\newcommand{\setto}[1]{\setfromto 1 {#1}}
\newcommand{\Wlog}{W.l.o.g.~}
\newcommand{\mywlog}{w.l.o.g.~}
\newcommand{\rev}[1]{{#1}^{\text{rev}}}
\newcommand{\DI}{diagonal intersecting}
\newcommand{\DNI}{diagonal non-intersecting}
\newcommand{\ND}{non-diagonal}
\newcommand{\cone}[1]{\textsc{Cone}(#1)}
\newcommand{\seqcone}[1]{\textsc{SeqCone}(#1)}
\newcommand{\Qnonneg}{\Q_{\geq 0}}
\newcommand{\Npos}{\N_{>0}}
\newcommand{\inter}[1]{\textsc{Int}(#1)}
\newcommand{\essdvass}[1]{\overline{#1}}
\newcommand{\innprod}[2]{#1 \diamond #2} \newcommand{\pair}[2]{#1_{#2}}
\newcommand{\triple}[3]{#1_{#2, #3}}
\newcommand{\pumps}[1]{\textsc{FP}(#1)}
\newcommand{\absv}[1]{|#1|}
\newcommand{\rhs}{\textsc{rhs}}

\newcommand{\probdef}[3]{
\begin{itemize} 
\item[] \textsc{#1}
    \item[] \textit{Input:} \quad\, #2.
    \item[] \textit{Question:} #3?
\end{itemize}
}

 
\nolinenumbers




\begin{document}

\maketitle

\begin{abstract}
The reachability problem in 3-dimensional vector addition systems with states (3-VASS) is known to be PSpace-hard, and to belong to Tower. We significantly narrow down the complexity gap by proving the problem to be solvable in doubly-exponential space.
The result follows from a new upper bound on the length of the shortest path:
if there is a path between two configurations of a 3-VASS then there is also one of at most triply-exponential length.
We show it by introducing a novel technique of approximating the reachability sets of 2-VASS by small semi-linear sets.
\end{abstract}


\maketitle



\section{Introduction}\label{sec:intro}

Petri nets are an established model of concurrent systems with extensive applications in various
areas of theoretical computer science.
For most algorithmic questions, the model is equivalent to
\emph{vector addition systems} with states (\vass in short).
A $d$-dimensional \vass (\parvass d in short) is a finite automaton equipped additionally
with a finite number $d$ of nonnegative integer counters that are updated by
transitions, under the proviso that the counter values can not drop below zero.
Importantly, \vass have no capability to zero-test counters, and hence the model is not Turing-complete. 

One of the central algorithmic problems for VASS is the \emph{reachability problem} which asks,
if in a given \vass there is a path (a sequence of executions of transitions) 
from a given source configuration (consisting of a 
state together with counter values) to a given target configuration:

\probdef{\vass reachability problem}
{\vass $V$, source and target configurations $s, t$}
{Is there a path from $s$ to $t$}

\noindent
Already in 1976, the problem was shown to be \expspace-hard by Lipton~\cite{Lipton76}, and
few years later decidability was shown by Mayr~\cite{Mayr81}.
Later improvements~\cite{DBLP:conf/stoc/Kosaraju82,DBLP:journals/tcs/Lambert92} simplified the construction, 
but no complexity upper bound was given until Leroux and Schmitz showed that the problem 
can be solved in Ackermannian complexity~\cite{LerouxS15,LS19}.
At the same time the lower bound was lifted to \tower-hardness~\cite{CzerwinskiLLLM21}, and soon
afterwards, in 2021, improved to \ackermann-hardness~\cite{DBLP:conf/focs/Leroux21,DBLP:conf/focs/CzerwinskiO21}.

Although the complexity of the reachability problem is now settled to be \ackermann-complete, 
various complexity questions remain still widely open.
One of them is the complexity of the reachability problem parametrised by dimension, namely in
$d$-dimensional \vass (\parvass d) for fixed $d \in \N$. 
Although the question has been investigated for a few decades, 
exact bounds are only known for dimensions 1 and 2
(both for unary or binary representations of numbers in counter updates).
In the case of binary encoding, the reachability problem is \np-complete
for \parvass 1~\cite{DBLP:conf/concur/HaaseKOW09} and \pspace-complete 
for \dvass~\cite{BlondinFGHM15}, and in case of
unary encoding the problem is \nl-complete both for \parvass 1 (folklore) and for 
\dvass~\cite{DBLP:conf/lics/EnglertLT16}.
For higher dimension almost nothing is  known.

All the upper complexity bounds for dimension 1 or 2 were obtained by estimating
the length of the shortest path, or of its representation.
For unary \parvass 1, it is a folklore that if there is a path between two configurations then there is 
also one of polynomial length (see~\cite{DBLP:journals/lmcs/ChistikovCHPW19} for more demanding 
quadratic upper bound), which implies \nl-completeness.
For binary \parvass 1, a polynomial-size representation of the shortest path was provided
by~\cite{DBLP:conf/concur/HaaseKOW09}.
Concerning binary \dvass,
already in 1979 Hopcroft and Pansiot showed that the reachability sets of \dvass
are effectively semi-linear, and therefore the reachability problem is 
decidable~\cite{DBLP:journals/tcs/HopcroftP79}.
Subsequently, \twoexptime upper complexity bound for binary \dvass
was established by~\cite{DBLP:journals/tcs/HowellRHY86}.
In~\cite{DBLP:conf/concur/LerouxS04} Leroux and Sutre showed that even the reachability relation 
is semi-linear, and that the relation
is flattable, namely that it can be described by a finite number of simple expressions called 
\emph{linear path schemes}.
Only in 2015, careful examination of these linear path schemes led to
exponential upper bound on the length of the shortest path, and 
consequently to \pspace upper bound~\cite{BlondinFGHM15}.
Concerning unary \dvass, polynomial upper bound on the length of the shortest path was shown
\cite{DBLP:conf/lics/EnglertLT16,DBLP:journals/jacm/BlondinEFGHLMT21},
thus yielding \nl-completeness. 

Our understanding of the model drops drastically for dimensions larger than 2,
as most of good properties admitted in dimension 1 or 2 vanish.
For instance, already since the seminal paper~\cite{DBLP:journals/tcs/HopcroftP79} it is known that
reachability sets of \tvass are not necessarily semi-linear.
Investigation of \tvass was advocated by many papers cited above, 
e.g.~\cite{DBLP:journals/tcs/HopcroftP79,BlondinFGHM15,DBLP:journals/jacm/BlondinEFGHLMT21},
but until now no specific complexity bounds for \tvass are known, except for generic 
parametric bounds known for \parvass d in arbitrary fixed dimension $d\geq 3$.
By~\cite{LS19}, the reachability problem in \parvass d
is in  $\F_{d+4}$,\footnote{The complexity class $\F_i$ corresponds to the $i$-th level 
of Grzegorczyk's fast-growing hierarchy~\cite{DBLP:journals/toct/Schmitz16}.}
later improved to $\F_d$~\cite{DBLP:conf/icalp/FuYZ24}.
In case of \tvass, this yields membership in $\F_3 = \tower$.
On the other hand, no lower bound is known for binary \tvass except for the \pspace lower bound 
inherited from binary \dvass
(for unary \tvass, \np-hardness has been recently shown by~\cite{DBLP:conf/focs/0001CMOSW24}).
The complexity gaps remains thus huge, namely between \pspace and \tower.
As our main result, we narrow down this gap significantly.




\para{Contribution}

In this paper we investigate complexity of the reachability problem in \tvass.
Our main result is the first elementary upper complexity bound for the problem:

\begin{theorem}\label{thm:expspace}
The reachability problem in \tvass is in \twoexpspace, under binary encoding.
\end{theorem}

\noindent
In particular, this refutes the natural conjecture that for every $d \geq 3$, the reachability problem for 
\parvass d is $\F_d$-complete and provides the first algorithm, which solves the problem
for \vass with finite reachability sets faster than exhaustive search.



Our way to prove Theorem~\ref{thm:expspace} is by bounding triply-exponentially 
the length of the shortest path between the given source and target configurations.
This main technical result, formulated in Lemma~\ref{lem:main} below,
applies to \emph{sequential} \tvass, which are sequences of strongly connected components
$V_1, \ldots, V_k$ linked by single transitions $u_1, \ldots, u_{k-1}$ 
(see Figure \ref{fig:kcompvass}; the rigorous definition is given in Section \ref{sec:def}).

\newcommand{\labelscvass}[1]{{\tiny\begin{tabular}{c}\tiny strongly\\ \tiny connected\\ \tiny \tvass $V_{#1}$\end{tabular}}}
\begin{figure}
\centering
\scalebox{1.0}{
\begin{tikzpicture}[shorten >=1pt,node distance=3cm,on grid,>={Stealth[round]},
    every state/.style={draw=blue!50,thick,fill=blue!20},scale=0.25]

  \node[state]          (q_0)                      {\labelscvass 1};
  \node[state]          (q_1) [right=of q_0] {\labelscvass 2};
  \node[]                  (q_ldots) [right=of q_1] {\ \ \ \ \ \ ... \ \ \ \ \ \ };
  \node[state]          (q_k) [right=of q_ldots] {\labelscvass k};

  \path[->] 
            (q_0) edge              node [above]  {$u_1$} (q_1)
            (q_1) edge              node [above]  {$u_2$} (q_ldots)
            (q_ldots) edge              node [above]  {$u_{k-1}$} (q_k);
\end{tikzpicture}
}
\caption{A sequential \tvass.}
\label{fig:kcompvass}
\end{figure}

Given a \vass $V$ and source and target configurations $s, t$, by
$\size(V,s,t)$ we mean the sum of absolute values of all the numbers occurring in transitions of $V$, $s$ and $t$, 
plus the number thereof.

\begin{lemma}\label{lem:main}
If there is a path from $s$ to $t$ in a sequential \tvass $V$,
then there is one of length at most 
$\kbound {\size(V,s,t)} {\OO(k)}$, where $k$ is the number of components of $V$.
\end{lemma}



\noindent
Therefore the length of the shortest path in a $k$-component \tvass is bounded by $\kbound M {\OO(k)}$,
where $M = \size(V,s,t)$ is the size of input, under unary encoding.
This is the first bound on the shortest path in \vass of dimension higher than 2, that is not based on
the size of (finite) reachability sets.
Indeed, in a \tvass of size $M$, the size of finite reachability sets may be an arbitrary high tower of exponentials.


In consequence of Lemma \ref{lem:main}, 
Theorem~\ref{thm:expspace} follows immediately: 
the upper bound of Lemma \ref{lem:main} 
is triple-exponential in the size of input, irrespectively whether unary or  binary encoding is used, 
which implies the same bound on norms of configurations
along the shortest path.
This yields a nondeterministic double-exponential space algorithm that
first guesses a sequence of components leading from the source state to the target one,
and then searches for a witnessing path.
Note that the complexity bound under unary encoding is not better than under binary encoding. 




Lemma \ref{lem:main} immediately yields further upper bounds for the reachability problem,
when the number of components is fixed:

\begin{corollary}\label{cor:fixed-components}
For every fixed $k \geq 1$, the reachability problem in $k$-component \tvass is:
\begin{itemize}
  \item in \nl, under unary encoding,
  \item in \pspace, under binary encoding.
\end{itemize}
\end{corollary}

\noindent
Indeed, for every fixed $k\geq 1$, the bound of Lemma~\ref{lem:main} is polynomial with respect to
unary input size.
Therefore the length of the shortest path, as well as the norm of configurations along this path, are 
polynomially bounded in case of unary encoding,
and exponentially bounded in case of binary encoding.
This bounds yield membership in \nl and \pspace, respectively.
Thus for every fixed $k\geq 1$, the complexity of $k$-component \tvass matches the complexity of \dvass.



\para{Organisation of the paper}
We start by introducing notation and basic facts in Section~\ref{sec:def}.
Overview of the proof of our main result, Lemma \ref{lem:main}, is presented in Section~\ref{sec:overview}.
In Section \ref{sec:1comp} we focus on 1-component \tvass, thus establishing the base of induction
for Lemma \ref{lem:main}.
Next, in Section \ref{sec:tools} we introduce the fundamental concept of \sandwich sets,
and formulate our core technical result: reachability sets of \dvass
are \sandwich.
The result is then applied in the inductive proof of Lemma \ref{lem:main} in Section \ref{sec:mainproof}.
We conclude in Section~\ref{sec:future}.
















 

\section{Preliminaries}\label{sec:def}

Let $\Q, \Qnonneg, \Qpos$ denote the set of all, nonnegative, and positive rationals, respectively,
and likewise let $\Z, \N, \Npos$ denote the respective sets of integers.
For $a, b \in \Z$, $a \leq b$, let $\setfromto a b$ denote the set $\{x \in \Z \mid a \leq x \leq b\}$.
The $j$th coordinate of a vector $w\in\Q^d$ we write as $w_j$.
Thus $w = (w_1, \ldots, w_d)$.
For $q\in \Q$,
by $\vec q$ we denote the constant vector $(q, \ldots, q) \in \Q^d$.

\para{Vector addition systems with states}

Let $d\in\Npos$.
A $d$-dimensional \emph{vector addition system with states} (\parvass d in short) $V=(Q,T)$ consists of
a finite set $Q$ of states, and a finite set of transitions $T\subseteq Q\times \Z^d \times Q$.
A \emph{configuration} $c$ of $V$ consists of a state $q\in Q$ and a nonnegative vector $w\in\N^d$,
and is written as $c=q(w)$.
A transition $u=(q,v,q')$ induces \emph{steps} $q(w) \trans{u} q'(w')$ between configurations, where $w' = w+v$.
We refer to the vector $v\in\Z^d$ as the \emph{effect} of the transition $(q,v,q')$ or of an induced step.
A \emph{path} $\pi$ in $V$ is a sequence of steps with the proviso that the target configuration of every step matches
the source configuration of the next one:
\begin{align} \label{eq:path}
\pi \ = \ c_0 \trans{u_1} c_1 \trans{} \ldots \trans{u_n} c_n.
\end{align}
The \emph{effect} $\eff(\pi)\in\Z^d$
of a path is the sum of effect of all steps, and its \emph{length} is the number $n$ of steps.
We say that the path is \emph{from} $c_0$ \emph{to} $c_n$, call $c_0, c_n$ source and target 
configuration, respectively, of the path, and write $c_0\trans{\pi}c_n$.
We also write $c \tran c'$ if there is some path from $c$ to $c'$.
A path $q(v) \tran q(v')$ in $V$ with the same source and target state
we call a \emph{cycle}.
A cycle is \emph{simple} if the only equality of states along the cycle is the equality of source and target states.
When dimension $d$ is irrelevant, we write \vass instead of \parvass d.

By the \emph{geometric} dimension of a \parvass d we mean the dimension of the vector
space $\Lin V \subseteq \Q^d$ spanned by effects of all its simple cycles.
In the sequel we most often consider \dvass and \tvass, but also \emph{\geomvass}, i.e.,
\tvass of geometric dimension at most 2.

Two paths $\pi$ and $\pi'$ can be \emph{concatenated} (composed), written $\pi; \, \pi'$, if
the target configuration of $\pi$ equals the source one of $\pi'$.
As long as it does not lead to confusion, 
we adopt a convention that when concatenating paths $\pi;\,\pi'$, 
the latter path $\pi'$ is silently \emph{moved}
so that its source matches the target of $\pi$, 
under assumption that the source state of $\pi'$ is the same as the target state of $\pi$.
For instance, we write $\pi^m$ to denote the $m$-fold concatenation of a cycle $\pi$, even if $\eff(\pi)\neq\vec 0$.


We use the following notation for measuring size of representation of a \vass.
By \emph{norm} of a vector $v=(v_1, \ldots, v_d) \in \Q^d$, denoted $\norm(v)$, 
we mean the sum of absolute values of all numbers appearing in it:
$\norm(v) = \absv{v_1} + \ldots + \absv{v_d}$; and 
by norm of a set of vectors $P$ we mean the sum of norms of its elements:
$\norm(P) = \sum\setof{\norm(v)}{v\in P}$. 
By \emph{norm} of a configuration $q(w)$, or of a transition $(q, w, q')$,
we mean the norm of its vector $w$.
By \emph{size} of a \vass $V$, denoted $\size(V)$, we mean
the sum of norms of all its transitions, 
plus the number of transitions $\card T$.
The \emph{norm} of a \vass is the maximal norm of its transition.


We often implicitly extend a \vass $V$ with source configuration $s$, or with
a pair of source and target configurations $s, t$.
Slightly overloading terminology, a pair $(V, s)$ and a triple $(V, s, t)$ we call a \vass too.
For convenience we overload further and put $\size(V,s) = \size(V) + \norm(s)$ and 
$\size(V, s, t) = \size(V) + \norm(s) + \norm(t)$.
The \emph{reverse} of a \vass $V = (Q, T)$ is defined as $\rev V = (Q, T')$,
where $T'$ is obtained by reversing all transitions in $T$:
$T' = \setof{(q', -v, q)}{(q,v,q')\in T}$.
Overloading the notation again, we put $\rev{(V, s, t)} := (\rev V, t, s)$.

Given a \vass together with an initial configuration $(V, s)$, we write 
$\reach(V,s)$ to denote the set of configurations $t$ such that $V$ has a path from $s$ to $t$.
For every state $q\in Q$ we write $\reach_q(V,s)$ to denote the
set of vectors $w\in\N^d$ such that $q(w) \in \reach(V,s)$.
We write shortly $\reach(s)$ and $\reach_q(s)$ if the \vass $V$
is clear from the context.
If $t\in\reach(s)$ we say that $t$ is \emph{reachable} from $s$.
If $t+\Delta\in\reach(s)$ for some $\Delta\in\N^d$, we say that $t$ is \emph{coverable} from $s$.

We consider a variant of \vass, called \zvass, where the nonnegativeness constraint is dropped.
Syntactically, \zvass is the same as \vass, namely consists of a finite set of states and a finite set of transitions
$(Q, T)$. 
Semantically, configurations of a \zvass are $Q \times \Z^d$, while
all definitions (path, reachability set, etc.) are the same as in case of \vass.
Equivalently, we may also speak of $\Z$-configurations and $\Z$-paths of a \vass, i.e., 
configurations and paths where the nonnegativeness constraint is dropped.
Note that every $\Z$-path $q(w) \trans{\pi} q'(w')$ may be \emph{lifted} to become a path
$q(w+\Delta) \trans{\pi} q'(w'+\Delta)$, for some $\Delta \in \N^d$.



\para{Sequential \vass}

We define the state graph of a \vass $V = (Q, T)$: nodes are states $Q$, and there is an edge
$(q,q')$ if $T$ contains a transition $(q, v, q')$ for some $v\in\Z^d$.
A \vass is called \emph{strongly connected} if its state graph is so.
A \vass $V = (Q, T)$ is called \emph{sequential},
if it can be partitioned into a number of strongly connected 
\vass $V_1=(Q_1, T_1), \ldots, V_k=(Q_k, T_k)$ with pairwise disjoint state spaces, 
and $k-1$ transitions
$u_i=(q_i, v_i, q'_i)$, for $i\in\setto{k-1}$, where $q_i\in Q_i$ and $q'_i \in Q_{i+1}$
(recall Figure \ref{fig:kcompvass}).
Thus $Q=Q_1\cup\ldots\cup Q_k$ and 
$T=T_1 \cup \ldots \cup T_k \cup \{u_1, \ldots, u_{k-1}\}$.
We call $V$ a \emph{$k$-component} sequential \vass,
or $k$-component \vass in short,
and write down succinctly as 
$
V  =  \ktvass.
$
The \vass $V_1, \ldots, V_k$ are called \emph{components}, and transitions
$u_1, \ldots, u_{k-1}$  \emph{bridges}.
By definition, a $1$-component sequential \vass is just a strongly connected \vass.


\para{Integer solutions of linear systems}
We will intensively use the following immediate corollary of \cite{Pottier91}
(see also \cite[Prop.~4]{taming}):
\begin{lemma}[\cite{taming}, Prop.~4]
\label{lem:taming}
Consider a system $A\cdot x = b$ of $m$ Diophantine linear equations with $n$ unknowns,
where absolute values of coefficients are bounded by $N$.
Every pointwise minimal nonnegative integer solution has norm at most
$\OO(nN)^m$.
\end{lemma}


\para{Diagonal property}

We prove that
if there is a path in a \vass achieving a large value on every coordinate,
then there is a path of bounded length that achieves \emph{simultaneously} large values on all coordinates.\footnote{Lemma \ref{lem:sim-high-d} is inspired by \cite[Lemma 4.13]{LS19}, 
but the statement and the proof are different.}
We consider a general case of arbitrary dimension,
as we believe it is of an independent interest, but in the sequel we will use it only for dimension $d = 3$.

\begin{lemma}\label{lem:sim-high-d}
For every $d \in \N$ there are nondecreasing polynomials $P_d, R_d$ such that 
for every \parvass d $(V, s)$ of norm $N$, with $n$ states, and for every $U\in\N$,
if $V$ has a path from $s$ that for every $i\in\setto d$ contains a configuration 
$q(w_1, \ldots, w_d)$ with $w_i \geq P_d(n, N, U)$,
then $V$ has also a path $s \tran q(w_1, \ldots, w_d)$ of length at most $R_d(n, N, U)$
such that $w_i \geq U$ for every $i\in\setto d$.
\end{lemma}

\begin{appendixproof}[Proof of Lemma \ref{lem:sim-high-d}]
Below, we will refer to two inductively defined sequences $(H_i)_{i\in\Npos}$, $(L_i)_{i\in\Npos}$,
(implicitly) parametrised
by numbers $n, N, U \in \N$:
let $H_1 := U$, $L_1 = n U$, and for  $i > 1$ let $H_i = U + N L_{i-1}$ and  
$L_i = n (H_i)^i + L_{i-1}$.

\begin{lemma}\label{lem:sim-high}
Let $d \in \N$, and let $(V, s)$ be a \parvass d of norm $N$, with $n$ states.
If $V$ has a path from $s$ that for every $i\in\setto d$ contains a configuration 
$q(w_1, \ldots, w_d)$ with $w_i \geq H_d$,
then $V$ has also a path $s \tran q(w_1, \ldots, w_d)$ of length at most $L_d$
such that $w_i \geq U$ for every $i\in\setto d$.
\end{lemma}


\begin{proof}\textcolor{red}{TOPROVE 0}\end{proof}

We show that $H_i$ and $L_i$ are bounded by a polynomial in $n, N, U$, of
degree doubly exponential in dimension $d$.
We concentrate on $H_i$, as
$H_i \leq L_i \leq H_{i+1}$.

\begin{proposition}\label{prop:hd-bound}
$H_i \leq (4Nn)^{2i!} U^{i!}$.
\end{proposition}

\begin{proof}\textcolor{red}{TOPROVE 1}\end{proof}
Lemma~\ref{lem:sim-high}, Proposition~\ref{prop:hd-bound} and the inequality $L_i \leq H_{i+1}$
entail Lemma \ref{lem:sim-high-d}.
\end{appendixproof}


\para{Length-bound on shortest path}

A function $f:\N\to\N$ is called \emph{nondecreasing} if $f(n) \geq n$ for every $n \in \N$,
and $f(n)< f(m)$ for all $n<m$.
Functions used in the sequel are most often nondecreasing.
We say that a class $\C$ of \vass or \zvass is \emph{\lb} by a 
non-decreasing function $f:\N\to\N$ if 
for every $(V, s, t)$ in $\C$, if $s \tran t$ then 
$s \trans{\pi} t$ for some path $\pi$ of length at most $f(\size(V, s, t))$.
A class $\C$ which is \lb  by some nondecreasing
polynomial we call \emph{\plb}.
It is known that \dvass  have this property:
\begin{lemma}[\cite{DBLP:journals/jacm/BlondinEFGHLMT21}, Theorem 3.2]\label{lem:2vass-plb}
\dvass are \plb.\footnote{\cite{DBLP:journals/jacm/BlondinEFGHLMT21} adopts a slightly different, but equivalent
up to a constant multiplicative factor, definition of norm and 
size.
}
\end{lemma}
As a corollary of Lemmas \ref{lem:2vass-plb} and \ref{lem:taming}, respectively,
we derive the property for \geomvass 
(using \cite[Lemma 5.1]{Zhang-geom}) and \tzvass, respectively:
\begin{lemma}\label{lem:geom-plb}
\Geomvass are \plb.
\end{lemma}
\begin{appendixproof}[Proof of Lemma \ref{lem:geom-plb}]
We rely on the construction of \cite[Lemma 5.1]{Zhang-geom}, which transforms a given 
\geomvass $(V, s, t)$ into a \dvass $(\essdvass V, \essdvass s, \essdvass t)$ such that\footnote{
In \cite{Zhang-geom} only zero source and target vectors are considered, but the construction
routinely extends to arbitrary such vectors. 
}
\[
\Len {\essdvass V} {\essdvass s} {\essdvass t} \ = \ \{3 \cdot n \mid n \in \Len V s t\},
\]
and the size of the \dvass is only polynomially larger than the size of the original \geomvass. 
Therefore, as \dvass are \plb due to Lemma \ref{lem:2vass-plb}, so are also \geomvass.
\end{appendixproof}
\begin{lemma} \label{lem:zvass-plb}
\tzvass are \plb.
\end{lemma}
\begin{appendixproof}[Proof of Lemma \ref{lem:zvass-plb}]
Let $(V, s, t)$ be a \tzvass such that $s\trans{\sigma} t$.
Let $V=(Q,T)$, $s=q(w)$ and $t=q'(w')$.
Let $M = \size(V, s, t) = \size(V) + \norm(s) + \norm(t)$.
We express a path as a solution of a Diophantine system of linear equations, and rely
on Lemma \ref{lem:taming}.

Let $Q'\subseteq Q$ and $T'\subseteq T$ be the subsets of states and transitions that appear in $\sigma$.
Simple cycles that use only transitions from $T'$ we call $T'$-cycles.
The $\Z$-path $s\trans{\sigma} t$ decomposes into a $\Z$-path $\sigma_0$ that visits all states of $Q'$,
plus a number of $T'$-cycles.
Choose the shortest such $\sigma_0$.
The $\Z$-path $\sigma_0$ visits each state at most $\card Q$ times, as otherwise it could be shortened,
and therefore its effect has norm at most $M^2$.
The effect $\Delta$ of each $T'$-cycle has norm at most $M$, as it contains no repetition of a transition.
We choose, for each such vector $\Delta$, one of $T'$-cycles with effect $\Delta$.
Let $\cal C$ be the set of chosen $T'$-cycles. 
Its size is at most $(2M+1)^3 \leq \OO(M^3)$.
We define a system $\cal U$
of 3 linear equations (one for each dimension), whose unknowns $x_\delta$ correspond to $T'$-cycles $\delta$ from $\cal C$:
\[
\sum_{\delta\in \mathcal{C}} x_{\delta} \cdot e_\delta \ + \ e_{\sigma_0} \ = \ t - s,
\]
where $e_\delta\in\Z^3$ is the effect of $\delta$, 
and $e_{\sigma_0}\in\Z^3$ is the effect of $\sigma_0$.
The system has a nonnegative integer solution, namely the one obtained from decomposition of $\sigma$
into $\sigma_0$ and simple cycles.
As all coefficients of $\cal U$ are bounded by $M^2$,
by Lemma \ref{lem:taming} the system has a solution of norm $\OO(M^3\cdot M^2)^3=\OO(M^{15})$.
The solution $(x_\delta)_\delta$ 
yields a $\Z$-path $s\tran t$ of length $\OO(M^{16})$, consisting of $\sigma_0$ with
attached all cycles $\delta\in\mathcal{C}$
(this is possible, as $\sigma_0$ visits all states used by the cycles),
each $\delta$ iterated $x_\delta$ times.
This completes the proof.
\end{appendixproof}
Lemma \ref{lem:main} states that there exists a constant $C\in\N$ such that
for every $k\in\N$, the $k$-component \tvass are 
length-bounded by the function $M\mapsto \kbound {M} {C\cdot k}$.
Therefore for every fixed $k\in\N$, the $k$-component \tvass are \plb,
even if the degree of polynomial grows doubly exponentially in $k$.

 

\section{Overview} \label{sec:overview}
In this section we present an overview of the proof of our main result, namely of Lemma~\ref{lem:main}.
The proof proceeds by an induction on the number $k$ of components in a sequential \tvass.
The main idea is that either the situation is easy (a short path can be obtained by lifting up a $\Z$-path)
or the first component can be transformed into a finite union of essentially two-dimensional \vass (more precisely,
finite union of \geomvass), each of size bounded polynomially. This transformation is shown in Lemma~\ref{lem:len-eq}.
The induction base is shown in Section~\ref{sec:1comp}. We present the proof of the one component case in detail,
as it illustrates the main concepts of the proof of Lemma~\ref{lem:len-eq}, but in a much simpler setting.
When the first component is transformed into essentially a \dvass, we can use the fact that
reachability sets in \dvass are semi-linear and the size of the semi-linear representation
is at most exponential~\cite{BlondinFGHM15} (the result is true as well in \geomvass).
This fact can be exploited to reduce reachability for $k$-component \tvass to reachability for $(k-1)$-component \tvass
of exponentially larger size, the details of this reduction are explained in Section~\ref{sec:tools}
in the paragraph about the idea of the proof of Lemma~\ref{lem:main}.
However, if we use semi-linear sets, the exponential blowup in unavoidable and this approach gives us a \tower algorithm
resulting from a linear number of exponential blowups (thus not better than \cite{DBLP:conf/icalp/FuYZ24}).
In order to improve the complexity we introduce a novel notion of suitable over- and under-approximations of semi-linear sets.
One of our key technical contributions is Lemma~\ref{lem:2vass-sandwich} stating that reachability sets
of \dvass can be well approximated. 
Intuitively speaking, the precision of the approximation has to be good enough for correctness of the inductive proof;
the better the precision, the bigger the representation of approximants gets.
This approach allows us to reduce reachability for $k$-component \tvass to reachability in $(k-1)$-component \tvass of size which is not anymore exponential, but is polynomial in $B$,
where $B$ is the minimal length of a path in $(k-1)$-component \tvass.
This means that $n^m$ bound on the minimal path length for $(k-1)$-component \tvass implies roughly a $n^{m^2}$
bound on the minimal path length for $k$-component \tvass. The transformation
$n^m \mapsto n^{m^2}$ applied linear number of times results in triply-exponential upper bound for the minimal length of a path in \tvass.

 

\section{1-component \tvass are \plb} \label{sec:1comp}

This section is devoted to the proof of the 
induction base for the proof of Lemma \ref{lem:main}:

\begin{lemma} \label{lem:1comp}
1-component \tvass are \plb.
\end{lemma}

\noindent
We also develop a framework to be exploited in the induction step in 
Section \ref{sec:mainproof}.
We may safely restrict to \tvass of geometric dimension 3,
as otherwise Lemma~\ref{lem:geom-plb} immediately implies Lemma~\ref{lem:1comp}.

\para{Case distinction}
A \tvass $(V, s, t)$, where $s=p(w)$ and $t=p'(w')$,
is \emph{forward-diagonal} if
$p(w) \trans{*} p(w+\Delta)$ in $V$ for some $\Delta \in (\Npos)^3$.
Symmetrically, $(V, s, t)$ is \emph{backward-diagonal} if $\rev{(V, t, s)}$ is diagonal, i.e., if 
$p'(w'+\Delta') \trans{*} p'(w')$ in $V$ for some $\Delta' \in (\Npos)^3$.
Finally, $V$ is \emph{diagonal} if it is both forward- and backward-diagonal.
Obviously, the vectors $\Delta$ and $\Delta'$ need not be equal in general.



Let  $E=\{e_1, \ldots, e_n\} \subseteq \Z^3$ be the effects of simple cycles of $V$.
We define the (rational) open cone generated by this set
to contain all positive rational combinations of vectors from $E$:
\[
\cone {V} \ = \ \setof{ r_1 \cdot e_1 + \ldots + r_n \cdot e_n }{r_1, \ldots, r_n \in \Qpos} \ \subseteq \ \Lin V.
\]
$\cone V$ is thus an open cone inside $\Lin V$.
A 1-component \tvass $V$ is called \emph{wide} if $(\Qpos)^3 \subseteq \cone V$, i.e.,
if $\cone V$ includes the whole positive orthant.




Let $\Len V s t$ denote the set of lengths of paths $s\tran t$ in $V$.
We need to
argue that there is a nondecreasing polynomial $Q$ 
such that every 1-component \tvass $(V, s, t)$
with a path $s\tran t$, has such path of length at most $Q(M)$, where 
$M=\size(V, s,t)$.
We split the proof into three cases:
\smallskip
\begin{enumerate}
\item
If $(V,s,t)$ is diagonal and wide, we exploit the fact that \tzvass are \plb, and use diagonality and wideness to
lift a short $\Z$-path into a path.
\item
If $(V,s,t)$ is diagonal but non-wide, we show that $(V,s,t)$ is \emph{length-equivalent} to a 
\geomvass $(\essdvass V, \essdvass s, \essdvass t)$ of polynomially larger size, namely 
$\Len V s t = \Len {\essdvass V} {\essdvass s} {\essdvass t}$.
\item
Finally, if $(V, s, t)$ is non-diagonal, we show that $(V,s,t)$ is \emph{length-equivalent} to a set
of three
\geomvass $\{(V_1, s_1, t_1), (V_2, s_2, t_2), (V_3, s_3, t_3)\}$, namely 
$\Len V s t = \Len {V_1} {s_1} {t_1} \cup \Len {V_2} {s_2} {t_2} \cup \Len {V_3} {s_3} {t_3}$
of polynomially larger size.
\end{enumerate}
\smallskip
\noindent
In the two latter cases we rely on the fact that \geomvass are \plb (Lemma \ref{lem:geom-plb}).
In consequence, $Q$ is to be the sum of polynomials claimed in the respective cases.
In the sequel let $(V, s, t)$ be a fixed 1-component \tvass  with $s\tran t$, where
$s=p(w)$ and $t=p'(w')$.

\para{Case 1. $(V, s, t)$ is diagonal and wide}
By diagonality, $p(w) \trans{\pi} p(w+\Delta)$ and
$p'(w'+\Delta')\trans{\pi'} p'(w')$  for some $\Delta,\Delta'\in(\Npos)^3$.

Let $P$ be a nondecreasing polynomial witnessing Lemma \ref{lem:zvass-plb}, i.e.,
\tzvass are \lb by $P$.
As there is a path $s \tran t$ in $V$, there is also a $\Z$-path $s\tran t$, and
by Lemma \ref{lem:zvass-plb} there is a $\Z$-path $s \trans{\sigma} t$ of length at most $P(M)$.
The maximal norm $N$ of $\Z$-configurations along $\sigma$ is thus bounded by $M \cdot P(M)$,
as every step may update counters by at most $M$.

By diagonality, the configuration $p(w+\vec 1)$ is coverable in $V$ from $s$,
and symmetrically the configuration $p'(w' + \vec 1)$ is coverable in $\rev V$ from $t$.
Due to the upper bound of 
Rackoff~\cite[Lemma~3.4]{DBLP:journals/tcs/Rackoff78},
there is a nondecreasing polynomial $R$ such that in every \tvass of size $m$, the length of a covering
path is at most $R(m)$.
Therefore the lengths of 
both paths $p(w) \trans {\pi} p(w+\Delta)$  and $p'(w'+\Delta')\trans {\pi'} p'(w')$ in $V$, 
where $\Delta, \Delta' \in (\Npos)^3$,
may be assumed to be at most $R(M)$.
We argue that there is a cycle 
from the source configuration $p(w)$ 
that increases $w$ by some multiplicity of $\Delta'$:
\begin{lemma} \label{lem:FP}
There is a path $p(w) \trans \delta p(w+ \ell \cdot\Delta')$ of length $R(M)^{\OO(1)}$,
for some $\ell\in\Npos$.
\end{lemma}
Before proving the lemma we use it to complete Case 1.
We build a path $p(w) \tran p'(w')$ by concatenating $3$ paths given below.
The first one is  $\delta$
given by Lemma \ref{lem:FP}.
Note that $\ell$ is necessarily also bounded by $R(M)^{\OO(1)}$.
We replace $\ell$ by its sufficiently large multiplicity to enforce $\ell \geq M\cdot P(M)$, which
makes the length of $\delta$ and $\ell$ only bounded by $P(M) \cdot R(M)^{\OO(1)}$.
The multiplicity guarantees that the $\Z$-path 
$
p(w) \trans{\sigma} p'(w'), 
$
lifted by $\ell \cdot \Delta'$, becomes a path:
\[
p(w+\ell \cdot \Delta') \trans{\sigma} p'(w' + \ell\cdot\Delta'), 
\]
The length of $\sigma$ is bounded by $P(M)$.
Finally, let $\delta' = (\pi')^\ell$ be the $\ell$-fold concatenation of
the cycle $\pi'$:
\[
p'(w'+\ell\cdot\Delta') \trans{\delta'} p'(w').
\]
The length of this path is bounded by $\ell\cdot R(M) \leq P(M)\cdot R(M)^{\OO(1)}$.
We concatenate the three paths, $\tau := \delta; \, \sigma;\, \delta'$, to get a required path
\[
p(w) \trans{\tau} p'(w')
\]
of length bounded by $P(M) \cdot R(M)^{\OO(1)}$.
It thus remains to prove Lemma \ref{lem:FP} in order to complete Case 1.


\begin{proof}\textcolor{red}{TOPROVE 2}\end{proof}



\para{Case 2. $(V, s, t)$ is non-wide}

Every non-zero vector $a=(a_1, a_2, a_3)\in\Z^3$ defines an open half-space
\[
H_a \ = \ \setof{x\in\Q^3}{\innprod a x > 0},
\]
where $\innprod a x = a_1 x_1 + a_2 x_2 + a_3 x_3$ stands for the inner product of 
$x =(x_1, x_2, x_3)$ and $a$.
As $V$ is assumed to be of geometric dimension 3,
$\cone V$  is an intersection of open half-spaces:
\begin{claim} \label{claim:a}
$\cone V$ is an intersection of finitely many open half-spaces $H_a$, with $\norm(a) \leq D := \OO(M^2)$.
\end{claim}


\begin{proof}\textcolor{red}{TOPROVE 3}\end{proof}

As $V$ is non-wide, 
due to Claim~\ref{claim:a} we know that $\cone V$ is a \emph{non-empty} intersection of half-spaces $H_a$.
Therefore for some of these $H_a$ we have
$\cone V \subseteq H_a$, i.e.,
all points $x\in\cone V$ have positive inner product $\innprod a x > 0$.
This implies that
the value of  inner product with $a$ may not decrease along any cycle in $V$:
\begin{claim}\label{clm:inner_with_effect}
The effect $\delta\in\Z^3$ of every simple cycle has nonnegative inner product $\innprod a \delta \geq 0$.
\end{claim}
In consequence, on every path $s \tran t$ the value of inner product with $a$ is polynomially
bounded:
\begin{claim} \label{claim:ax}
Every configuration $q(x)$ on a path from $s$ to $t$ satisfies
$-B \leq \innprod a x \leq B$, where $B := \OO(M\cdot D)$. 
\end{claim}
\begin{proof}\textcolor{red}{TOPROVE 4}\end{proof}

We define a \geomvass $\essdvass V = (\essdvass Q, \essdvass T)$ 
by extending states with the possible values of inner product with $a$
(bounded polynomially by Claim \ref{claim:ax}).
We call $\essdvass V$ the \emph{\mytrim {$a$} {$B$}} of $V$. 
The set of states $\essdvass Q$ contains states of the form $\pair q b$, where $q\in Q$ and $-B \leq b \leq B$,
with the intention that every configuration
$c = q(x)$ of $V$ has a corresponding configuration 
$\essdvass c = \pair q b (x)$ in $\essdvass V$, 
where $\innprod a x = b$.
Therefore, for each transition $(q, v, q') \in T$
and for all $b, b'\in \setfromto{-B} B$
such that $b + \innprod a v = b'$,
we add to $\essdvass T$ the transition
\begin{align} \label{eq:tranV}
\big(\pair q b, v, \pair {q'} {b'}\big).
\end{align}


\begin{claim}\label{clm:trim_makes_geom}
$\essdvass V$ is a \geomvass.
\end{claim}

\begin{proof}\textcolor{red}{TOPROVE 5}\end{proof}
Relying on Claim \ref{claim:ax}, paths $s\tran t$ in $V$ have corresponding paths in $\essdvass V$,
and hence we get:
\begin{claim} \label{claim:lenlen}
$\Len V s t = \Len {\essdvass V} {\essdvass s} {\essdvass t}$.
\end{claim}
Finally, we argue that the size of $\essdvass V$ is bounded polynomially with respect to the size of $V$:
\begin{claim} \label{claim:sizeVV}
$\size(\essdvass V) \leq R(M) = \OO(M\cdot B).$
\end{claim}
\begin{proof}\textcolor{red}{TOPROVE 6}\end{proof}
We are now prepared to complete Case 2.
Let $P$ be the polynomial witnessing Lemma \ref{lem:geom-plb}, i.e.,
\geomvass are \lb by $P$.
As $V$ has a path $s\tran t$, 
By Claim \ref{claim:lenlen}, $\essdvass V$ has a path $\essdvass s \tran \essdvass t$.
By Lemma \ref{lem:geom-plb}, $\essdvass V$ has thus a path $\essdvass s \tran \essdvass t$
of length at most $P(\size(\essdvass V))$, i.e., relying on Claim \ref{claim:sizeVV},
of length at most $P(\OO(M^2\cdot D)) = \OO(P(M^{4}))$.
By Claim \ref{claim:lenlen} again, we get a path $s\tran t$ in $V$ of length
$\OO(P(M^{4}))$.
This completes Case 2.


\para{Case 3. $(V, s, t)$ is non-diagonal}

\Wlog assume that $(V, s)$ is not forward-diagonal (otherwise replace $V$ by $\rev V$).
Therefore for all states $q$ the configuration $s'=q(w+(\vec{M{+}1}))$ is not
coverable from $s=p(w)$. 
Indeed, using strong-connectedness of $V$, if $s'$ were coverable from $s$ then
the configuration $p(w + \vec 1)$ would be coverable form $p(w)$, by 
extending the covering path of $s'$ with an arbitrary shortest path back to state $p$ 
(that cannot decrease a counter by more than $M$), which would contradict forward non-diagonality.

By Lemma \ref{lem:sim-high-d},
in every path from $s$, some coordinate
$j\in\setto 3$ is bounded by $B:=P_3(M, M, M+1)$ (we take $M$ as an upper bound for $n$ and $N$,
relying on $P_3$ being nondecreasing, and take $U=M+1$).
This property allows us, intuitively speaking, to describe all the paths of $V$ by paths of three
\geomvass $V_j$, for $j\in\setto 3$, where $V_j$ behaves exactly like $V$ except that dimension $j$ is additionally kept in state.
Formally, let $V_j := (Q_j, T_j)$, where 
\begin{align*}
Q_j = & \setof{\pair q b}{q\in Q, \ b \in \setfromto 0 B} \\
T_j =  & \setof{(\pair q b, v, \pair {q'}{b'})}{(q, v, q')\in T, \ b' = b + v_j}.
\end{align*}
The source and target configurations in $V_j$ are $s_j = \pair p {w_j}(w)$ and $t_j = \pair {p'}{w'_j}(w')$,
and there is a tight correspondence between paths in $V$ and paths in $V_1, V_2, V_3$:
\begin{claim} \label{claim:nondiag2vass}
$\Len V s t = \Len {V_1} {s_1} {t_1} \cup \Len {V_2} {s_2} {t_2} \cup \Len {V_3} {s_3} {t_3}$.
\end{claim}
The size of each of $V_j$ is bounded polynomially with respect to the size of $V$:
\begin{claim} \label{claim:nondiagsize}
The size of each of $V_j$ is at most $R(M)=\OO(M\cdot B)$.
\end{claim}
Let $P$ be the polynomial witnessing Lemma \ref{lem:geom-plb}.
As $p(w) \tran p'(w')$ in $V$,
by Claim \ref{claim:nondiag2vass}
there is a path $\pair p {w_j}(w) \tran \pair{p'}{w'_j}({w'})$ in $V_j$
for some $j\in\setto 3$.
Therefore, by Lemma \ref{lem:geom-plb} there is such a path of length 
at most $P(R(M))$ which,
again using Claim \ref{claim:nondiag2vass}, implies a path $p(w) \tran p'(w')$ in $V$ of the same length.
This polynomial bound completes Case 3, and hence also the proof of
Lemma \ref{lem:1comp}.
 

\section{\Sandwich reachability sets} \label{sec:tools}
In this section we introduce the crucial concept of \emph{\sandwich} sets.
In order to motivate it, we start by sketching the overall idea of the
proof of Lemma \ref{lem:main} (given in Section \ref{sec:mainproof}). 

Given a finite set $P\subseteq \N^d$ and $B\in\N$, we set:
\begin{align*}
P^* \ =  \ & \setof{p_1 + \ldots + p_k}{k\geq 0, \ p_1, \ldots, p_k \in P} \\
P^{\leq B} \ =  \ & \setof{p_1 + \ldots + p_k}{B\geq k\geq 0, \ p_1, \ldots, p_k \in P}.
\end{align*}
Sets of the form $b + P^* = \setof{b+p}{p\in P^*}$, for $b\in\N^d$ and finite $P\subseteq\N^d$,
are called \emph{linear},
and finite unions of linear sets are called \emph{semi-linear}.


\para{Idea of the proof of Lemma \ref{lem:main}}

Let $V=\ktvass$ be a $k$-component \tvass  that has a path $s=q(w) \tran q'(w')=t$.
If $V$ is diagonal and wide,
we use the pumping cycles $q(w) \tran q(w+\Delta)$ in $V_1$ and
$q'(w'+\Delta') \tran q'(w')$ in $V_k$ to lift a $\Z$-path $s\tran t$, \plb
due to Lemma \ref{lem:zvass-plb}, until it becomes a path
(as in Case 1 in the proof of Lemma \ref{lem:1comp}).


On the other hand, if $V$ is non-diagonal or non-wide, our strategy is to reduce the number of components
by 1, and to rely on the induction assumption for $k-1$,
by replacing the first component $V_1$ 
by one of finitely many \geomvass 
(as in Cases 2 and 3 of the proof of Lemma \ref{lem:1comp}).
Relying on the fact that the reachability sets in a \geomvass are semi-linear \cite{DBLP:conf/icalp/FuYZ24},
the proof could go as follows (yielding however only the
already known \tower upper bound \cite{DBLP:conf/icalp/FuYZ24}).
Using any of the linear sets $L = a +P^*$
describing the set $\reach_{q_2}(V,s)$, where $q_2$
is the source state of the second component $V_2$,
transform $V$ into a $(k-1)$-component \tvass $V'$ by dropping the first component $V_1$
and the first bridge $u_1$, and by adding to the remaining $(k-1)$-component
\tvass $(V_2)u_2 \ldots u_{k-1}(V_k)$ the self-looping transitions
$
(q_2, r, q_2),
$
one for every period $r\in P$.
The source configuration of $V'$ is $s' = q_2(a)$, i.e., its vector is the base of $L$.
The transformation preserves behaviour of $V$.
In one direction, a path $s\tran q_2(x) \tran t$ in $V$ crossing through $q_2(x)$ for 
some  $x\in L$ has a corresponding path $q_2(a) \tran q_2(x)\tran t$ in $V'$.
Conversely, each path $q_2(a) \tran q_2(x) \tran t$ in $V'$
gives rise to a path $s\tran t$ in $V$, by replacing executions of the self-looping transitions
$q_2(a) \tran q_2(x)$
(\mywlog executed in the beginning), by a path $s\tran q_2(x)$ in $V_1$,
bounded polynomially due to Lemma \ref{lem:1comp}.
However, $\size(V')$ may blow-up exponentially with respect to $\size(V)$, as bases and periods
of $L$ are only bounded exponentially, 
and therefore
this approach could only yield a $k$-fold exponential bound on the length of the shortest path
in $k$-component \tvass.



\Sandwich sets are designed as a remedy against the $k$-fold exponential blowup.
The idea is to measure the norms of base and periods of a semi-linear set $L$ 
parametrically with respect to, intuitively speaking, 
the prospective length $B$ of a path $s'\tran t$ in $V'$.
This allows us to control the blow-up of size of $V'$,
also parametrically with $B$, but requires
going outside of semi-linear sets and considering their \emph{$B$-approximations},
namely sets sandwiched between $a+P^{\leq B}$ and $a+P^*$,
good enough for correctness of the above-described transformation
of $V$ to $V'$.
As the outcome, the exponent of our bound on length of the shortest path in $k$-component \tvass
is, roughly speaking, square of the exponent of the respective bound in $(k-1)$-component \tvass. 
For $k$-component \tvass this yields exponent doubly-exponential in $k$, and hence the bound triply-exponential in $k$.
The rigorous reasoning is given in the proof of Lemma \ref{lem:ne} in Section \ref{sec:mainproof}.


\para{\Sandwich sets}

Let $A, B\in \N$.
By a $B$-\emph{approximation}
of a linear set $a + P^*\subseteq \N^d$ we mean any set $S\subseteq \N^d$ satisfying 
$
a + P^{\leq B} \subseteq S \subseteq a+P^*.
$
A set $X\subseteq \N^d$ is \emph{\kanapka {$A$} {$B$}}
if it is a finite union of:

\begin{itemize}
  \item linear sets $a + P^* \subseteq \N^d$ with $\norm(a) \leq B \cdot A$ and
  $\norm(P) \leq A$; and
  \item $B$-approximations of linear sets $a + P^* \subseteq \N^d$ with $\norm(a) \leq A$ and
  $\norm(P) \leq A$.
\end{itemize}


\noindent
Thus $X$ either includes 
$B$-approximation of a linear set $a+P^*$, whose norm of base is bounded by $A$,
or $X$ includes 
a whole linear set $a+P^*$, whose norm of base is only bounded by $B\cdot A$.
In both cases, norms of periods are bounded by $A$.

We say that a class $\C$ of \parvass d is \emph{\parsandwich{$F$}} for a function $F: \N \to \N$,
if for every \vass $(V, s)$ in $\C$, its state $q$,
and $B\in\N$,
the set $\reach_q(V,s)$ is \kanapka {$F(M)$} {$B$}, where $M=\size(V,s)$.
The class $\C$ is \emph{\sandwich} if it is \parsandwich{$F$}, for some nondecreasing 
polynomial $F$.





\begin{figure}[t]
\vspace{-1.5cm}
\begin{minipage}{0.34\textwidth}
\begin{tikzpicture}[scale=0.25]
\usetikzlibrary{automata, positioning}
\scalebox{0.65}{
\node[state] (q1) {$q_1$};
\node[state, right=of q1] (q2) {$q_2$};
\node[state, right=of q2] (q3) {$q_3$};
\node[state, right=of q3] (q4) {$q_4$};

\path[->] (q1) edge [loop above] node[above] {$(-1,2)$} (q1) edge node[above] {$(0,0)$} (q2); 
\path[->] (q2) edge [loop above] node[above] {$(2,-1)$} (q2) edge node[above] {$(0,0)$} (q3);
\path[->] (q3) edge [loop above] node[above] {$(-1,2)$} (q3) edge node[above] {$(0,0)$} (q4);
\path[->] (q4) edge [loop above] node[above] {$(2,-1)$} (q4);
}
\end{tikzpicture}
\end{minipage}
\begin{minipage}{0.32\textwidth}
\begin{tikzpicture}[scale=0.35]
\scalebox{0.65}{
\draw[->, thick] (0, 0) -- (18, 0) node[right] {$x_1$};
\draw[->, thick] (0, 0) -- (0, 10) node[above] {$x_2$};

\draw[step=1, gray, thin] (0, 0) grid (17, 9);

\foreach \x in {1,4,7,10,13,16} \fill[red] (\x,0) circle (7pt);
\foreach \x in {2,5,8,11,14} \fill[red] (\x,1) circle (7pt);
\foreach \x in {0,3,6,9,12} \fill[red] (\x,2) circle (7pt);
\foreach \x in {1,4,7,10} \fill[red] (\x,3) circle (7pt);
\foreach \x in {2,5,8} \fill[red] (\x,4) circle (7pt);
\foreach \x in {0,3,6} \fill[red] (\x,5) circle (7pt);
\foreach \x in {1,4} \fill[red] (\x,6) circle (7pt);
\foreach \x in {2} \fill[red] (\x,7) circle (7pt);
\foreach \x in {0} \fill[red] (\x,8) circle (7pt);

\draw[->] (1,0) -- (0,2) -- (2,1) -- (4,0) -- (3,2) -- (2,4) -- (1,6) -- (0,8) -- (2,7) -- (4,6) -- (6,5) -- (8,4) -- (10,3) -- (12,2) -- (14,1) -- (16,0);
}
\end{tikzpicture}
\end{minipage}
\begin{minipage}{0.32\textwidth}
\begin{tikzpicture}[scale=0.35]
\scalebox{0.65}{
\draw[->, thick] (0, 0) -- (18, 0) node[right] {$x_1$};
\draw[->, thick] (0, 0) -- (0, 10) node[above] {$x_2$};

\draw[step=1, gray, thin] (0, 0) grid (17, 9);

\foreach \x in {1,4,7,10,13,16} \fill[red] (\x,0) circle (7pt);
\foreach \x in {2,5,8,11,14} \fill[red] (\x,1) circle (7pt);
\foreach \x in {0,3,6,9,12} \fill[red] (\x,2) circle (7pt);
\foreach \x in {1,4,7,10} \fill[red] (\x,3) circle (7pt);
\foreach \x in {2,5,8} \fill[red] (\x,4) circle (7pt);
\foreach \x in {0,3,6} \fill[red] (\x,5) circle (7pt);
\foreach \x in {1,4} \fill[red] (\x,6) circle (7pt);
\foreach \x in {2} \fill[red] (\x,7) circle (7pt);
\foreach \x in {0} \fill[red] (\x,8) circle (7pt);

\draw[->,blue,thick] (1,0) -- (4,0);
\draw[->,blue,thick] (1,0) -- (1,3);

\draw[->,blue,thick] (2,1) -- (5,1);
\draw[->,blue,thick] (2,1) -- (2,4);

\draw[->,blue,thick] (0,2) -- (3,2);
\draw[->,blue,thick] (0,2) -- (0,5);
}
\end{tikzpicture}
\end{minipage}
\caption{Left: 4-component \dvass $V_2$. 
Middle: the set $\reach_{q_4}(V_2, q_1(1,0))$ and a path $q_1(1,0) \tran q_4(16,0)$.
Right: bases 
and periods 
of an over-approximating semi-linear set $A+P^*$.}
\label{fig:zigzag}
\end{figure}

\begin{example}
For $k\geq 1$, let $V_k$ be a $(2k)$-component \dvass, where each component has just one state $q_i$
and one transition:
$(q_i, (-1,2), q_i)$ for odd $i$, and $(q_i, (2,-1), q_i)$ for even $i$.
Bridge transitions are $(q_i, (0,0), q_{i+1})$.
Figure~\ref{fig:zigzag} shows $V_2$ (left) and 
a path in $V_2$ from $s = q_1(1,0)$ to $t = q_4(16,0)$ together with 
the reachability set $\reach_{q_4}(V_2, s)$ (middle).
In general,
\begin{align} \label{eq:reachk}
X_k := \reach_{q_{2k}}(V_k, s) \ = \ \set{(x_1,x_2) \mid x_1+2x_2 \leq 4^k, \  x_1+2x_2 \equiv 1 \!\! \mod 3}.
\end{align}
Even if the size of the reachability set is 
exponential in $k$, for small $(x_1, x_2)$ it is periodic and the periods are small.
The set $X_k$ can be over-approximated by $A + P^*$ for $A = \set{(1,0),(2,1),(0,2)}$ and $P = \set{(0,3),(3,0)}$
(shown on the right of Figure~\ref{fig:zigzag}), namely for every $k\geq 1$ and $B\in\N$,
the set $X_k$ is \kanapka {$8$} {$B$}. 
For illustration, consider $Y := X_k \cap ((1,0) + P^*)$.
If $(1,0) + P^{\leq B} \subseteq X_k$ then $Y$ is a $B$-approximation
of $(1,0) + P^*$ with $\norm((1,0)), \norm(P) \leq 3 \leq 8$. 
Otherwise, there is some $(v_1, v_2) \in \big((1,0) + P^{\leq B}\big)\setminus X_k$, and
then $B$ is larger than $4^k$:
\[
4^k < v_1 + 2 v_2 \leq 2(v_1 + v_2) \leq 2(1+3B) \leq 8B.
\]
Therefore by \eqref{eq:reachk}, each $(x_1,x_2) \in Y$ satisfies 
$\norm(x_1,x_2) = x_1 + x_2 \leq x_1 + 2x_2 \leq 4^k < 8B$, and thus
$Y$, seen as a union of singletons, is a union of 
linear sets with norm of base bounded by $8B$ and empty set of periods. 
In both cases, 
$Y$ is \kanapka {$8$} {$B$}. 
\end{example} 
In our subsequent reasoning we rely on the core technical fact:
\begin{lemma}\label{lem:2vass-sandwich}
\dvass are \sandwich.
\end{lemma}

We sketch here the intuition behind Lemma~\ref{lem:2vass-sandwich}, since
it is one of our main technical contributions. We first show that it is enough to show Lemma~\ref{lem:2vass-sandwich}
for a simple class of \dvass, called \dslps, which are of the form $\alpha_0 \beta_1^* \alpha_2 \ldots \alpha_{k-1} \beta_k^* \alpha_k$,
where $\alpha_i$ are fixed sequences of transitions and the loops $\beta_i$ are single transitions. This reduction uses standard techniques,
namely Theorem 1 in~\cite{BlondinFGHM15} stating that the reachability relation of a \dvass can be expressed as a union of reachability relations of a \dlps (\dlps are \dslps without the assumption that $\beta_i$ are single transitions) and Theorem 15 in~\cite{DBLP:conf/lics/EnglertLT16} providing the reduction from \dlps to \dslps. Next, we simplify the \dslps even more, using 
Theorem 4.16 in~\cite{DBLP:conf/focs/0001CMOSW24}, which states that any two vectors reachable by an \dslps can be reached
also by a path of the \dslps of a special form: except a short prefix and suffix it zigzags all the time between configurations close to vertical axis to configurations close to horizontal axis. Thus, to prove Lemma~\ref{lem:2vass-sandwich}
it essentially remains to show polynomial approximability for zigzagging paths.
To achieve that, we roughly speaking
investigate how application of two consecutive loops $\beta \in \N_+ \times \N_-$ and $\beta' \in \N_- \times \N_+$
affects the set of reachable configurations on some vertical line close to the vertical axis. We show that arithmetic sequence
is transformed into a finite union of arithmetic sequences such that the difference is kept at most polynomial in size of the \dslps
and the first term grows additively by at most a polynomial value. All that allows us to conclude that the set of vectors
reachable by zigzagging paths is a union of sets of a form similar to $a + Q^* + P^{\leq T}$ for some $a$, $Q$, $P$ and $T$.
This quite easily implies polynomial approximability.





\begin{appendixproof}[Proof of Lemma~\ref{lem:2vass-sandwich}]
We extend the definition of nondecreasing functions to many-argument ones:
a function $f: \N^k \to \N$ is \emph{nondecreasing} if it is monotonic
in every argument and $f(n_1, \ldots, n_k) \geq n_1 + \ldots + n_k$.
In the sequel we often bound certain quantities polynomially, but an exact polynomial is irrelevant. 
We thus say that a value $n$ is \emph{polynomially bounded} in $n_1, \ldots, n_k$
if there exists a nondecreasing polynomial $P: \N^k \to \N$ such that $n \leq P(n_1, \ldots, n_k)$
for all $n_1, \ldots, n_k \in \N$. 
We also write $n \leq \poly(n_1, \ldots, n_k)$.

\para{Linear path schemes}
A $d$-dimensional \emph{linear path scheme} ($d$-\LPS in short, or \LPS if dimension is irrelevant) 
is a sequential \vass where every component is either trivial (a singleton) or a simple cycle,
i.e., a \vass whose control graph is a simple path with disjoint simple cycles attached to some states of the path.
We write down \LPS in the following form 
\[
\alpha_0\beta_1^* \alpha_1 \cdots \alpha_{k-1} \beta_{k}^* \alpha_k,
\]
where each $\alpha_i$ and $\beta_i$ is  a fixed sequence of transitions. 
Thus the cycles $\beta_i$ of an \lps may be repeated arbitrarily many times (possibly zero). 
An \LPS is \emph{simple} (\SLPS) when all $\beta_i$ are single transitions, i.e.,
each component is either trivial or a single self-loop transition.
When considering the reachability relation in a $d$-\LPS, we often implicitly take the first and the last state
of the \LPS as the source and target state, respectively, and consider the reachability $w\tran w'$ between
vectors $w,w'\in\N^d$ only.






\begin{lemma}\label{lem:two-slps}
For every \dvass $V$ and two its states $q$, $q'$,
there is a finite set $\Gamma$ of \dslps of size polynomially bounded in $\size(V)$,
such that for all $w,w'\in\N^2$,
\begin{align*} \ \ q(w) \tran q'(w') \text{ in } V \ \iff \ w \tran w' \text{ in some  \dslps in } \Gamma.
\end{align*}
\end{lemma}

\begin{proof}\textcolor{red}{TOPROVE 7}\end{proof}









\begin{lemma}\label{lem:slps-sandwich}
\dslps are \sandwich.
\end{lemma}

Before proving Lemma~\ref{lem:slps-sandwich}, we use it together with Lemma~\ref{lem:two-slps}
to prove Lemma~\ref{lem:2vass-sandwich}.
To this aim consider a \dvass $(V, s)$ where $s=p(w)$, and its state $q$, and let $M=\size(V,s)$.
By Lemma~\ref{lem:two-slps} we get a finite set $\Gamma$ of \dslps such that:
\[
\reach_q(V,s) \ = \ \bigcup_{\Lambda \in \Gamma} \reach(\Lambda, w).
\]
Moreover, for some nondecreasing polynomial $F$, every $\Lambda \in \Gamma$ satisfies
$\size(\Lambda) \leq F(M)$.
By Lemma~\ref{lem:slps-sandwich}, there is a nondecreasing polynomial $G$
such that for every $\Lambda \in \Gamma$ and $B\in\N$, 
the set $\reach(\Lambda,w)$
is 
\kanapka {$G(\size(\Lambda,w))$} {$B$}.
Combining the last two statements, we deduce that $\reach_q(V, s)$ is
\kanapka {$G(F(M))$} {$B$} for every $B\in\N$, as required.
Lemma~\ref{lem:2vass-sandwich} is thus proved (once we prove
Lemma~\ref{lem:slps-sandwich}).
\end{appendixproof}

\begin{appendixproof}[Proof of Lemma~\ref{lem:slps-sandwich}]
We generalise finite prefixes $P^{\leq B}$ of $P^*$ as follows.
Let $P = \set{p_1, \ldots, p_m}$. 
For a positive vector $c \in (\Npos)^m$ and $T \in \N$ we define
\[
P^{x \cdot c \leq T} := \setof{\Sigma_{i=1}^m n_i \cdot p_i}{\Sigma_{i=1}^m n_i \cdot c_i \leq T}.
\]
In particular, $P^{\leq T} = P^{x\cdot \vec 1  \leq T}$.
In the sequel, sets of the form
\begin{align} \label{eq:hybrid}
a + P^{x \cdot c \leq T} + Q^*,
\end{align}
for $a\in\N^2$, $c \in (\Npos)^{\card P}$ and $P,Q\subseteqfin \N^2$, 
we call \emph{hybrid} sets.



\begin{lemma}\label{lem:sandwich-raw}
For every \dslps $(\Lambda,s)$,
the set $\reach(\Lambda,s)$ is a finite union of hybrid sets \eqref{eq:hybrid}, 
where $\norm(a),  \norm(c), \norm(P \cup Q)$ are bounded polynomially in $\size(\Lambda,s)$.
\end{lemma}

Before proving Lemma~\ref{lem:sandwich-raw} we use it to prove Lemma~\ref{lem:slps-sandwich}.
We need to argue that there is a nondecreasing polynomial $F$ such that 
for every \dslps $(\Lambda, s)$ and $B\in\N$, the set $\reach(\Lambda,s)$ is
\kanapka {$F(M)$} {$B$}, where $M=\size(\Lambda,s)$.
We fix the nondecreasing polynomial $F(x) = R(x) + R^2(x)$, where $R$ is a polynomial witnessing 
Lemma~\ref{lem:sandwich-raw}, and some arbitrary $B \in \N$,
and prove that each hybrid set $H$ \eqref{eq:hybrid} 
of Lemma~\ref{lem:sandwich-raw} is
\kanapka {$F(M)$} {$B$}.
We distinguish two cases.
If $T \geq R(M) \cdot B$ then, since $\norm(c)\leq R(M)$, we have
\[
a + (P \cup Q)^{\leq B} \ \subseteq \ H \ \subseteq \ a + (P \cup Q)^*,
\]
and $\norm(a), \norm(P \cup Q) \leq R(M) \leq F(M)$, as required. 
On the other hand, if  $T < R(M) \cdot B$ then $H$ is a finite union
of linear sets of the form $u + Q^*$ for $u \in b + P^{c \cdot x \leq T}$, where
\begin{align*}
\norm(u) \ \leq \ \norm(a) + \norm(P) \cdot T 
\ \leq \ R(M) + R(M)^2 \cdot B \leq  F(M) \cdot B,
\end{align*}
as required. 
As before,  $\norm(Q) \leq R(M) \leq F(M)$.
This completes the proof of Lemma~\ref{lem:slps-sandwich} (once
we prove Lemma~\ref{lem:sandwich-raw}). 
\end{appendixproof}



\begin{appendixproof}[Proof of Lemma~\ref{lem:sandwich-raw}]
The proof occupies the rest of this section.
We rely on an insightful characterisation of paths of \slps \cite[Theorem 4.16]{DBLP:conf/focs/0001CMOSW24},
which we state below using a slightly different terminology.
Speaking informally, a \emph{detailing} of an \slps 
$\Lambda = \alpha_0 \beta_1^* \alpha_1 \ldots \alpha_{k-1} \beta_k^* \alpha_k$
is any \slps obtained by fixing exponents of some of the cycles of $\Lambda$.
Formally, a detailing of $\Lambda$ is any $\Lambda'$ obtained by choosing a subset $S \in [1,k]$ and,
for all $i \in S$, by replacing the cycle $\beta_i$ by a path $\beta_i^{n_i}$, for some $n_i\in\N$, 
which becomes an infix of the simple path of $\Lambda'$.
The number of cycles of $\Lambda'$ is thus $k-\card{S}$.
An \dslps is \emph{zigzagging} if the effect of its every cycle $\beta_i$ 
belongs either to the quadrant $\Npos \times (-\Npos)$,
or to the quadrant $(-\Npos) \times \Npos$, and additionally effects of every two consecutive cycles belong 
to different quadrants
(the effects of cycles $\beta_1, \ldots, \beta_k$ thus alternate between quadrants), and the effect of the first cycle belongs to $\Npos \times (-\Npos)$ and the effect of the last cycle belongs to $(-\Npos) \times \Npos$.
Finally, an \slps is \emph{short} if it contains at most three cycles, $k\leq 3$.
For $B\in\N$,
a path 
\[
s_0 \trans{\alpha_0} t_0 \trans{\sigma_1} s_1 \trans{\alpha_1} t_1 \ \cdots \ s_{k-1} \trans{\alpha_{k-1}} t_{k-1} \trans{\sigma_{k}} s_k \trans{\alpha_k} t_k
\]
of an \dslps,
where $\sigma_i \in\beta^*$ for $i\in\setto k$, is called \emph{$B$-close} if all the vectors $x\in \{s_0, t_0, s_1, t_1, \ldots, s_k, t_k\}$,
called \emph{midpoints} below,
are \emph{$B$-close} to some axis, namely either $x\in \setfromto 0 B \times \N$ or 
$x\in \N\times\setfromto 0 B$.

\begin{theorem}[Thm 4.16 in~\cite{DBLP:conf/focs/0001CMOSW24}]\label{thm:2slps-zigzag}
For every \dslps $\Lambda$ there is $B\leq \poly(\size(\Lambda))$
such that for every path $s \tran t$ in $\Lambda$ 
there is a detailing $\Lambda' = \Lambda_1 \Lambda_2 \Lambda_3$ of $\Lambda$  
of $\size(\Lambda')\leq \poly(\size(\Lambda))$ and $u, u' \in \setfromto 0 B \times \N$ such that
\begin{enumerate}
\item $\Lambda_1$ and $\Lambda_3$ are short, 
  \item $\Lambda_2$ is zigzagging,
  \item there are paths $s \tran u$ in $\Lambda_1$, 
  a $B$-close path $u \tran u'$ in $\Lambda_2$, and 
  $u'\tran t$ in $\Lambda_3$.
\end{enumerate}
\end{theorem}

Fix in the sequel $B$ given by Theorem~\ref{thm:2slps-zigzag}.
There are only finitely many detailings $\Lambda'$ of $\Lambda$ of a bounded size,
only finitely many possible decompositions of $\Lambda'$ into $\Lambda_1$, $\Lambda_2$ and $\Lambda_3$,
and only finitely many values of $u_1, u'_1\in\setfromto 0 B$.
By Theorem~\ref{thm:2slps-zigzag}, vectors $t$ reachable from $s$ in $\Lambda$ are exactly those
reachable from $s$ in some of detailing $\Lambda'$.
Therefore it is enough
to show Lemma~\ref{lem:sandwich-raw} for the set of vectors $t\in\N^2$ reachable by paths as in point 3 above,
in a fixed \slps $(\Lambda',s)$, where $\Lambda' = \Lambda_1 \Lambda_2 \Lambda_3$ satisfies points 1, 2 above,
and where $u_1 = b$ and $u'_1 = b'$ for some fixed $b,b'\in\setfromto 0 B$.

In a path $u\tran u'$, every second midpoint is $B$-close to one axis,
say $x\in \setfromto 0 B \times \N$,
while the remaining midpoints are $B$-close to the other one.
We relax this requirement slightly, by dropping the latter condition.
A path $u \tran u'$  in the zigzagging \slps $\Lambda_2$
is \emph{$B$-vertical-close} if $u$, $u'$ and every second midpoint $x$
are $B$-close to the vertical axis, namely $x \in \setfromto 0 B \times \N$
(thus the remaining endpoints on the path do not have to be $B$-close to the horizontal axis).
In order to have more flexibility in the proof of Lemma~\ref{lem:sandwich-raw},
in the sequel we consider those paths in $\Lambda'$, as in point 3 in Theorem~\ref{thm:2slps-zigzag}, where the infix
$u\tran u'$ is $B$-vertical-close but not necessarily $B$-close.
Notice that by relaxing the condition to $B$-vertical-closeness
we enlarge the set of considered paths, but do not enlarge the set of reachable points,
as every $t$ such that $s \tran t$ is already reachable by the paths with the middle path being even $B$-close.
We denote by $\reach(\Lambda', s)$ the set of all vectors $t\in\N^2$ reachable by such a path $s\tran t$ with
the middle part being $B$-vertical-close.

We formulate below Claims \ref{cl:prefix}, \ref{cl:infix} and \ref{cl:suffix}
(taking care of a prefix, infix, and suffix, respectively, of a path $s\tran t$), 
show how they imply Lemma~\ref{lem:sandwich-raw}, and finally proceed with the proofs of the three claims.
To this aim we introduce some more notation.
Given a start $a \in \N$, a difference $r \in \N$, and a bound $T \in \N_\infty = \N\cup\{\infty\}$,
the set $a + \{r\}^{\leq T}$ is called \emph{$(a, r, T)$-arithmetic}. 
We omit brackets and write $a + r^{\leq T}$.
In particular, $a + r^{\leq 0} = \{a\}$.
A \dslps  $\alpha_1 \beta_1^* \alpha_2 \beta_2^*$ is \emph{one-turn} if 
$\eff(\beta_1) \in \Npos  \times -\Npos$ and $\eff(\beta_2) \in -\Npos  \times \Npos$
(it is thus a special case of short zigzagging \dslps).
For a set $S\subseteq \N^2$, we use the notation $\reach(\Lambda, S) = \bigcup_{s\in S} \reach(\Lambda, s)$.

In Claims \ref{cl:prefix}, \ref{cl:infix} and \ref{cl:suffix}, we focus on source/target vectors
in $\setfromto 0 B \times \N$ and, intuitively speaking, on arithmetic subsets of each 'line' $\{b\}\times \N$.
First, Claim \ref{cl:prefix} states that the reachability set of a short \dslps, intersected with each line,
is a finite union of arithmetic sets.
Second, Claim \ref{cl:infix} states that the reachability set of a one-turn \dslps from 
an arithmetic set inside a line, intersected with another line, is a finite union of arithmetic sets.
Importantly, the starting point grows only additively, by a polynomially bounded amount, 
as we will apply Claim \ref{cl:infix} $\OO(k)$ times.
Finally, Claim \ref{cl:suffix} states that the reachability set of a short \dslps, from an arithmetic set
inside a line, is a finite union of hybrid sets.
All quantities in the claims are bounded polynomially.

\begin{claim}\label{cl:prefix}
For every short \dslps $(\Lambda,s)$ 
and $u_1 \in [0,B]$,
the set $\{u_2 \mid (u_1, u_2) \in \reach(\Lambda,s)\}$ is a finite union of $(a, r, T)$-arithmetic sets, where
$a \leq \poly(B,M)$, $r \leq \poly(M)$, and $M=\size(\Lambda,s)$.
\end{claim}
\begin{claim}\label{cl:infix}
Let $\Lambda$ be a one-turn \dslps,
and $S_1 = a + r^{\leq K}$ for some $a, r, K \in \N$.
Let $u_1, v_1 \in [0, B]$.
The set $R(S_1) := \{v_2 \mid \exists_{u_2 \in S_1} (u_1, u_2) \tran (v_1, v_2) \text{ in } \Lambda\}$
is a finite union of $(a', r', T')$-arithmetic sets with
$a' \leq a + \poly(B,M,r)$ and $r' \leq \max(\poly(M),r)$, where $M=\size(\Lambda)$.
\end{claim}

\begin{claim}\label{cl:suffix}
For every short \dslps $\Lambda$ and $u= (u_1, u_2), p = (p_1, p_2)\in\N^2$, 
the set $\reach(\Lambda, u + \set{p}^{\leq T})$
is a finite union of hybrid sets \eqref{eq:hybrid},
where $\norm(a), \norm(c), \norm(P), \norm(Q) \leq \poly(\size(\Lambda), \norm(u),\norm(p))$.
\end{claim}

We use the three  claims to derive Lemma~\ref{lem:sandwich-raw}.
As said above,
we consider a fixed \slps $\Lambda' = \Lambda_1 \Lambda_2 \Lambda_3$ and source $s\in\N^2$,
and focus on the set $\reach(\Lambda', s)$ of vectors $t\in\N^2$ such that
there are paths 
\begin{align} \label{eq:paths}
\text{$s \tran u$ in $\Lambda_1$,  \ \  
a $B$-vertically close path $u \tran u'$ in $\Lambda_2$, \ \ 
and   $u'\tran t$ in $\Lambda_3$,}
\end{align}
for some $u,u'\in \setfromto 0 B \times \N$, where 
$u_1 = b$ and $u'_1 = b'$ are fixed.
Let $M':=\size(\Lambda',s) \leq \poly(M)$.
First, by Claim~\ref{cl:prefix}, the set
$\{u_2 \mid (u_1, u_2) \in \reach(\Lambda_1,s)\}$ is a finite union of $(a, r, T)$-arithmetic sets,
where $a, r$ are bounded polynomially in $M'$ and $B$.
Second,
a path $u\tran u'$ is a concatenation of $\ell\leq \size(\Lambda_2) \leq \poly(M')$
paths of one-turn \slps. 
By $\ell$-fold application of Claim~\ref{cl:infix}, the set
$\{u'_2 \mid (u'_1, u'_2) \in \reach(\Lambda_1 \Lambda_2,s)\}$
is a finite union of arithmetic sets
$a' + (r')^{\leq T'}$, where
$a', r' \leq \poly(\size(\Lambda_2)) \leq \poly(M')$.
Indeed, the bound on $a'$ comes from $\ell$-fold addition of values bounded by 
$\poly(B, \poly(M'), r)\leq \poly(B, \poly(M'), \poly(M'))$,
itself bounded by $\poly(M')$:
\begin{equation}\label{eq:aprim}
a' \leq a + \ell \cdot \poly(M') \leq a + \poly(M') \leq \poly(M').
\end{equation}
Finally, by Claim~\ref{cl:suffix} the set $\reach(\Lambda',s)$ is a finite union of hybrid sets \eqref{eq:hybrid},
where
$
\norm(a)$, $\norm(c)$, $\norm(P \cup Q) \leq \poly(M', B) \leq \poly(M).
$ 
We conclude the proof of Lemma~\ref{lem:sandwich-raw}, keeping in mind that
it still remains to demonstrate Claims~\ref{cl:prefix},~\ref{cl:infix},~and~\ref{cl:suffix}.

\medskip

Here is  a corollary of Lemma~\ref{lem:taming}, useful in the proofs of the three claims:
\begin{lemma}\label{lem:solutions}
Consider a system $A\cdot x = b$ of $m$ Diophantine linear equations with $n$ unknowns,
where absolute values of coefficients are bounded by $N$.
Then, the set of solutions is of a form $U+P^*$, where
$\norm(U \cup P) \leq \poly(nN)^{\poly(n,m)}$.
\end{lemma}

\begin{proof}\textcolor{red}{TOPROVE 8}\end{proof}
In the sequel we apply Lemma~\ref{lem:solutions} in case when $n$ and $m$ are constants,
in which case Lemma \ref{lem:solutions} yields the bound $\norm(U+P) \leq \poly(N)$.

\begin{proof}\textcolor{red}{TOPROVE 9}\end{proof}



\begin{proof}\textcolor{red}{TOPROVE 10}\end{proof}



 

\begin{proof}\textcolor{red}{TOPROVE 11}\end{proof}
Claims \ref{cl:prefix}, \ref{cl:infix} and \ref{cl:suffix} are thus shown, and hence so is Lemma~\ref{lem:sandwich-raw}.
\end{appendixproof}
 
In the proof of Lemma~\ref{lem:main} we actually need polynomial approximability not only for \dvass, but also for
its generalisation, \geomvass. It is stated below and shown in the Appendix using Lemma~\ref{lem:2vass-sandwich}.

\begin{lemma} \label{lem:geom-sandwich}
\Geomvass are \sandwich.
\end{lemma}
\begin{appendixproof}[Proof of Lemma~\ref{lem:geom-sandwich}]
Fix an arbitrary \geomvass $(V, s)$ and let $M = \size(V,s)$.
Norms of vectors generating $\cone V$ --- i.e., effects of simple cycles --- are at most $M$, 
as no transition repeats along a simple cycle.
The effect $\delta \in \Z^3$  of each simple cycle
satisfies $\innprod a \delta = 0$, where $a\in\Z^3$ is a vector orthogonal to $\Lin V$,
or equivalently, orthogonal to some two effects of simple cycles.
The vector $a$ is thus an integer solution of a system of 2 linear equations with 3 unknowns,
where absolute values of coefficients are bounded by $M$.
By Lemma \ref{lem:taming}, there is such an integer solution 
$a=(a_1, a_2, a_3)$ with $\norm(a)\leq D=\OO(M^2)$.


In consequence, on every path $s \tran t$ the value of inner product with $a$ is bounded polynomially
with respect to $M$:
\begin{claim} \label{claim:axx}
Every configuration $q(x)\in \reach(V,s)$  satisfies
$-C \leq \innprod a x \leq C$, where $C = \OO(M\cdot D)$. 
\end{claim}


We rely on the construction of \cite[Lemma 5.1]{Zhang-geom}, which transforms a 
\geomvass $(V,s )$ into a \dvass $(\essdvass V, \essdvass s)$ of size at most $R(M)$
for some polynomial $R$, by dropping on of dimensions of $V$.

\para{Case I: $a$ contains both positive and negative numbers}
\Wlog assume that $a_1, a_2 \geq 0$ and $a_3<0$,
in which case it is the third coordinate which is dropped 
by the construction of \cite[Lemma 5.1]{Zhang-geom}.
States of $\essdvass V$ are of the form $\pair q c$, where $q\in Q$ and $c\in\setfromto {-C} C$, 
plus some further auxiliary states, omitted here.
Due to Claim \ref{claim:axx},
there is a one-to-one correspondence between
reachable configurations in $V$ and reachable configurations in $\essdvass V$:
\[
e = q(x_1, x_2, x_3) \quad \longmapsto \quad
\essdvass e = \pair q c(x_1, x_2), 
\qquad
\text{ where } c = \innprod a x.
\]
The tight correspondence between paths of $V$ and $\essdvass V$,
 given in Claim \ref{claim:V321} below, is essentially 
Lemma 5.1 of \cite{Zhang-geom}:
\begin{claim} \label{claim:V321}
For every configurations $s,u$,
here is a path $s \tran u$ in $\essdvass V$
if, and only if,
there is a path $\essdvass s \tran \essdvass u$ in $\essdvass V$.
\end{claim}
By Lemma \ref{lem:2vass-sandwich}, there is a polynomial $F$ such that 
for every $B\in\N$,
in the \dvass
$(\essdvass V, \essdvass s)$ obtained by the above construction, 
for every its state $\pair q c$, the set 
$\reach_{\pair q c}(\essdvass V, \essdvass s)$ is \kanapka {$F(M')$} {$B$}, where
$M'=\size(\essdvass V, \essdvass s) \leq R(M)$, and hence also
\kanapka {$F(R(M))$} {$B$}.
We claim that for every state $q\in Q$, for every $B\in\N$, 
the set $\reach_q(V,s)$ is \kanapka {$G(F(R(M)))$} {$B$}, for some nondecreasing polynomial $G$.
Indeed, for any $B\in\N$, any ($B$-approximation of) a linear set 
$L = w + P^*\subseteq \N^2$, where $w=(w_1, w_2)$, witnessing that
$\reach_{\pair q c}(\essdvass V,\essdvass s)$  is \kanapka {$F(R(M))$} {$B$}
is transformed to a ($B$-approximation of) linear set $L'$ witnessing that
$\reach_{q}(V,s)$  is \kanapka {$G(F(R(M)))$} {$B$}, as follows.
Take as base the unique vector $w'=(w_1, w_2, w_3)$ such that $a_1 w_1 + a_2 w_2 + a_3 w_3 = c$.
For every period $p=(p_1, p_2) \in P$, take into the set $P'$  the unique vector
$p'=(p_1, p_2, p_3)$ such that $a_1 p_1 + a_2 p_2 + a_3 p_3 = 0$.
Since $a_3>0$, it is guaranteed that $p_3 \geq 0$, and therefore $p'\in\N^3$.
Let the polynomial $G$ bound the blowup of $\norm(b')$ with respect to $\norm(b)$, and 
$\norm(p')$ with respect to $\norm(p)$, for instance
$G(x) = M \cdot x + B$.
The union of all ($B$-approximations of) 
so described sets $L' = w' + (P')^*$, for all $c\in\setfromto {-C} C$, provides the witness that
$\reach_{q}(V,s)$ is \kanapka {$G(F(R(M)))$} {$B$}.

\para{Case II: $a$ is non-negative or non-positive}
\Wlog assume $a\geq \vec 0$ and $a_3 > 0$.
By Claim \ref{claim:axx}, for each $q(x) \in \reach(V,s)$
we thus have $x_3 \leq C$.
We transform $(V,s)$ into $(\essdvass V, \essdvass s)$ 
with states of the form $\pair q c$, where $q\in Q$ and $c\in\setfromto {0} C$, 
by storing the third coordinate in state:
\[
e = q(x_1, x_2, x_3) \quad \longmapsto \quad
\essdvass e = \pair q c(x_1, x_2), 
\qquad
\text{ where } c = x_3.
\]
As above, $\size(\essdvass V, \essdvass s) \leq R(M)$, for a polynomial $R$.
The argument  that for every $B\in\N$,
the set $\reach_{q}(V,s)$ is \kanapka {$G(F(R(M)))$} {$B$}, is similar to Case I (but simpler).
\end{appendixproof}

 


\section{Proof of Lemma~\ref{lem:main}}\label{sec:mainproof}


In this section we prove Lemma \ref{lem:main}, 
by induction on $k$.
The base of induction, when $k=1$, follows by Lemma \ref{lem:1comp}:
 1-component \tvass are \plb. Before engaging in the induction step
we need to generalise wideness, defined up to now for 1-component \tvass only,
to all sequential \tvass.


\para{Sequential cones}

Consider a $k$-component \tvass $V=\ktvass$.
By a \emph{cascade} we mean a tuple of $k$ vectors $(v_1, \ldots, v_k)$  
such that the partial sum $v_1 + \ldots + v_i \in (\Qpos)^3$ for every $i\in\setto k$.
Then the \emph{sequential cone} of $V$, denoted $\seqcone V$, is the set of 
sums of all cascades $(v_1, \ldots, v_k)$ 
whose every $i$th vector $v_i$ belongs to $\cone{V_i}$: 
\[
\seqcone V = \{v_1 + \ldots + v_k \mid (v_1, \ldots, v_k) \in \cone{V_1} \times \ldots \times \cone{V_k} 
\text{ is a cascade}\}.
\]
\vspace{-0.7cm}
\begin{claim} \label{claim:seqcone}
If $\Lin V$ is 3-dimensional then $\seqcone V$ is a finitely generated open cone.
\end{claim}
\begin{appendixproof}[Proof of Claim \ref{claim:seqcone}]
$\seqcone V$ is equivalently definable as the last element $C_k$ of the sequence
of (rational) open cones $C_1, \ldots, C_k$, defined as follows.
We put $C_1 := \cone{V_1}\cap (\Qpos)^3$,
and for $i > 1$ we define inductively:
\[
C_{i} \ := \ \big(C_{i-1}\  + \ \cone{V_{i}}\big) \cap (\Qpos)^3,
\]
where the addition is Minkowski sum $X+Y = \setof{x+y}{x\in X, y\in Y}$.
Then all $C_1, \ldots, C_k$ are finitely generated open cones, as $(\Qpos)^3$ is such
a cone,  
and Minkowski sum and intersection preserve finitely generated open cones.
\end{appendixproof}
We prove the fundamental property:
all reachable configurations are at close distance to the sequential cones.
We focus on \tvass, but actually the same proof works for \vass in any other fixed dimension.
Below, let $d(x,y)$ denote Euclidean distance between $x$ and $y$, and let $d(x,S)$ denote 
the distance between $x$ and a set $S$, that is $d(x,S) = \inf \setof{d(x,y)}{y \in S}$. 
\begin{lemma}\label{lem:not_far_from_cone}
There exists a nondecreasing polynomial $P$ such that 
each reachable configuration $q(w)$
in a forward-diagonal sequential \tvass $(V,s)$,  satisfies
$d(w, \seqcone V) \leq P(\size(V,s))$.
\end{lemma}

\begin{proof}\textcolor{red}{TOPROVE 12}\end{proof}
We say that a $k$-component \tvass $V$ is \emph{wide} if $(\Qpos)^3 \subseteq \seqcone V$
or $(\Qpos)^3 \subseteq \seqcone {\rev V}$.
For $k=1$, the definition relaxes the definition of Section \ref{sec:1comp}. 



\begin{proof}\textcolor{red}{TOPROVE 13}\end{proof}


The proof of Lemma \ref{lem:dw} generalises Case 1 of the proof of Lemma \ref{lem:1comp}.
The proof of Lemma \ref{lem:ne} makes crucial use of \sandwich sets introduced
in Section \ref{sec:tools}, and builds on 
Lemma \ref{lem:len-eq}, stated below, whose proof 
generalises Cases 2 and 3 of the proof of Lemma \ref{lem:1comp}.


\begin{appendixproof}[Proof of Lemma \ref{lem:dw}]
Consider a $k$-component \tvass  $V = \ktvass$,
where $V_i = (Q_i, T_i)$ and $u_i = (p'_i, \delta_i, p_{i+1})$,
together with source and target configurations: 
$s=p_1(w)$ in $V_1$ and $t=p'_k(w')$ in $V_k$.
Let $M = \size(V, s, t) = \size(V) + \norm(s) + \norm(t)$.

Suppose $(V, s, t)$ is diagonal and wide, say $(\Qpos)^3 \subseteq \seqcone{V}$.
We have
$p_1(w) \trans\pi p_1(w+\Delta)$ and
$p'_k(w'+\Delta')\trans{\pi'} p'_k(w')$  for some $\Delta,\Delta'\in(\Npos)^3$, and 
$(\Qpos)^3 \subseteq \seqcone V$.


Let $P$ be a nondecreasing polynomial witnessing Lemma \ref{lem:zvass-plb}, i.e.,
\tzvass are \lb by $P$.
As $V$ has a path $s \tran t$, it also has a $\Z$-path $s\tran t$.
By Lemma \ref{lem:zvass-plb}, $V$ has a $\Z$-path $s \trans{\sigma} t$ of length at most $P(M)$.
The $\Z$-path factorises into components:
\begin{align} \label{eq:Zpath}
\sigma \ = \ 
\sigma_1;\, u_1; \, \ldots; \, \sigma_{k-1}; \, u_{k-1}; \, \sigma_k.
\end{align}
As in Case 1 of the proof of Lemma \ref{lem:1comp},
let $R$ be a nondecreasing polynomial  such that in every \tvass of size $m$, the length of a covering
path is at most $R(m)$~\cite[Lemma~3.4]{DBLP:journals/tcs/Rackoff78}.
We generalise Lemma \ref{lem:FP} and prove that certain multiplicity of $\Delta'$
may be obtained by executing first a cycle in $V_1$, then a cycle in $V_2$, and so on,
and finally a cycle in $V_k$, so that the total effect of the first $j$ cycles is in $(\Npos)^3$,
for every $j\in\setto k$,
and the lengths of all the cycles are bounded by a polynomial of degree $\OO(k)$:
\begin{lemma} \label{lem:FPgen}
There is an integer cascade $(\Delta'_1, \ldots, \Delta'_k)$ and $\ell\in\Npos$ such that
$\Delta'_1 + \ldots + \Delta'_k = \ell\cdot\Delta'$, 
and for $j\in\setto k$ there are paths
\[
p_j(w+\Delta'_1 + \ldots + \Delta'_{j-1}) \trans {\pi_j}  p_j(w+ \Delta'_1 + \ldots + \Delta'_{j})
\]
in $V_j$
of length $R(M)^{\OO(k)}$.
\end{lemma}
\begin{proof}\textcolor{red}{TOPROVE 14}\end{proof}

We now use Lemma \ref{lem:FPgen} to complete the proof of Lemma \ref{lem:dw}.
Note that $\ell$ in Lemma \ref{lem:FPgen} is necessarily also bounded by $R(M)^{\OO(k)}$, and that
for every $m\in\Npos$ the $m$-fold iteration of the cycle $\pi_j$ is also a path:
\begin{align}\label{eq:mfold}
p_j(w+m\cdot(\Delta'_1 + \ldots + \Delta'_{j-1})) \trans {(\pi_j)^m} p_j(w+ m\cdot(\Delta'_1 + \ldots + \Delta'_{j})).
\end{align}
We pick an $m\in \Npos$ and 
build a path $\rho$
by interleaving the $\Z$-path \eqref{eq:Zpath} with
$m$-fold iterations of the cycles $\pi_1, \ldots, \pi_k$ of Lemma \ref{lem:FPgen}:
\[
\rho \ = \ (\pi_1)^m;\, \sigma_1;\ u_1; \ \ldots; \ \ (\pi_{k-1})^m;\, \sigma_{k-1};\ u_{k-1}; \ (\pi_k)^m;\, \sigma_k;  \]
As the effect of $(\pi_j)^m$ is $m\cdot \Delta'_j$, and the effect of $\sigma$ is $w'-w$,
we have:
\[
p_1(w) \trans{\rho} p'_k(w'+m\ell\cdot \Delta').
\]
We choose $m$ sufficiently large to enforce that each of $\Z$-paths $\sigma_j$
becomes a path, and hence the whole $\rho$ is a path as well.
It is enough to take 
 $m = M\cdot P(M)$, which
makes the length of $\rho$ bounded by $P(M) \cdot R(M)^{\OO(k)}$.
Finally, we concatenate $\rho$ with the $m\ell$-fold iteration of the path $\pi'$,
\[
p'_k(w' + m\ell\cdot \Delta') \trans{(\pi')^{m\ell}} p'_k(w'),
\]
to get the required path $\rho;\, (\pi')^{m\ell}$
from $p_1(w)$ to $p'_k(w')$
of length bounded by $M\cdot P(M) \cdot R(M)^{\OO(k)} \leq
(M\cdot P(M)\cdot R(M)^{\OO(1)})^k \leq M^{\OO(k)}$.
This completes the proof of Lemma \ref{lem:dw}. \end{appendixproof}


For stating and proving Lemma \ref{lem:len-eq} we need a variant of sequential \tvass:
a \emph{good-for-induction} $k$-component \tvass $V=\ktvass$ is defined exactly like $k$-component
sequential \tvass, except that the first component $V_1$ is an arbitrary \geomvass,
not necessarily being strongly connected.
\begin{lemma} \label{lem:len-eq}
There is a nondecreasing polynomial $R$ such that 
every non-easy $k$-component \tvass $(V, s, t)$ is length-equivalent to a finite set $S$ of good-for-induction
$k$-component \tvass
of size at most $R(\size(V,s,t))$, namely
$\Len V s t = \bigcup_{(V', s', t')\in S} \Len {V'} {s'} {t'}$.
\end{lemma}


\begin{appendixproof}[Proof of Lemma \ref{lem:len-eq}]
Consider a non-easy $k$-component \tvass $V = \ktvass$, together with
source and target configurations $s = p_1(w)$ and $t=p'_k(w')$.
If $V_1$  is a \geomvass, there is nothing to prove as $V$ is good-for-induction.
If $\rev{(V_k)}$ is a \geomvass then we are done too, as $\rev V$ is good for induction and 
$\Len V s t = \Len{\rev V} t s$.
Therefore we assume from now on that $V_1$ and $\rev{(V_k)}$ are of geometric dimension 3. 
In consequence, by Claim \ref{claim:seqcone}, all of $\cone {V_1}, \seqcone V$, $\cone{\rev{(V_k)}}$, $\seqcone{\rev V}$ are
3-dimensional open cones.
We distinguish two cases, and hence the polynomial $R$ is the sum of polynomials claimed
in the respective cases.

\para{Case I: $(V, s, t)$ is non-diagonal}
We may assume \mywlog that $V$ is non-forward-diagonal (otherwise replace $V$ by $\rev V$),
and therefore $V_1$ is so.
Exactly as in Case 3 of the proof of Lemma \ref{lem:1comp}, we transform
$(V_1,s)$ into
three \geomvass $(\essdvass V_1, s_1), (\essdvass V_2, s_2), (\essdvass V_3, s_3)$.
In each $(\essdvass V_i, s_i)$, we replace the target state $p'_1$ by
$\pair {(p'_1)} b$, for an arbitrarily chosen value $b\in\setfromto 0 B$ of the bounded coordinate,
and modify accordingly the first bridge transition $u_1 = (p'_1, \delta_1, p_2)$ to 
$\essdvass u_{i, b} = (\pair{(p'_1)} b, \delta_1, p_2)$.
This yields a set $S$ of $3(B+1)$ good-for-induction $k$-component \tvass  
\[
S \ = \ \setof{\big(\ktvassmod, s_i, t \big)}{i\in\setto 3, \ b\in \setfromto 0 B},
\]
which is length-equivalent to $(V, s, t)$, as required. 
The size of each of these \tvass is
at most $R(M)$, as in Claim \ref{claim:nondiagsize} in Case 3 of the proof of Lemma \ref{lem:1comp}.

\para{Case II: $(V, s, t)$ is non-wide}
We proceed similarly to Case 2 of the proof of Lemma \ref{lem:1comp}, and transform
$(V_1,s)$ into a \geomvass $(\essdvass V, \essdvass s)$, defined as a \mytrim {$a$} {$B$} of $V_1$
for some vector $a\in\Z^3$ and $B\in\N$.
To this aim we need an analog of Claim \ref{claim:ax} (Claim \ref{claim:axgen} below).
\begin{claim}\label{claim:empty_intersection}
$C_1 :=  \cone{V_1}$ and $S := \seqcone{\rev V}$ are disjoint.
\end{claim}

\begin{proof}\textcolor{red}{TOPROVE 15}\end{proof}
\begin{claim} \label{claim:onefacet}
Let $C\subseteq \Q^3$, $C'\subseteq (\Qpos)^3$ be 3-dimensional disjoint open cones, and $D\in\Qpos$. 
All points whose distance to both cones is at most $D$,
are at distance at most $3D$ to one of facet planes of $C$.
\end{claim}
\begin{proof}\textcolor{red}{TOPROVE 16}\end{proof}
Let $B:=9\cdot D^2 \cdot P(M)^2$, where $P$ comes from Lemma \ref{lem:not_far_from_cone} and
$D\leq \OO(M^2)$ from Claim \ref{claim:a}.
\begin{claim} \label{claim:axgen}
There is a vector $a\in\Z^3$ of $\norm(a)\leq D$ such that
all configurations $q(x)$ in $V_1$ appearing on a path $s\tran t$ in $V$ satisfy
$-B \leq \innprod a x \leq B$.
\end{claim}
\begin{proof}\textcolor{red}{TOPROVE 17}\end{proof}
We complete the proof of Case II as in Case 2 of the proof of Lemma \ref{lem:1comp}.
We replace the first component $V_1$ by the \geomvass $\essdvass V$, as defined there,
of size $E = \OO(M\cdot B)$ (as stated in Claim \ref{claim:sizeVV}),
and the source configuration $s$ by $\essdvass s$.
We also replace the first bridge transition $u_1 = (p'_1, \delta_1, p_2)$ by
$\essdvass u_{b} = (\pair{(p'_1)} b, \delta_1, p_2)$, for any $b\in\setfromto{-B} B$.
This yields a set $S$ of $2B+1$ good-for-induction $k$-component \tvass
\[
S \ = \ \setof{\big(\ktvassmodmod, \essdvass s_a, t \big)}{a\in A, \ b\in \setfromto {-B} B},
\]
which is length-equivalent to $(V, s, t)$, as required. 
The size of each of these \tvass is at most $R(M) = E+M \leq \OO(M \cdot B)$.
\end{appendixproof}



\begin{proof}\textcolor{red}{TOPROVE 18}\end{proof}
 

\section{Future research}\label{sec:future}
Below we list a few research questions, which we find interesting and
particularly promising directions after our contribution.

\para{Exact complexity for $3$-VASS}
We have shown that shortest paths in binary $3$-VASS are of at most triply-exponential length.
It is tempting to conjecture that actually the upper bound for the length of the paths is shorter,
at most doubly-exponential. We conjecture that it is possible with techniques similar to the developed ones,
but with more focus on polynomials growing linearly with respect to norms of source and target.
We leave proving this conjecture to the future research.

\para{Example of a $3$-VASS with doubly-exponential path}
We have shown that shortest paths in binary $3$-VASS are of at most triple-exponential length.
However, currently we still do not know any example in which even a path of doubly-exponential length is needed,
it might be that paths of exponential length are sufficient leading to \pspace-completeness for binary $3$-VASS.
It would be very interesting to find an example of a binary $3$-VASS with shortest path between two configurations
being doubly exponential. An example of binary $4$-VASS of doubly-exponential shortest path is known (see Section 5 in~\cite{DBLP:conf/concur/Czerwinski0LLM20}). Maybe some modification of this $4$-VASS would allow to design a $3$-VASS with similar properties.

\para{Reachability for $d$-VASS with $d \geq 4$}
It is a natural question whether our techniques extend to higher dimensions.
The answer is: possibly yes, but we would need a few other structural results for $3$-VASS
to make a similar approach to $4$-VASS possible. In the proof of Lemma~\ref{lem:main} we do not only
use $2$-VASS reachability as a black box, but we use a deep understanding of the reachability relation in $2$-VASS
from~\cite{DBLP:conf/focs/0001CMOSW24}. Probably a similar understanding of the reachability relation for $3$-VASS would be needed
to advance understanding of $4$-VASS along our lines. 

In general it is very interesting to determine the complexity of the reachability problem for $d$-VASS.
We have excluded that for each $d \geq 3$ the problem is $\F_d$-completely, but it is still possible that
the problem is $\F_{d-C}$-complete for some constant $C \in \N$ and $d$ big enough.
Recall that in~\cite{DBLP:conf/fsttcs/CzerwinskiJ0LO23}
it was shown that the reachability problem for $(2d+4)$-VASS is $\F_d$-hard for any $d \geq 3$ and this
is the best currently known lower bound for arbitrary dimension.
Therefore the other natural possibility is that the reachability problem for $(2d+C)$-VASS is $\F_d$-complete for some
constant $C \in \N$. 

\para{Applications of the approximation technique}
Another natural research direction is to search for other applications of the technique of approximating the reachability sets,
which allows to lower the complexity down, below the size of the reachability set.
One particular case, which seems to be prone to such techniques is the $2$-VASS with some number of $\Z$-counters, namely counters, which can take values below zero.
The best complexity lower bound for the reachability problem in this model is \pspace-hardness inherited from~\cite{BlondinFGHM15},
while the best upper bound is Ackermann membership inherited from VASS reachability~\cite{LS19}.
The reachability sets for that systems are not necessarily semilinear.
This disqualifies most of the techniques relying on the semilinearity of reachability sets, but our techniques
seem to be promising for that model.


 


\paragraph*{Acknowledgements}
We thank Radosław Piórkowski for many inspiring discussions about cones in VASS a few years ago
and Filip Mazowiecki for the discussions about the reachability problem for \tvass.
We thank also Henry Sinclair-Banks for helpful discussions about \cite[Thm 4.16]{DBLP:conf/focs/0001CMOSW24}.
We thank Qizhe Yang and Yangluo Zheng for the discussions on $3$-VASS, which are geometrically $2$-dimensional.
Finally, we thank anonymous reviewers for helpful comments.



\bibliographystyle{plain}
\bibliography{citat}

\newpage


\appendix


\end{document}
