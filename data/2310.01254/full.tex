\documentclass[oneside,reqno,12pt]{amsart}

\usepackage[a4paper, 
            left=0.9in,
            right=0.9in,
            top=1.1in,
            bottom=1.1in,
            footskip=.25in]{geometry}


 
\usepackage[utf8]{inputenc}
\usepackage{microtype}
\usepackage{graphicx}
\usepackage{amssymb} 
\usepackage[colorlinks = true,
            linkcolor = blue,
            urlcolor  = blue,
            citecolor = blue,
            anchorcolor = blue]{hyperref}


\usepackage{libertine}
\usepackage[libertine]{newtxmath}

\usepackage{enumerate}

\usepackage{thmtools} 
\usepackage{thm-restate}

\usepackage{microtype}

\usepackage{xcolor}

\theoremstyle{plain}
\newtheorem{thm}{}[section]
\newtheorem{lemma}[thm]{Lemma}
\newtheorem{proposition}[thm]{Proposition} 
\newtheorem{conjecture}[thm]{Conjecture}
\newtheorem{theorem}[thm]{Theorem}
\newtheorem{corollary}[thm]{Corollary}
\theoremstyle{remark}
\newtheorem{claim}[thm]{Claim}
\newtheorem{definition}[thm]{Definition}  
 \newtheorem{remark}[thm]{Remark} 
 \newtheorem{example}[thm]{Example} 


\newenvironment{claimproof}[1][\proofname]
{\renewcommand\qedsymbol{$\diamond$}\proof[#1]}
{\endproof}



\usepackage{centernot}  
\usepackage{xspace}  
 

\usepackage[scr=boondoxo]{mathalpha}  
\renewcommand{\coloneqq}{\mathrel{\mathop:}\mathrel{\mkern-1.2mu}=} 


 
\newcommand{\CQ}{\ensuremath{\mathrm{CQ}}} 
\newcommand{\CD}{\ensuremath{\mathrm{CD}}} 
\newcommand{\struct}[1]{\mathfrak{#1}}    
\newcommand{\CSP}{\ensuremath{\mathrm{CSP}}\xspace}    
\newcommand{\age}{\ensuremath{\mathit{age}}\xspace}   
\newcommand{\fm}{\ensuremath{\mathit{fm}}\xspace}  
\newcommand{\efm}{\ensuremath{\mathit{expfm}}\xspace} 
\newcommand{\ocfm}{\ensuremath{\mathit{ocfm}}} 
\newcommand{\colours}{\ensuremath{n\text{-}\mathit{colours}}} 


\newcommand{\hh}{\ensuremath{\mathrm{ht}}\xspace}
\newcommand{\lh}{\ensuremath{\mathrm{lh}}\xspace}
\newcommand{\wh}{\ensuremath{\mathrm{wd}}\xspace}
\newcommand{\ar}{\ensuremath{\mathrm{ar}}\xspace}   

 
\newcommand{\MMSNP}{\ensuremath{\mathrm{MMSNP}}\xspace}  
\newcommand{\GMSNP}{\ensuremath{\mathrm{GMSNP}}\xspace}  
\newcommand{\cplmt}[1]{\smash{\overline{#1}}} 
\newcommand{\pre}[1]{#1\smash{^{-1}}}   
\newcommand{\prexists}[1]{#1\smash{^{-1\exists}}}   
\DeclareMathOperator{\mo}{mod} 
\newcommand{\Aut}{\ensuremath{\mathrm{Aut}}\xspace}    
\newcommand{\EXPTIME}{{\textup{\textsf{EXPTIME}}}\xspace}  
\newcommand{\NEXPTIME}{{\textup{\textsf{NEXPTIME}}}\xspace}    
\newcommand{\TWONEXPTIME}{{\textup{\textsf{2NEXPTIME}}}\xspace}    
\newcommand{\Forb}{\ensuremath{\mathrm{Forb}}\xspace}   
 

\AtBeginDocument{\fontsize{12pt}{15pt}\selectfont}

\newcommand{\alexey}[1]{\ \ \pdfcomment[author=Alexey:,date=1,color=green]{#1}}   \newcommand{\jakub}[1]{\ \ \pdfcomment[author=Jakub:,date=1,color=purple]{#1}}   
\newcommand{\michael}[1]{\ \ \pdfcomment[author=Michael:,date=1,color=teal]{#1}}  
\newcommand{\ab}[1]{{\color{teal}#1}}
\newcommand{\mic}[1]{{\color{red}#1}} \newcommand{\jak}[1]{{\color{blue}#1}}
 
\begin{document}

\title[]{Containment for Guarded Monotone Strict NP}
 
 
 
\author{Alexey Barsukov} 
\author{Michael Pinsker}
\author{Jakub Rydval} 


\address{Faculty of Mathematics and Physics, Charles University, Prague, Czechia}
\email{alexey.barsukov@matfyz.cuni.cz}  

\address{Institut f\"{u}r Diskrete Mathematik und Geometrie, FG Algebra, TU Wien, Austria}
\email{$\{$michael.pinsker,jakub.rydval$\}$@tuwien.ac.at} 
 
 

 \begin{abstract}   

 Guarded Monotone Strict NP (GMSNP) extends Monotone Monadic Strict NP (MMSNP) by guarded existentially quantified predicates of arbitrary arities.
We prove that the containment problem for GMSNP is decidable, thereby 
 settling an open question of Bienvenu, ten Cate, Lutz, and Wolter, later restated by Bourhis and Lutz.
Our proof also comes with a \TWONEXPTIME upper bound on the complexity of the problem, which matches the lower bound for containment of MMSNP due to Bourhis and Lutz. 
 
In order to obtain these results, we significantly improve the state of knowledge of the model-theoretic properties of GMSNP.
Bodirsky, Kn\"{a}uer, and Starke previously showed that every GMSNP sentence defines a finite union of CSPs of $\omega$-categorical structures. 
We show that these structures can be used to obtain a reduction from the containment problem for GMSNP to the
 much simpler problem of testing the existence of a certain map called recolouring, albeit in a more general setting than GMSNP; a careful analysis of this  yields said upper bound.
As a secondary contribution, we refine the construction of Bodirsky, Kn\"{a}uer, and Starke by adding a restricted form of homogeneity to the properties of these structures, making the logic amenable to future complexity classifications for query evaluation  using techniques developed for infinite-domain CSPs.
\end{abstract}  

 \thanks{\emph{Michael Pinsker and Jakub Rydval}: This research was funded in whole or in part by the Austrian Science Fund (FWF) [I 5948]. For the purpose of Open Access, the authors have applied a CC BY public copyright licence to any Author Accepted Manuscript (AAM) version arising from this submission. 
 \\ \emph{Alexey Barsukov and Michael Pinsker}: This research is  funded by the European Union (ERC, POCOCOP, 101071674). Views and opinions expressed are however those of the author(s) only and do not necessarily reflect those of the European Union or the European Research Council Executive Agency. Neither the European Union nor the granting authority can be held responsible for them.}



\maketitle

\setlength\parfillskip{0pt plus .75\textwidth}
\setlength\emergencystretch{1pt}
\pagestyle{plain}
\addtolength{\textheight}{-\baselineskip}
\addtolength{\footskip}{\baselineskip}   




\section{Introduction}\label{section:introduction}
\subsection{The logic GMSNP} \label{sec:intro_one}

\emph{Guarded Monotone Strict NP} ($\GMSNP$) is a syntactic fragment of existential second-order logic 
describing problems of the form
\begin{center} \vspace{0.75em}
    {\it \parbox{0.725\textwidth}{Is there a colouring of the relational tuples in a given finite relational structure avoiding a fixed set of finitely many forbidden colour-patterns?}} \vspace{0.75em}
\end{center} 
The logic GMSNP was introduced in~\cite{bienvenu2014} as a generalisation of the logic \emph{Monotone Monadic Strict NP without inequality} ($\MMSNP$) of Feder and Vardi~\cite{federvardi1998}, which captures similar problems concerning colourings of vertices instead of relational tuples.
However, its true origins actually go back to an earlier work of Madelaine~\cite{madelaine2009universal}, who was studying GMSNP under the names MMSNP$_2$ and FPP (standing for \emph{Forbidden Pattern Problems}).

Formally, a GMSNP sentence $\Phi$ is of the form 
$\exists X_1,\dots, X_n \forall \bar{x}\ldotp \phi(\bar{x})$,
for a CNF-formula $\phi$ over a finite relational signature $\tau\cup \{X_1,\dots, X_n\}$,  satisfying the following two conditions:
\begin{itemize}
    \item $\tau$-atoms and equalities may only appear negatively in clauses of $\phi$, i.e., the only positive atoms in clauses of $\phi$ are of the form $X_i(\bar{x})$ for some $i\in [n]$;  \hfill (\emph{Monotonicity}) 
    \item for every clause $\psi$ of $\phi$ and every positive atom $X_i(\bar{x})$ in $\psi$ there exists a negative atom $\neg R(\bar{y})$ in $\psi$ with $R\in \tau \cup \{X_1,\dots, X_n\}$ such that $\bar{x}\subseteq \bar{y}$. \hfill  (\emph{Guarding})
\end{itemize}  
Unless stated otherwise, we will denote the set $\{X_1,\dots, X_n\}$ of the second-order variables in $\Phi$ by $\sigma$; we refer to $\sigma$ as the \emph{existential} symbols and $\tau$ as the \emph{input} symbols in $\Phi$.
We also refer to the first-order $(\tau\cup \sigma)$-sentence $\forall \bar{x}\ldotp \phi(\bar{x})$ as the \emph{first-order part} of $\Phi$.
By a simple application of De Morgan's laws, we can rewrite $\phi$ as a formula of the form $\bigwedge_i \neg \phi_i$, where each $\phi_i$ is a conjunction of $\tau$-atoms and possibly negated $\sigma$-atoms. 
We refer to the conjuncts $\phi_i$ as the \emph{forbidden patterns} of $\Phi$. 

A typical example of a problem that can be defined in $\GMSNP$ is whether a given undirected simple graph, say with edge relation denoted by $E$,  can be edge-2-coloured while avoiding monochromatic triangles~\cite{garey1979computers}:
\begin{align}\label{ex:gmsnp_introduction} 
  \exists B, R\, \forall x,y,z &\big(  \neg E(x,y) \vee   \neg  E(y,z) \vee \neg E(z,x) \vee \neg B(x,y) \vee   \neg  B(y,z) \vee \neg B(z,x)   
    \big) \nonumber \\
     {} \wedge \,  &\big(   \neg  E(x,y) \vee  \neg E(y,z) \vee \neg E(z,x) \vee  \neg R(x,y) \vee  \neg R(y,z) \vee \neg  R(z,x)   
    \big)   \\ 
   {} \wedge \,  &\big( \neg E(x,y) \vee B(x,y) \vee R(x,y) \big) \wedge \big( \neg E(x,y) \vee \neg B(x,y) \vee \neg R(x,y) \big).\nonumber 
\end{align} 
See Figure~\ref{fig:nomonotri} for illustration.
\begin{figure}[ht]
     \centering
      \includegraphics[width=0.4\linewidth]{picture.jpg}   
     \caption{An edge-2-colouring of the complete graph on $5$ vertices avoiding monochromatic triangles (outer edges red, inner blue). Note that there is no vertex-2-colouring with this property.}
     \label{fig:nomonotri}
 \end{figure}
The forbidden patterns of this problem are the two monochromatic triangles, overlapping colours, and uncoloured edges.
In MMSNP, we can formulate a similar problem where the task is to find a vertex-2-colouring instead of an edge-2-colouring: 
\begin{align} \label{ex:gmsnp_introduction2}
    \exists B, R\, \forall x,y,z 
   & \big(  \neg E(x,y) \vee   \neg  E(y,z) \vee \neg E(z,x) \vee \neg B(x) \vee   \neg  B(y) \vee \neg B(z)   
    \big) \nonumber  \\
   {} \wedge \, & \big(  \neg E(x,y) \vee   \neg  E(y,z) \vee \neg E(z,x) \vee \neg R(x) \vee   \neg  R(y) \vee \neg R(z)   
    \big)   \\ 
  {} \wedge \,  & \big( \neg B(x) \vee \neg R(x) \big) \wedge   \big(    B(x) \vee   R(x) \big). \nonumber
\end{align} 
Strictly speaking, $\GMSNP$ does \emph{not} fully contain $\MMSNP$ because the latter does not require the \emph{guarding} axiom (it instead requires the \emph{monadicity} axiom).
However, the containment does hold up to a small syntactic transformation, 
modulo which GMSNP is in fact strictly more expressive than MMSNP~\cite{bienvenu2014}.   
Namely, every MMSNP sentence $\Phi$ can be converted into a GMSNP sentence $\Gamma(\Phi)$ by expanding the base signature $\tau$ by a fresh unary ``domain'' symbol $D$ and adding negative atoms $\neg D(v)$ to each clause, for every universally quantified first-order variable $v$ appearing in that clause.
Given a $\tau$-structure $\struct{A}$, we have that $\Phi$ holds in $\struct{A}$ if and only if $\Gamma(\Phi)$ holds in $\struct{A}^+$, where $\struct{A}^+$ is the $(\tau\cup \{D\})$-structure  obtained from $\struct{A}$ by including every domain element in the relation interpreting $D$. 
On the other hand, given a $(\tau\cup \{D\})$-structure $\struct{A}$, we have that $\Gamma(\Phi)$ holds in $\struct{A}$ if and only if $\Phi$ holds in $\struct{A}^{-}$, where $\struct{A}^{-}$ is the $\tau$-structure obtained from $\struct{A}$ by forgetting $D$ and removing all domain elements which were not contained in the relation interpreting $D$. 
For example, the last two clauses in~\eqref{ex:gmsnp_introduction2} do not satisfy the guarding axiom, but we can obtain a polynomial-time equivalent  GMSNP sentence by padding~\eqref{ex:gmsnp_introduction2} with the predicate $D\in \tau$:
\begin{align*}
   &  \exists B, R\,   \forall x,y,z  \\
  \!\!\!\!  & \big(     \neg D(x) \vee \neg D(y) \vee \neg D(z) \vee \neg E(x,y) \vee   \neg  E(y,z) \vee \neg E(z,x)  \vee \neg B(x) \vee   \neg  B(y) \vee \neg B(z)   
    \big)  \\
    \!\!\!\! {} \wedge \,  &\big(    \neg D(x) \vee \neg D(y) \vee \neg D(z) \vee  \neg E(x,y) \vee   \neg  E(y,z) \vee \neg E(z,x) \vee \neg R(x) \vee   \neg  R(y) \vee \neg R(z)   
    \big)\\
  \!\!\!\! {} \wedge \, &\big( \neg D(x) \vee B(x) \vee R(x) \big) \wedge   \big( \neg D(x) \vee  \neg B(x) \vee \neg  R(x) \big). 
\end{align*}




\subsection{A brief history of GMSNP}

In 2014, Bienvenu, ten Cate, Lutz, and Wolter~\cite{bienvenu2014} discovered an interesting correspondence that allows one to translate complexity classification results for certain well-behaved fragments of the logic SNP~\cite{kolaitis1987decision,papadimitriou1988optimization}  to analogous  statements about the complexity of ontology-mediated queries.
In the special case of MMSNP, the above-mentioned result from~\cite{bienvenu2014} implies that there is a dichotomy between \textsf{P} and 
\textsf{NP}-completeness if and only if there is a dichotomy between \textsf{P} and 
\textsf{coNP}-completeness for the evaluation of unions of conjunctive queries mediated by ontologies specified in the description logic $\mathcal{ALC}$~\cite{baader2003description_corrected}.  
The significance of this equivalence  lies in the fact that the computational complexity of MMSNP had  already been intensively investigated within the programme initiated by Feder and Vardi in 1998~\cite{federvardi1998}.

Feder and Vardi proved that every problem described by an MMSNP sentence is equivalent under polynomial-time randomised reductions to the \emph{Constraint Satisfaction Problem} (CSP) of a  structure with a finite domain, i.e., the problem of testing whether a given conjunctive query is satisfiable in that structure.
They moreover conjectured that every finite-domain CSP is in \textsf{P} or \textsf{NP}-complete, which was eventually confirmed twenty years later by Bulatov and Zhuk~\cite{bulatov2017,zhuk2020} in what can be viewed as the culmination of decades of work on connections between algorithms for CSPs and universal algebra.
This implied dichotomies for MMSNP and, in turn, for the above-mentioned queries up to randomised reductions. 
Although the originally randomised reduction of MMSNP to CSPs by Feder and Vardi was derandomised by Kun in 2013~\cite{kun2013}, it still relied on a probabilistic proof of the existence of expanders of large girth. The first truly constructive proof of the dichotomy was obtained in 2018 by Bodirsky, Madelaine, and Mottet~\cite{bodirsky2018_article} using methods from infinite-domain constraint satisfaction, i.e., CSPs of infinite structures.  
Roughly speaking, they start with the observation from~\cite{BodDalJournal} that every MMSNP sentence defines a finite union of CSPs of (infinite) \emph{$\omega$-categorical} structures. 
They then gradually upgrade these structures until a state is reached where they can show that their  CSPs admit a polynomial-time many-one reduction to a finite-domain CSP which is polynomial-time tractable unless one of the $\omega$-categorical structures can simulate the 3-colouring problem via  a \emph{pp-construction}~\cite{wonderland} (in which case the sentence defines a NP-complete problem).





The question whether GMSNP also exhibits a \textsf{P}/\textsf{NP}-dichotomy was left open in~\cite{bienvenu2014};
a positive answer would yield a \textsf{P}/\textsf{coNP}-dichotomy for the evaluation of unions of conjunctive queries mediated by ontologies specified in guarded first-order logic. 
It was observed by Bodirsky, Kn\"{a}uer, and Starke~\cite{bodirsky_asnp} that similarly to MMSNP, the logic GMSNP can be studied using methods from infinite-domain constraint satisfaction.
Using this approach, the existence of a dichotomy has already been  confirmed in some specific cases, e.g., for graph orientations with forbidden tournaments~\cite{bodirsky2023forbidden,bitter2024completion, feller2024algebraic}. 
However, at the moment there is no clear road map for how exactly the question of the existence of a \textsf{P}/\textsf{NP}-dichotomy for GMSNP should be approached: it is apparent that the increase in the arity of the existentially quantified predicates introduces new obstacles which were not present with MMSNP. 
Hope is sparked by a recently announced result of Guzm\'{a}n-Pro~\cite{guzman2024gmsnp} who used the sparse-incomparability lemma~\cite{kun2013}  to show that the homomorphism-sandwiching method~\cite{brakensiek2019algorithmic} for obtaining hardness reductions from finite-domain \emph{promise} CSPs fails for CSPs definable in GMSNP. 
This is in fact a good plausibility argument for the applicability of  methods from infinite-domain constraint satisfaction to GMSNP, because several NP-hardness results for finite-domain promise CSPs~(Proposition~10.1 in \cite{pcsp_bible} and Theorem~2.2 in \cite{wrochna_zivny2020}) are inconsistent with the algebraic dichotomy conjecture for infinite-domain CSPs~\cite{barto_pinsker_journal}.


\subsection{The containment problem}

Besides query evaluation, two other computational decision problems for ontology-mediated queries were studied in~\cite{bienvenu2014}: first-order/datalog rewritability and containment.
As with their counterparts in automata theory, the complexity of such problems tends to be significantly higher. 
This raises the question of whether, in studying the complexity of these problems, one can perhaps avoid the fine-grained analysis that makes the proof of complexity dichotomies  so intricate.
In the case of MMSNP, the precise complexity of first-order/datalog rewritability and containment is known: both are \TWONEXPTIME-complete~\cite{Collapses, mottet2021symmetries,bouhris_lutz2016}.
While rewritability seems to be intimately linked to the reduction from MMSNP to finite-domain CSPs~\cite{Collapses, mottet2021symmetries}, for the containment problem, the link seems to be much weaker~\cite{bouhris_lutz2016,bodirsky2018_article}.
This makes the study of the containment problem for GMSNP a perfect starting point for the development of tools that will later be useful for approaching the topics of rewritability and query evaluation. 

In the proof of our main result, it will be important that we formulate the containment problem in the more general setting of \emph{SNP sentences}, which are obtained by leaving out the monotonicity and the guarding axioms.
For an SNP sentence $\Phi$, we denote the class of all finite models of $\Phi$ by $\fm(\Phi)$.
Formally, the \emph{containment problem} can be stated as follows:

\medskip  
\begin{samepage}  
\noindent \textbf{Containment for SNP} \\
\noindent INSTANCE: A pair $(\Phi_1, \Phi_2)$ of SNP sentences in a common signature $\tau$.\\
\noindent QUESTION: Is it true that $\fm(\Phi_1) \subseteq \fm(\Phi_2)$? \\ 
\end{samepage} 

The containment problem for SNP is undecidable in general; in fact, it is already undecidable for the \emph{Datalog} fragment~\cite{shmueli1993equivalence}. 
The question whether it is decidable for GMSNP was left open in~\cite{bienvenu2014,bouhris_lutz2016}; the only known result regarding the complexity of this problem is the lower bound of Bourhis and Lutz for the containment within MMSNP.
To see that this lower bound also applies for GMSNP, note that the map $\Gamma$ introduced in Section~\ref{sec:intro_one} is not only a polynomial-time reduction from MMSNP to GMSNP, but it also acts as a fully faithful covariant functor with respect to containment.
More specifically, for a pair $(\Phi_1, \Phi_2)$ of MMSNP $\tau$-sentences, we have $\fm(\Phi_1) \subseteq \fm(\Phi_2)$ if and only if $\fm(\Gamma(\Phi_1)) \subseteq \fm(\Gamma(\Phi_2))$.

\begin{theorem}[Theorem 3 in \cite{bouhris_lutz2016}]\label{th:lowerbound} Containment for GMSNP is \TWONEXPTIME-hard.
\end{theorem} 
 



\subsection{Contributions} \label{sec:contributions}

The contributions of the present article are twofold.
On the one hand, we confirm that the containment problem for GMSNP is indeed decidable. Our proof of decidability also comes with an upper bound on the complexity matching the lower bound in Theorem~\ref{th:lowerbound}.
  

\begin{theorem}\label{thm:2NEXPTIME_for_GMSNP} The containment problem for GMSNP is in \TWONEXPTIME.
\end{theorem}
\begin{corollary}
    The containment problem for GMSNP is \TWONEXPTIME-complete.
\end{corollary}
The proof of Theorem~\ref{thm:2NEXPTIME_for_GMSNP} is based on the recolouring method, first used implicitly by Feder and Vardi~\cite[Theorem~7]{federvardi1998} in their proof of decidability of containment for MMSNP.\footnote{Recolourings were first explicitly mentioned in the work of Madelaine and Stewart~\cite{madelaine2007constraint} (see also~\cite{madelaine2010containment}).}
Roughly said, the strategy is to modify the input sentences by adding new clauses and existentially quantified symbols until a state is reached where the containment problem becomes equivalent to the much simpler problem of testing the existence of a mapping between the existential symbols of the two sentences satisfying a certain condition (a recolouring).
In contrast to MMSNP, in order to achieve the promised \TWONEXPTIME upper bound on the complexity of containment for GMSNP using the recolouring method, we have to deviate from the GMSNP framework (to SNP) and significantly generalise the notion of a recolouring.


The first preprocessing step, common across most approaches to the containment problem for MMSNP, is a reduction to the connected case~\cite{bodirsky2018_article,bouhris_lutz2016,federvardi1998,madelaine2010containment}.
Intuitively, an MMSNP sentence is \emph{connected} if its forbidden colour-patterns are connected in the graph-theoretic sense.
This reduction can be generalised to GMSNP, as shown in~\cite{bodirsky_asnp}.  
Bodirsky, Kn\"{a}uer, and Starke~\cite[Proposition~1]{bodirsky_asnp} showed that every GMSNP sentence is logically equivalent to a finite disjunction of connected GMSNP sentences. 
An inspection of their proof reveals that if the complexity of checking containment is in $\TWONEXPTIME$ for connected GMSNP sentences, then so it is for the entire class GMSNP.

The second preprocessing step (in the approaches to the containment for MMSNP) is typically a reduction to the biconnected case~\cite{bouhris_lutz2016,bodirsky2018_article}.
Intuitively, an MMSNP sentence is \emph{biconnected} if no forbidden colour-pattern can be disconnected by deleting a single vertex.
The reduction to biconnected MMSNP is the point where a significant amount of work can be outsourced to a general combinatorial result, e.g., a lemma of Erd\H{o}s in the case of~\cite{bouhris_lutz2016} or a 
theorem of Hubi\v{c}ka and Ne\v{s}et\v{r}il in the case of~\cite{bodirsky2018_article}. 
The procedure for attaining biconnectedness from~\cite[Lemma~4.4]{bodirsky2018_article} transforms a given connected MMSNP sentence to a logically equivalent biconnected MMSNP sentence by iteratively selecting a forbidden colour-pattern which can be disconnected by deleting a single vertex and splitting it into two forbidden colour-patterns (corresponding to the two parts); the split is then marked using a fresh unary existential predicate. 
The GMSNP-analogue of this procedure does not terminate if the arities of the existentially quantified predicates are greater than $2$, and we do not see any way how this issue could be fixed.
Therefore, to progress further, we must understand how exactly the said general combinatorial results are used in the complexity analysis of the containment problem; in the present paper, we focus specifically on the approach from~\cite{bodirsky2018_article} using the mentioned theorem of Hubi\v{c}ka and Ne\v{s}et\v{r}il.


Roughly said, the theorem implies that every connected MMSNP $\tau$-sentence $\Phi$ can be assigned a highly symmetric infinite structure $\struct{C}_{\Phi}$ in a signature extending $\tau\cup \sigma$ such that the $(\tau\cup \sigma)$-reducts of the finite substructures of $\struct{C}_{\Phi}$ are up to isomorphism precisely the finite models of the first-order part of $\Phi$; this was first observed by Bodirsky and Dalmau~\cite{BodDalJournal}.
Bodirsky, Madelaine, and Mottet~\cite{bodirsky2018_article} proved that if $\Phi$ is biconnected, then the $(\tau\cup \sigma)$-reduct of $\struct{C}_{\Phi}$ retains a certain amount of the original symmetry, and this fact is crucial in their take on the recolouring method.
Later on, Bodirsky, Kn\"{a}uer, and Starke~\cite{bodirsky_asnp} showed that also connected GMSNP sentences can be assigned said highly symmetric infinite structures; they did not comment on whether this fact is helpful in analysing the complexity of the containment problem for GMSNP. 
We show that the highly symmetric infinite structures $\struct{C}_{\Phi}$ associated with GMSNP sentences $\Phi$ can be described by SNP sentences $\Delta(\Phi)$ of size doubly exponential in the size of $\Phi$.
Subsequently, we show that the containment $\fm(\Phi_1)\subseteq \fm(\Phi_2)$ is equivalent to the existence of a particular mapping from $\struct{C}_{\Phi_1} $ to $ \struct{C}_{\Phi_2}$ which is uniquely determined by the images of substructures whose size is bounded by the maximal arity of a symbol in $\Phi_1$ or $\Phi_2$.
From this fact, we extract our more general version of recolourings for SNP.
By carefully analysing the total complexity of computing the SNP sentences $\Delta(\Phi_1)$ and $\Delta(\Phi_2)$ stemming from the theorem of Hubi\v{c}ka and Ne\v{s}et\v{r}il and of the subsequent check for the existence of a recolouring between such sentences, we conclude that the containment problem for GMSNP is in $\TWONEXPTIME$.
We remark that our methods are, in theory,  applicable in a more general setting than GMSNP; a fragment of SNP which is closely related to such applicability is  \emph{Amalgamation SNP} introduced in~\cite{bodirsky_asnp}.
We also remark that the SNP sentences $\Delta(\Phi_1)$ and $\Delta(\Phi_2)$ define a linear order over the domain of a given structure, which is at the core of our argument why the recolouring method works in our case. It is provably not possible to define a linear order in GMSNP~\cite[Example~6]{bodirsky_asnp}, which indicates that this method requires us to leave the GMSNP framework.




As our secondary contribution, we analyse to what extent it is possible to prove the decidability of the containment problem for GMSNP while staying as close as possible to the original recolouring method for MMSNP.
A (vertex)-recolouring $\xi$ between two MMSNP sentences $\Phi_1$ and $\Phi_2$ is simply a mapping 
 from the (unary) 
 existential  symbols of $\Phi_1$ 
  to those of  $\Phi_2$ whose application to the relations denoted by these symbols of any model of the first-order part of $\Phi_1$ yields a model of the first-order part of $\Phi_2$. {That is, the mapping $\xi$  does not introduce any vertex-colour patterns forbidden by $\Phi_2$ into structures which originally did not contain any patterns forbidden by $\Phi_1$ (see~\cite[Definition~4.25]{bodirsky2018_article}).
If $\Phi_1$ and $\Phi_2$ assert that the existential relations form a partition of all vertices (cf.~the notion of   \emph{normal form} in~\cite{bodirsky2018_article}), then this is what one would intuitively understand under a recolouring of vertices -- hence the name. 
But the true intention of this concept, which does not require any additional assumptions
on $\Phi_1$ and $\Phi_2$ (such as the vertices being partitioned by the existential predicates) is to capture a very specific case of the containment $\fm(\Phi_1) \subseteq \fm(\Phi_2)$, which is witnessed uniformly across all structures in $\fm(\Phi_1)$.
The natural extension of vertex-recolourings to GMSNP would be \emph{edge-recolourings}, i.e., mappings 
\begin{align}
 \xi \colon R(x_1,\dots, x_n) \wedge \alpha_1(x_1,\dots, x_n)  \mapsto R(x_1,\dots, x_n) \wedge \alpha_2(x_1,\dots, x_n), \label{eq:edge_recolouring}
\end{align} 
where $R\in \tau$ and $\alpha_i$ is an atomic $\sigma_i$-formula ($i\in [2]$), 
 such that $\xi$ induces a mapping between models of the first-order parts of the two sentences. The notion of a recolouring for SNP we use in the proof of Theorem~\ref{thm:2NEXPTIME_for_GMSNP} is considerably more general and  abstract.
Hence, it makes sense to ask whether one can also prove decidability of containment for GMSNP by simply refining
the input sentences $\Phi_1$ and $\Phi_2$ long enough, while staying in GMSNP, until the containment $\fm(\Phi_1)\subseteq \fm(\Phi_2)$ becomes equivalent to the existence of an edge-recolouring from $\Phi_1$ to $\Phi_2$. 

The central notion in analysing this possibility is \emph{recolouring-readiness}, which is comparable to the notion of a \emph{simple program} of Bourhis and Lutz~\cite{bouhris_lutz2016} or the normal form of Bodirsky, Madelaine, and Mottet~\cite{bodirsky2018_article}.
Instead of relying purely on syntactic preprocessing, in the definition of recolouring-readiness, we draw our inspiration from the proof of Theorem~\ref{thm:2NEXPTIME_for_GMSNP}.
Intuitively, a GMSNP $\tau$-sentence $\Phi$ is recolouring-ready if it can be assigned 
a highly symmetric infinite structure $\struct{C}_{\Phi}$ as in our proof of Theorem~\ref{thm:2NEXPTIME_for_GMSNP} such that the $(\tau\cup \sigma)$-reduct of $\struct{C}_{\Phi}$ retains a sufficient amount of the original symmetry for a reduction from containment to edge-recolouring to work.
We show that every connected GMSNP sentence $\Phi$ is logically equivalent to a connected recolouring-ready GMSNP sentence $\Omega(\Phi)$.
However, the size of the smallest such $\Omega(\Phi)$ that we are able to obtain surpasses the upper bound provided in Theorem~\ref{thm:2NEXPTIME_for_GMSNP}.
We leave it as an open question whether the precise complexity of containment for GMSNP can be determined purely from within the GMSNP framework.


\begin{theorem}{recolouringreadiness}    \label{thm:recolouring_readiness}  
For every connected GMSNP $\tau$-sentence $\Phi$ there exists a logically equivalent recolouring-ready connected 
 GMSNP $\tau$-sentence $\Omega(\Phi)$ of size triple-exponential in the size of $\Phi$ such that the maximal arity of the symbols in $\Phi$ and in $\Omega(\Phi)$ is the same. 
Moreover, $\Omega(\Phi)$ can be computed from $\Phi$ in nondeterministic triple-exponential time.
\end{theorem} 
  
\subsection{Outline}
In Section~\ref{section:preliminaries}, we provide some background knowledge necessary for the presentation of our results.
Section~\ref{section:decidability} contains the proof of Theorem~\ref{thm:2NEXPTIME_for_GMSNP}, where the individual steps are presented in the order given in the introduction.
Section~\ref{thm:recolouring_readiness} contains a proof sketch for Theorem~\ref{thm:recolouring_readiness}. 
  


\section{Preliminaries}\label{section:preliminaries}
  
We use the bar notation for tuples, and the set $\{1,\dots,n\}$ is denoted by $[n]$.
We extend the containment relation on sets to tuples by ignoring the ordering on the entries. For example, we might write $X\subseteq \bar{t}$ for a set $X$ and a tuple $\bar{t}$. 



\subsection{Structures.} 
A (\emph{relational}) \emph{signature} $\tau$ is a set of \emph{relation symbols}, each $R\in\tau$ is associated with a natural number called \emph{arity}.
A (\emph{relational}) \emph{$\tau$-structure} $\struct{A}$ consists of a set $A$ (the \emph{domain}) together with the relations $R^{\struct{A}}\subseteq A^{k}$ for each $R\in \tau$ with arity $k$.
An \emph{expansion} of $\struct{A}$ is a $\sigma$-structure $ \struct{B}$ with $A=B$ such that $ \tau\subseteq \sigma$ and $R^{\struct{B}}=R^{\struct{A}}$ for each relation symbol $R\in \tau$. Conversely, we then  call $\struct{A}$ a \emph{reduct} of $\struct{B}$.
We denote the reduct of $\struct{B}$ to a subset $\tau$ of its signature by $\struct{B}^{\tau}$.
A \emph{linear-order expansion} of a $\tau$-structure $\struct{A}$ is an expansion by a single linear order denoted by $<$ (assuming  ${<}\notin \tau$); we denote such expansion by $(\struct{A},<)$.
We often do not distinguish between the symbol $<$ and the associated linear order. 
Given a class of $\tau$-structures $\mathcal{K}$, we denote by $\mathcal{K}^{<}$ the class of all $\tau\cup \{<\}$-structures which are linear-order expansions of structures from $\mathcal{K}$.
The \emph{union} of two $\tau$-structures $\struct{A}$ and $\struct{B}$ is the $\tau$-structure $\struct{A}\cup \struct{B}$ with domain $A\cup B$ and relations $R^{\struct{A}\cup \struct{B}}\coloneqq R^{\struct{A}}\cup R^{\struct{B}}$ for every $R\in \tau$.
A structure is \emph{connected} if it is not the union of two structures with disjoint non-empty domains.

 

A \emph{homomorphism} $h\colon \struct{A} \rightarrow \struct{B}$ for $\tau$-structures $\struct{A},\struct{B}$ is a mapping $h\colon  A\rightarrow B$ that \emph{preserves} each relation of $\tau$, i.e., whenever $ \bar{t} \in R^{\struct{A}}$ for some relation symbol $R\in \tau$, then $h(\bar{t})$ (computed componentwise) 
 is an element of $R^{\struct{B}}$.
We write $\struct{A} \rightarrow \struct{B}$ if $\struct{A}$ maps homomorphically into $\struct{B}$. 
The \emph{Constraint Satisfaction Problem} (CSP) of $\struct{A}$, denoted by $\CSP(\struct{A})$, is defined as the class of all finite structures which homomorphically map into $\struct{A}$.
An \emph{embedding} 
is an injective homomorphism $h\colon \struct{A} \rightarrow \struct{B}$ that additionally satisfies the following condition: for every $k$-ary relation symbol $R\in \tau$ and $\bar{t}\in A^{k}$ we have $h(\bar{t})\in R^{\struct{B}}$ only if $\bar{t}\in R^{\struct{A}}.$
We write $\struct{A}\hookrightarrow \struct{B}$ if $\struct{A}$ embeds into $\struct{B}$. 
The \emph{age} of $\struct{A}$, denoted by $\age(\struct{A})$, is the class of all finite structures which embed into $\struct{A}$.
A \emph{substructure} of $\struct{A}$ is a structure $\struct{B}$ over $B\subseteq A$ such that the inclusion map $i\colon B\rightarrow A$ is an embedding.An \emph{isomorphism} is a surjective embedding. 
A \emph{partial isomorphism} on a structure $\struct{A}$ is an isomorphism between two substructures of $\struct{A}$.
Two structures $\struct{A}$ and $\struct{B}$ are \emph{isomorphic} if there exists an isomorphism from $\struct{A} $ to $\struct{B}$.  An \emph{automorphism} of $\struct{A}$ is an isomorphism from $\struct{A}$ to itself.  
The set of all automorphisms of $\struct{A}$ is denoted by $\Aut(\struct{A})$.

The \emph{orbit} of a tuple $\bar{t}\in B^{k}$ in $\struct{B}$ is the set $\{g(\bar{t}) \mid g \in \Aut(\struct{B})\}.$ 
For two structures $\struct{A}$ and $\struct{B}$, a function $f\colon A \rightarrow B$ is called \emph{canonical from $\struct{A}$ to $\struct{B}$} if, for every $k\geq 1$, the componentwise action of $f$ induces a well-defined function from the orbits of $k$-tuples in $\struct{A}$ to the orbits of $k$-tuples in $\struct{B}$; that is, if any two $k$-tuples belonging to the  same orbit, say $O_1$, are mapped into the same orbit, say $O_2$; we can then write $f(O_1) = O_2$.
In other words, for every $k\geq 1$,  every $\bar{t}\in A^k$,  and every $\alpha\in\Aut(\struct{A})$, there exists $\beta\in\Aut(\struct{B})$ such that $f(\alpha(\bar{t}))=\beta(f(\bar{t}))$.
A countable structure $\struct{B}$ is \emph{$\omega$-categorical} if, for every $k\geq 1$, there are only finitely many orbits of $k$-tuples in $\struct{B}$. 
The following lemma can be shown by a  standard compactness argument, e.g., using K\H{o}nig's tree lemma.

\begin{lemma}[Lemma~4.1.7 in~\cite{Bodirsky_book}] \label{lemma:compactness} Let $\struct{A}$ and $\struct{B}$ be countable relational structures such that $\struct{B}$ is $\omega$-categorical.
Then $\struct{A} \hookrightarrow \struct{B}$ if and only if every finite substructure of $\struct{A}$ embeds into $\struct{B}$.
\end{lemma}

\subsection{Logic.} \label{section:prelims_logic}
We assume that the reader is familiar with classical \emph{first-order} logic as well as with basic preservation properties of first-order formulas, e.g., that every first-order formula $\phi$ is preserved by isomorphisms; by embeddings if $\phi$ is existential, and by homomorphisms if $\phi$ is existential positive.
We assume that equality $=$ is always available when building first-order formulas.
We say that a first-order formula $\phi$ is \emph{$k$-ary} if it has $k$ free variables; we use the notation $\phi(\bar{x})$ to indicate that the free variables of $\phi$ are among $\bar{x}$.
This does not mean that the truth value of $\phi$ depends on each entry in $\bar{x}$. 

In the present article, \emph{atomic $\tau$-formulas}, or \emph{$\tau$-atoms} for short, over a relational signature $\tau$ are of the form $R(\bar{x})$ for some $R\in \tau$ and a tuple $\bar{x}$ of first-order variables matching the arity of $R$.
For technical reasons, formulas of the form $x=y$ built using the default equality predicate are not considered atomic.
For a finite conjunction $\phi$ of $\tau$-atoms, the \emph{canonical database} of $\phi$ is the structure $\struct{A}$ whose domain consists of the variables of $\phi$ and such that $\struct{A}\models R(\bar{t})$ holds if and only if $\phi$ contains the $\tau$-atom $R(\bar{t})$ as a conjunct.
The canonical database of $\phi$ admits a homomorphism to a $\tau$-structure $\struct{B}$
if and only if $\phi$ is satisfiable in $\struct{B}$~\cite{10.1145/800105.803397}.
For a finite $\tau$-structure $\struct{A}$, the \emph{canonical query} of $\struct{A}$ 
is defined as the formula $ \bigwedge\nolimits_{R\in \tau}\bigwedge\nolimits_{\bar{t}\in R^{\struct{A}}} R(\bar{t})$. 
The canonical query of $\struct{A}$ is satisfiable in a $\tau$-structure $\struct{B}$ if and only if there exists a homomorphism from $\struct{A}$ to $\struct{B}$~\cite{10.1145/800105.803397}. 

  
 
 


 \subsection{Structural Ramsey theory.} 
A relational structure $\struct{B}$ is \emph{homogeneous} if, for every $k\geq 1$, two tuples $\bar{t}_1,\bar{t}_2\in B^k$ lie in the same orbit if and only if the function mapping the $i$-th coordinate in $\bar{t}_1$ to the $i$-th coordinate in $\bar{t}_2$ for all $1\leq i\leq k$ is an isomorphism between two substructures of $\struct{B}$. 
In other words, a structure is homogeneous if every partial isomorphism between two finite substructures extends to an automorphism of the entire structure.
Every homogeneous structure over a finite relational signature is $\omega$-categorical.

Homogeneous structures arise as limit objects of certain classes of finite structures.
Let $\mathcal{K}$ be a class of finite structures in a finite relational signature $\tau$ closed under isomorphisms and substructures.  
We say that $\mathcal{K}$ has the \emph{amalgamation property} (AP) if, for all $\struct{A},\struct{B} \in \mathcal{K}$ whose substructures induced on $A\cap B$ are identical, there exist  $\struct{W}\in \mathcal{K}$ and embeddings $e\colon \struct{A}\hookrightarrow \struct{W}$, $f\colon \struct{B} \hookrightarrow \struct{W}$
such that $e|_{A\cap B} = f|_{A\cap B}.$
\begin{theorem}[Fra\"{i}ss\'{e}, Theorem~6.1.2 in~\cite{hodges_book}] \label{theorem:fraisse_2} For a class $\mathcal{K}$ of finite structures in a finite relational signature $\tau$, the following are equivalent:
\begin{itemize}
    \item $\mathcal{K}$  is the age of a  countable homogeneous $\tau$-structure; this structure is necessarily unique up to isomorphism and called the \emph{Fra\"{i}ss\'{e}-limit} of $\mathcal{K}$;

\item $\mathcal{K}$ is closed under isomorphisms, substructures, and has the AP.
\end{itemize}
\end{theorem} 
  
For structures $\struct{A}$ and $\struct{W}$, we denote by $\binom{\struct{W}}{\struct{A}}$ the set of all embeddings of $\struct{A}$ into $\struct{W}$.
A class $\mathcal{K}$ of structures over a common signature $\tau$ has the \emph{Ramsey property} (RP) if,  for all $\struct{A},\struct{B}\in \mathcal{K}$ and $k\in \mathbb{N}$, there exists $\struct{W}\in \mathcal{K}$ such that, for every map $f\colon \binom{\struct{W}}{\struct{A}} \rightarrow [k]$, there exists $e\in \binom{\struct{W}}{\struct{B}}$ such that $f$ is constant on the set $\bigl\{e\circ u\;|\; u\in \binom{\struct{B}}{\struct{A}}\bigr\} \subseteq \binom{\struct{W}}{\struct{A}}$.  
Following \cite[Definition~5.3]{bodirsky2018_article}, in the present article, we call a (countable) $\omega$-categorical structure $\struct{B}$  \emph{Ramsey} if the age of the  expansion of $\struct{B}$ by all first-order definable relations (which is always a homogeneous structure) has the Ramsey property. 
By the theorem of Engeler, Ryll-Nardzewski and Svenonius~\cite{hodges_book}, this property only depends on the automorphism group $\Aut(\struct{B})$.   
It is not hard to see that every homogeneous $\omega$-categorical structure whose age has the RP is Ramsey, since all of its first-order definable relations are in fact definable without quantifiers.


In the proof of Theorem~\ref{thm:2NEXPTIME_for_GMSNP}, we employ structural Ramsey theory to effectively reduce the problem of containment between two infinite classes of finite structures to the existence of a certain computable function between two infinite structures. This reduction is achieved by first representing the two classes by infinite structures via  Theorem~\ref{theorem:fraisse_2} above, and then ensuring the computability of the function comparing the two infinite structures (if it exists) using the following statement, an immediate consequence of Theorem~5 in~\cite{bodirsky_pinsker_ramsey_canonical}. 

\begin{restatable}[\cite{bodirsky_pinsker_tsankov}, Theorem 5 in~\cite{bodirsky_pinsker_ramsey_canonical}]{theorem}{canonlemma}    \label{th:canonical_ramsey} 
 Let $\struct{A}$, $\struct{B}$ be countable $\omega$-categorical   relational structures such that $\struct{A}$ is Ramsey, and let $\struct{A}',\struct{B}'$ be reducts of these structures.  If there exists an embedding from $\struct{A}'$ to  $\struct{B}'$, then there also exists an embedding from $\struct{A}'$ to $\struct{B}'$ that is canonical viewed as a mapping from $\struct{A}$  to $\struct{B}$.     
\end{restatable} 



 
\section{The containment problem} 
\label{section:decidability}


To accurately measure the size of SNP sentences $\Phi$, we introduce the following four parameters:
\begin{itemize}
    \item the \emph{height} $\hh(\Phi)$ denotes the number of relation symbols in $\Phi$;
    \item the \emph{length} $\lh(\Phi)$ denotes the number of clauses in $\Phi$; 
    \item the \emph{width} $\wh(\Phi)$ denotes the the maximum number of variables per clause in $\Phi$;
    \item the \emph{arity} $\ar(\Phi)$ denotes the maximum arity among all relation symbols in $\Phi$.  
\end{itemize}


\subsection{Connectedness}  \label{section:connectedness}


 An SNP $\tau$-sentence $\exists X_1,\dots, X_n \forall \bar{x}\ldotp \phi(\bar{x})$ is \emph{connected} in the sense of~\cite{bodirsky_asnp,Bodirsky_book} if, for each clause $\psi$ in $\phi$, the following $(\tau\cup \sigma)$-structure $\struct{C}_{\psi}$ is connected: the domain consists of all variables in $\psi$, and $\bar{t}\in R^{\struct{C}_{\psi}}$ if and only if $\neg R(\bar{t})$ is a disjunct in $\psi$ ($R\in \tau\cup \sigma$). 
For example, the sentences in equations~\eqref{ex:gmsnp_introduction} and~\eqref{ex:gmsnp_introduction2} from the introduction are connected, while the sentence
\begin{equation*}
\exists B,R\, \forall x,y,u,v\;  \big( \neg E(x,y) \vee \neg  E(u,v) \vee \neg  R(x,y) \vee B(u,v)\big)
\end{equation*}
is not because 
the variable sets $\{x,y\}$ and $\{u,v\}$ partition the structure $\struct{C}_{\psi}$ associated to the clause $ \psi=\big( \neg E(x,y) \vee \neg  E(u,v) \vee \neg  R(x,y) \vee B(u,v)\big)$ into two disjoint substructures.

The next proposition was essentially proved in~\cite{bodirsky_asnp} (Proposition~1), except that the authors did not comment on the complexity of the procedure arising from their proof.
\begin{proposition}[Proposition~1 in~\cite{bodirsky_asnp}] \label{prop:connected}
Every GMSNP sentence $\Phi$ is logically equivalent to a disjunction of connected $\GMSNP$ sentences $\Phi_1\vee\dots\vee\Phi_\ell$ over the same input  and existential signatures  with the following properties: for all $i\in[\ell]$, $\lh(\Phi_i)$ and $\wh(\Phi_i)$ are polynomial in $\lh(\Phi)$ and $\wh(\Phi)$, respectively; $\ell$ is single-exponential in $\lh(\Phi)\cdot\wh(\Phi)$; and the entire  disjunction can be computed from $\Phi$ in deterministic single-exponential time. 
\end{proposition}

Proposition~\ref{prop:connected} shows that when studying the complexity of the the containment problem for GMSNP,   we may without loss of generality restrict ourselves to connected GMSNP.  


\begin{corollary}\label{cor:connected_matters_not}
    If the containment problem for connected GMSNP sentences is in $\TWONEXPTIME$, then also the containment problem for general GMSNP sentences is in $\TWONEXPTIME$.
\end{corollary}


To prove Corollary~\ref{cor:connected_matters_not}, we first prove the following simple auxiliary lemma.

\begin{lemma}\label{lem:connected}
 Suppose that $\Phi\coloneqq\Phi_1\vee\dots\vee\Phi_k$ and $\Psi\coloneqq\Psi_1\vee\dots\vee\Psi_\ell$ are two finite disjunctions of connected $\GMSNP$ sentences. 
Then the following are equivalent:
\begin{enumerate}
     \item \label{item:disj1} $\fm(\Phi)\subseteq \fm(\Psi)$;
     \item \label{item:disj2}  for every $i\in[k]$, there exists $j\in[\ell]$ such that $\fm(\Phi_i)\subseteq \fm(\Psi_j)$. 
 \end{enumerate} 
\end{lemma}   
  

\begin{proof}
``\eqref{item:disj1}$\Rightarrow$\eqref{item:disj2}'' Suppose, on the contrary, that for some $i\in[k]$, there is no $j \in [\ell]$ as claimed, i.e.,~for every $j\in[\ell]$ there exists a structure $\struct{A}_j\in\fm(\Phi_i)$ such that $\struct{A}_j\not\in\fm(\Psi_j)$.
Let $\struct{A}$ be the structure obtained by taking the union of isomorphic copies of $\struct{A}_1, \dots,\struct{A}_\ell$ with disjoint domains.
Then, the connectedness of $\Phi_i$ implies that $\struct{A}\in\fm(\Phi_i)$ and consequently $\struct{A}\in\fm(\Phi)$.
As $\fm(\Phi)\subseteq\fm(\Psi)$, we have $\struct{A}\in\fm(\Psi)$.
So, for some $j\in[\ell]$, we have $\struct{A}\in\fm(\Psi_j)$.
This means that there is a $\sigma$-expansion $\struct{A}^\sigma$ of $\struct{A}$ such that $\struct{A}^\sigma\models\forall\bar{x}\ldotp \psi_j(\bar{x})$, where $\sigma$ is the existential signature of $\Psi_j$ and $\psi_j(\bar{x})$ is the quantifier-free part of $\Psi_j$.
As $\forall\bar{x}\ldotp \psi_j(\bar{x})$ is a universal first-order sentence, we also have $\struct{A}_j^\sigma\models\forall\bar{x}\ldotp \psi_j(\bar{x})$, where $\struct{A}_j^\sigma$ is the substructure of $\struct{A}^\sigma$ induced on the elements of $\struct{A}_j$.
This contradicts the assumption that $\struct{A}_j\not\in\fm(\Psi_j)$. Hence, the right-hand side of the equivalence follows.

``\eqref{item:disj2}$\Rightarrow$\eqref{item:disj1}'' This direction is trivial.
\end{proof}
 
\begin{proof}[Proof of Corollary~\ref{cor:connected_matters_not}]
    By Proposition~\ref{prop:connected}, we have $\Phi = \Phi_1\vee\dots\vee\Phi_{\ell_1}$ and $\Psi = \Psi_1\vee\dots\vee\Psi_{\ell_2}$ such that all $\Phi_i$'s are connected and $\lh(\Phi_i)=p(\lh(\Phi_i))$, $\wh(\Phi_i)=p(\wh(\Phi))$, and $\ell_1=2^{p(|\Phi|)}$, where $p(x)$ is some polynomial; and similarly for all $\Psi_j$'s.
By Lemma~\ref{lem:connected}, to check that $\Phi\subseteq \Psi$, one goes through all the mappings $f\in [\ell_2]^{[\ell_1]}$ and, for every such $f$ and every $i\in[\ell_1]$, checks whether $\Phi_i\subseteq\Psi_{f(i)}$.
Let $T(\Phi_i,\Psi_j)$ be an upper bound on the time needed to test $\Phi_i\subseteq \Psi_j$.
Then, the total time needed to test $\Phi\subseteq \Psi$ is at most $\ell_2^{\ell_1}\cdot \ell_1\cdot \max_{i,j} T\bigl(\Phi_i,\Psi_j\bigr)$, from which the statement follows.
\end{proof}




\subsection{Recolourings} \label{section:recolourings}

We call a relational structure \emph{standard} if its domain is $[n]$ for some $n\in \mathbb{N}$.
For an SNP $\tau$-sentence $\Phi$, we denote the class of all finite models of the first-order part of $\Phi$  (over the signature $\tau\cup \sigma$) by $\efm(\Phi)$.    
We define the $n$-\emph{colours} of $\Phi$, denoted $\colours(\Phi)$, as the set of all standard structures from $\efm(\Phi)$ of size $\leq n$.
A \emph{recolouring} between two SNP $\tau$-sentences $\Phi_1$ and $\Phi_2$ is a mapping $\xi$ from $\colours(\Phi_1)$ to $\colours(\Phi_2)$, where $n\coloneqq \max(\ar(\Phi_1),\ar(\Phi_2))$, with the two following two properties.
First, the $\tau$-reducts of every $n$-colour of $\Phi_1$ and of its $\xi$-image are identical.
Secondly, for every $\struct A\in \efm(\Phi_1)$, there is a structure $\xi'(\struct A)\in \efm(\Phi_2)$ on the same domain such that for all $\struct{T} \in \colours(\Phi_1)$ and every embedding $e\in \binom{\struct{A}}{\struct{T}}$ we have $e\in \binom{\xi'(\struct{A})}{\xi(\struct{T})}$. 
In other words, the following  extension $\xi'$ of $\xi$ is a well-defined mapping from $\efm(\Phi_1)$ to $\efm(\Phi_2)$: 
\begin{center} \vspace{0.75em}
    {\it \parbox{0.65\textwidth}{For every $\struct{A}\in \efm(\Phi_1)$, the structure $\xi'(\struct{A})$ on the same domain as $\struct{A}$ is obtained by replacing for every  $\struct{T} \in \colours(\Phi_1)$ and every embedding $e\in \binom{\struct{A}}{\struct{T}}$ the substructure $e(\struct{T})$ of $\struct A$ by $e(\xi(\struct{T}))$.}  
    } \vspace{0.75em}
\end{center} 

Note that the second formulation makes it clear that $\xi'(\struct A)$ is unique, as $n = \max(\ar(\Phi_1),\ar(\Phi_2))$.
For the same reason, we have that $\struct{A}^\tau = \xi'(\struct A)^\tau$.  
Also observe that in the second  formulation the well-definedness of $\xi'$ is a non-trivial property since the required replacements might be on overlapping substructures. 

We remark that this definition of a recolouring is compatible with the definition of a recolouring for the logic MMSNP given in~\cite{madelaine2010containment,bodirsky2018_article}.
There, the unary existential symbols were interpreted as colours, and a recolouring was simply a mapping between the existential symbols which does not introduce any forbidden patterns.
It is noteworthy, however, that in that case the compatibility on overlapping structures is trivially satisfied.
 

\begin{figure}[ht]
     \centering
      \includegraphics[width=0.7\linewidth]{Colours_corrected.jpg}
     \caption{A recolouring from $\Phi_1$ to $\Phi_2$ in Example~\ref{ex:recolouring}.}
     \label{fig:colour_patterns}
 \end{figure} 


\begin{example} \label{ex:recolouring}
Consider the GMSNP $\{E\}$-sentences ($E$ is binary) 
\begin{align*} 
\Phi_1\coloneqq \exists & R,G,B\,  \forall x_1,x_2,x_3,x_4,x_5\ldotp \phi_1(x_1,x_2,x_3,x_4,x_5), \\
\Phi_2\coloneqq \exists & P,G\, \forall x_1,x_2,x_3\ldotp \phi_2(x_1,x_2,x_3)     
\end{align*}
whose forbidden colour patterns are as in Figure~\ref{fig:colour_patterns}; we additionally forbid uncoloured edges and overlapping colours in order to ensure that the colours partition the edges.
\begin{align*}
 & \big(\neg E(x_1,x_2) \vee R(x_1,x_2) \vee G(x_1,x_2) \vee B(x_1,x_2) \big)\\  {} \wedge {} &  \big(\neg E(x_1,x_2) \vee \neg R(x_1,x_2) \vee \neg G(x_1,x_2)  \big)  \\
 {}    \wedge {} & \big(\neg E(x_1,x_2) \vee \neg G(x_1,x_2) \vee \neg B(x_1,x_2)  \big)\\
 {} \wedge {} &\big(\neg E(x_1,x_2) \vee \neg B(x_1,x_2) \vee \neg R(x_1,x_2)  \big)   
\end{align*}
Note that in GMSNP we cannot enforce that the colours partition all pairs of elements of the domain, because every clause must satisfy the guarding axiom. 
Now consider a map $\xi$ mapping the green colour of undirected edges to itself, while merging the red and the blue colours to purple.
The remaining structures in $\colours(\Phi_1)$, where $n=2$, consist either of a single vertex or two non-$E$-related vertices, possibly related with $\{R,G,B\}$-relations. 
They are mapped to $\colours(\Phi_2)$ in an arbitrary way consistent with the first recolouring condition, i.e., that the $\{E\}$-reducts are identical.




To show that $\xi$ is a recolouring, we must show that it does not produce green or purple triangles in edge-coloured graphs that originally did not admit a homomorphism from any of the 5 forbidden colourings of pentagons.
Clearly, $\xi$ cannot produce a green triangle:  the only way to produce a green triangle would be  to start with one, and a green triangle admits a homomorphism from a green pentagon, which is forbidden.
We can argue similarly in the case of a purple triangle, which can only be obtained with $\xi$ from one of the 4 red/blue-coloured triangles at the bottom of the figure.
All 4 of them admit a homomorphism from one of the forbidden coloured pentagons. Hence, $\xi$ is a recolouring. 
\end{example}
\begin{lemma}\label{lemma:recolouring_nexptime} 
The existence of a recolouring between two SNP sentences $\Phi_1$ and $\Phi_2$ can be tested non-deterministically in time $$\mathcal{O}\Bigl(\lh(\Phi_1)\cdot \lh(\Phi_2) \cdot 2^{\wh(\Phi_1)\cdot \wh(\Phi_2)\cdot \hh(\Phi_1)\cdot\hh(\Phi_2) \cdot  2^{\ar(\Phi_1)\cdot \ar(\Phi_2)}}\Bigr).$$   
\end{lemma}

\begin{proof} Let $n\coloneqq \max(\ar(\Phi_1),\ar(\Phi_2))$.
Note that $|\colours(\Phi_1)|$ is bounded by the number of $(\tau\cup\sigma_1)$-structures on at most $n$ elements.
Therefore, it is at most $N\coloneqq2^{\hh(\Phi_1)\cdot n^{\ar(\Phi_1)}}$.

    Let $\xi$ be any mapping from $\colours(\Phi_1)$ to $\colours(\Phi_2)$.
In order to verify that $\xi$ is a recolouring, it suffices to check the following three conditions.
\begin{enumerate}[i.]
    \item \label{item:rec1} For every $\struct{T}\in\colours(\Phi_1)$, the $\tau$-reducts of $\struct{T}$ and $\xi(\struct{T})$ are identical.
    \item \label{item:rec2} For every pair $\struct{T},\struct{T}'\in\colours(\Phi_1)$, every partial isomorphism $i$ from $\struct{T}$ to $\struct{T}'$ is also a partial isomorphism from $\xi(\struct{T})$ to $\xi(\struct{T}')$.
    \item \label{item:rec3} The extension $\xi'$ maps $\efm(\Phi_1)$ to $\efm(\Phi_2)$.
\end{enumerate}

Condition~\eqref{item:rec1} can be checked by inspecting the $\xi'$-image of each element of $\colours(\Phi_1)$.
Since $|\colours(\Phi_1)|\leq N$, it can be checked in time $\mathcal{O}\bigl(\hh(\Phi_1)n^nN\bigr)$.
Suppose now  that condition~\eqref{item:rec1} is satisfied.

To check condition~\eqref{item:rec2}, one goes through all pairs of elements of $\colours(\Phi_1)$ and through all their substructures and checks whether the condition holds. 
This can be done in time $\mathcal{O}\bigl(N^2 (2n)^{2n}\hh(\Phi_2)\bigr)$. 
Suppose now that conditions~\eqref{item:rec1} and~\eqref{item:rec2} are satisfied.



If condition~\eqref{item:rec3} is not satisfied, then $\xi'$ is well-defined but introduces a forbidden pattern of $\Phi_2$ into a structure that originally omitted all forbidden patterns of $\Phi_1$.
More specifically, there exists a $(\tau\cup \sigma_1)$-structure $\struct{D}$ of size at most $\wh(\Phi_2)$ such that $\xi'(\struct{D})\notin \efm(\Phi_2)$ while $\struct{D} \in \efm(\Phi_1)$.
So, to check this condition, one goes through all standard $(\tau\cup \sigma_1)$-structures of size at most $\wh(\Phi_2)$; there are at most $2^{\wh(\Phi_2)^n\hh(\Phi_1)}$ of them.
Then, for each such structure $\struct{D}$, one checks in time $\mathcal{O}\bigl(\lh(\Phi_1)\wh(\Phi_2)^{\wh(\Phi_1)}\hh(\Phi_1)n^n+\lh(\Phi_2)\wh(\Phi_2)^{\wh(\Phi_2)}\hh(\Phi_2)n^n\bigr)$ the satisfiability of the first-order parts of $\Phi_1$ and $\Phi_2$ in $\struct{D}$ and in $\xi'(\struct{D})$, respectively.
In sum, the total time needed to check condition~\eqref{item:rec3} is in $\mathcal{O}\bigl(2^{\wh(\Phi_2)^n\hh(\Phi_1)}\bigl(\lh(\Phi_1)+\lh(\Phi_2)\bigr)\wh(\Phi_2)^{\wh(\Phi_1)+\wh(\Phi_2)}n^n(\hh(\Phi_1)+\hh(\Phi_2))\bigr)$.
\end{proof}

\subsection{The theorem of Hubi\v{c}ka and Ne\v{s}et\v{r}il}

A general construction method  of $\omega$-categorical homogeneous Ramsey structures was  provided by Hubi\v{c}ka and Ne\v{s}et\v{r}il~\cite{hubickanesetril2019}.
We use a variant of their result, which can be found in the appendix of~\cite{bodirsky2018_article} (Theorem~A.4 in the print version, or Theorem~A.3 in the arXiv version).


The following notion, originating from~\cite{hubicka2015}, is of essential importance in the present article.
A \emph{piece} of a structure $\struct{B}$ is a pair $(\struct{P},\bar{t})$, where $\struct{P}$ is a proper substructure of $\struct{B}$ (with domain $P \subsetneq B$) and $\bar t$ (called the \emph{root} of $(\struct{P},\bar{t})$) is a tuple with pairwise distinct entries enumerating a non-empty subset $T$ of $P$  such that every tuple $\bar s$ contained in a relation of $\struct B$ is completely contained either in $P$ or in $T\cup (B\setminus P)$.  
\begin{remark} The definition of a piece in the present paper is more general than the one in~\cite{hubicka2015} because we do not require $\bar t$ to be a \emph{minimal separating cut} of $\struct{P}$. However, this difference does not matter here since we employ the results from~\cite{hubicka2015} in a restricted setting.
\end{remark}

 To every piece $(\struct{P},\bar{t})$, we assign a relational symbol of arity equal to the length of $\bar t$, which for the sake of brevity will be denoted by the piece itself.   
For an atomic formula $(\struct{P},\bar{t})(\bar{x})$ using such a symbol, let $\pre{(\struct{P},\bar{t})(\bar{x})}$ be the $\tau$-formula obtained from the canonical query of $\struct{P}$ by substituting $\bar{x}$ for $\bar{t}$ in the order in which both tuples are listed; that is, the formula asserts about $\bar x$  all atomic  $\tau$-formulas (with parameters) that hold for $\bar t$ in $\struct{P}$.  
Finally, the primitive positive formula $\prexists{(\struct{P},\bar{t})(\bar{x})}$ is obtained from $\pre{(\struct{P},\bar{t})(\bar{x})}$ by existentially quantifying over all variables which are not contained in $\bar{x}$. That is, the formula asserts the existence of a homomorphic image of the piece $(\struct{P},\bar{t})$ around $\bar x$, with $\bar x$ taking the place of $\bar t$.  


 
For a set  $\mathcal{F}$ of structures with a signature $\tau$, we denote by $\Forb_{h}(\mathcal{F})$ the class of all finite $\tau$-structures which do not admit a homomorphism from any member of $\mathcal{F}$.
The following theorem of Hubi\v{c}ka and Ne\v{s}et\v{r}il states that every class of the form $\Forb_{h}(\mathcal{F})$, where each member of $\mathcal{F}$ is connected, almost has the amalgamation property, up to taking an expansion where pieces of the structures in $\mathcal{F}$ are marked using fresh predicates $\rho$; moreover, the class of all linear-order expansions of structures from such a class has the Ramsey property.

\begin{theorem}[Hubi\v{c}ka and Ne\v{s}et\v{r}il, Theorem~A.4 in~\cite{bodirsky2018_article}] \label{thm:hubicka_nesetril} Let $\mathcal{F}$ be a finite set of finite connected structures over a common finite relational signature $\tau$.
Let $\rho$ be the signature whose elements are the pieces $(\struct{P},\bar{t})$ of structures from $\mathcal{F}$.
Consider the class $\mathcal{K}_{\mathrm{HN}}(\mathcal{F})$ consisting of all substructures of those $\rho$-expansions of structures from $\Forb_{h}(\mathcal{F})$ that satisfy 
\begin{equation}
    \forall \bar{x} \big((\struct{P},\bar{t})(\bar{x})  \iff   \prexists{(\struct{P},\bar{t})(\bar{x})} \big). \label{eq:HN} 
\end{equation} 
Then the class $\mathcal{K}^{<}_{\mathrm{HN}}(\mathcal{F}):=\bigl(\mathcal{K}_{\mathrm{HN}}(\mathcal{F})\bigr)^<$  has the RP and the AP. \end{theorem}

To illustrate the construction in Theorem~\ref{thm:hubicka_nesetril}, consider the two sets $\mathcal{F}_1$ and $\mathcal{F}_2$ consisting of the canonical databases of the forbidden patterns of $\Phi_1$ and $\Phi_2$ from Figure~\ref{fig:colour_patterns}. 
It is not hard to see that $\Forb_{h}(\mathcal{F}_2) $ already has the AP because the forbidden graphs are cliques; moreover, $\Forb_{h}(\mathcal{F}_2)^{<}$ has the AP and the RP by a theorem of Ne\v{s}et\v{r}il and R\"{o}dl~\cite{NESETRIL1983183}.
Therefore, $\mathcal{F}_2$ represents a trivial case where adding $\rho$-predicates is not necessary.
This is not true for $\mathcal{F}_1$, since $\Forb_{h}(\mathcal{F}_1)$ does not have the AP. 
In Figure~\ref{fig:pieces}, we provide a graphical representation of the pieces of structures that need to be stored using $\rho$-predicates in order to obtain a class of expansions of structures from $\Forb_{h}(\mathcal{F}_1)$ with the AP and the RP.


\begin{figure}[ht]
     \centering
      \includegraphics[width=0.8\linewidth]{Pieces.jpg}
     \caption{An illustration of some pieces of the canonical databases of the forbidden patterns of the SNP sentence $\Phi_1$ from Example~\ref{ex:recolouring}; the roots of the pieces are marked by the dashed lines.}
     \label{fig:pieces}
 \end{figure} 


\subsection{A proof of Theorem~\ref{thm:2NEXPTIME_for_GMSNP}} 

Besides the reduction to the connected case, the proof of Theorem~\ref{thm:2NEXPTIME_for_GMSNP} is a straightforward consequence of the combination of the following three intermediate results.
First, Lemma~\ref{lemma:recolouring_nexptime} from Section~\ref{section:recolourings} gives a (non-deterministic) double-exponential upper bound on the time complexity of finding a recolouring between two SNP sentences.
Second, Proposition~\ref{prop:from_GMSNP_to_SNP_with_AP_and_RP} below states that every connected GMSNP sentence is equivalent to an at most double-exponentially larger SNP sentence whose class of expanded finite models enjoys the AP and the RP.
Third, Proposition~\ref{prop:recolouring_containment} states that, for SNP sentences with the latter property, containment is equivalent to the existence of a recolouring. 
Here we are in fact very lucky 
that the parameters on which  Lemma~\ref{lemma:recolouring_nexptime} and  Proposition~\ref{prop:from_GMSNP_to_SNP_with_AP_and_RP} depend doubly-exponentially are different -- this will become clear in the proof of Theorem~\ref{thm:2NEXPTIME_for_GMSNP}.




 
 \begin{restatable}{proposition}{SNPAPRP}    \label{prop:from_GMSNP_to_SNP_with_AP_and_RP}  
 From every connected GMSNP $\tau$-sentence $\Phi$ one can compute in deterministic double-exponential time
an SNP $\tau$-sentence $\Delta(\Phi)$ such that:
\begin{enumerate} 
    \item $\wh(\Delta(\Phi)) \in \mathcal{O}\bigl(\wh(\Phi)\bigr)$;
    \item $\ar(\Delta(\Phi)) \in \mathcal{O}\bigl(\ar(\Phi)+\wh(\Phi)\bigr)$;
    \item $\hh(\Delta(\Phi)) \in \mathcal{O}\bigl(\hh(\Phi)+\lh(\Phi)\cdot 2^{\wh(\Phi)}\bigr)$
    \item $\lh(\Delta(\Phi)) \in \mathcal{O}\bigl(2^{(\hh(\Phi)+\lh(\Phi))\cdot 2^{\wh(\Phi)+\ar(\Phi)}}\bigr)$;
    \item \label{item:AP_andRP} $\efm(\Delta(\Phi))$ has the AP and the RP;
    \item $\fm(\Delta(\Phi))=\fm(\Phi)$.
\end{enumerate}

\end{restatable}
 
 The proof of Proposition~\ref{prop:from_GMSNP_to_SNP_with_AP_and_RP} below builds on on the proof of~\cite[Theorem~5]{bodirsky_asnp}, so we omit some details that can be found in~\cite{bodirsky_asnp}.
\begin{proof}[Proof sketch]   
Let $\Phi$ be an arbitrary connected GMSNP $\tau$-sentence.
We first obtain  signatures $\tau'$ and $\sigma'$ by introducing, for every $R\in \tau\cup \sigma$, two new symbols $R_+$ and $R_-$ of the same arity. 
Next, we obtain an auxiliary GMSNP $\tau'$-sentence $\Phi'$ from $\Phi$ as follows.
For each forbidden pattern $\phi$ of $\Phi$, the sentence $\Phi'$ contains the forbidden pattern $\phi'$ obtained by replacing each positive atom $R(\bar{x})$ with $R_+(\bar{x})$ and each negative atom $\neg R(\bar{x})$ with $R_-(\bar{x})$. 

Let $\mathcal{F}$ be the set of canonical databases for the forbidden patterns of $\Phi'$ (which are just conjunctions of positive $\tau'\cup \sigma'$-atoms); define $\rho$ from $\mathcal{F}$ as in Theorem~\ref{thm:hubicka_nesetril}.
Consider the $\tau'$-sentence $\Phi''$ with the additional existential symbols $\rho\cup \{<\}$  obtained from $\Phi'$ by adding the following new clauses.\begin{enumerate}[i.]
\item \label{item:clauses1} Clauses defining the linear order using irreflexivity, transitivity, and totality:
    \[
    \forall x,y,z\;   \neg\, {<}(x,x) \wedge  \big( {<}(x,y) \wedge {<}(y,z) \Rightarrow  {<}(x,z) \big) \wedge    \big( {<}(x,y) \vee (x=y) \vee  {<}(y,x) \big). \]
    \item \label{item:clauses2} Every clause $\phi$ in the signature $\tau'\cup \sigma' \cup \rho$ of the form $\psi(\bar{x},\bar{y})\Rightarrow (\struct{P}',\bar{t}')(\bar{x})$ (for $(\struct{P}',\bar{t}')\in \rho$) with at most $\wh(\Phi)$-many variables, where $\psi$ is a conjunction of positive atoms with the following property: 
replacing every atomic subformula $(\struct P ,\bar t)(\bar{u})$ in $\psi$ by $\pre{(\struct P ,\bar t)(\bar{u})}$ yields a $(\tau'\cup \sigma')$-formula $\psi^{-1}$ such that there exists a homomorphism $h$ from the canonical database of $\pre{(\struct{P}',\bar{t}')(\bar{x})}$ to the canonical database of $\psi^{-1}$ satisfying $h(\bar{x})=\bar{x}$.\item \label{item:clauses3} Every clause $\phi$ in the signature $\tau'\cup \sigma' \cup \rho$ with at most $\wh(\Phi)$-many variables whose forbidden pattern  is a conjunction of positive atoms with the following property: 
replacing every atomic subformula $(\struct P ,\bar t)(\bar{u})$ in $\phi$ by $\pre{(\struct P ,\bar t)(\bar{u})}$ yields a formula whose canonical database admits a homomorphism from a member of $\mathcal{F}$.
    \end{enumerate}

Before we proceed further, let us assess the size of $\Phi''$ in detail.
The number of variables per clause remains in $\mathcal{O}(\wh(\Phi))$.
The arity of the symbols from $\rho$ is in $\mathcal{O}\bigl(\ar(\Phi)+\wh(\Phi)\bigr)$, because $\Phi''$ inherits all symbols from $\Phi'$ and gains additional symbols whose arity is bounded by the domain size of structures in $\mathcal{F}$.
The number of relation symbols increases exponentially in $\wh(\Phi)$ and polynomially in the remaining parameters, more specifically it is in $\mathcal{O}\bigl(\hh(\Phi)+\lh(\Phi)\cdot 2^{\wh(\Phi)}\bigr)$; the reason is that the pieces of structures in $\mathcal{F}$ are no more than all possible substructures of structures in $\mathcal{F}$. 
Regarding the number of clauses: item~\eqref{item:clauses1} produces constant number of clauses and items~\eqref{item:clauses2} and~\eqref{item:clauses3} produce $\mathcal{O}\bigl(2^{(\hh(\Phi)+\lh(\Phi))\cdot 2^{\wh(\Phi)+\ar(\Phi)}} \bigr)$ many clauses.
The reason for the double-exponential blow-up in item~\eqref{item:clauses3} is that there are as many new clauses as there are structures of size at most $\wh(\Phi)$ over the signature of $\Phi''$.
Similarly, also item~\eqref{item:clauses2} yields a double-exponential blow-up; here the number from item~\eqref{item:clauses3} is additionally multiplied with the number of symbols in $\rho$ (i.e., pieces of structures in $\mathcal{F}$), which is in $\mathcal{O}\bigl(\lh(\Phi)\cdot 2^{\wh(\Phi)}\bigr)$.

Note that all structures in $\mathcal{F}$ are connected since $\Phi$ is connected.
By Theorem~\ref{thm:hubicka_nesetril}, the class $\mathcal{K}^{<}_{\mathrm{HN}}(\mathcal{F})$ over the signature $\tau'\cup\sigma'\cup \rho \cup \{<\}$ has the AP and the RP.
Theorem~\ref{theorem:fraisse_2} then implies that there exists a homogeneous Ramsey structure $\struct{C}$ with $\age(\struct{C})=\mathcal{K}^{<}_{\mathrm{HN}}(\mathcal{F})$.
By the construction of $\Phi''$, we have that $\age(\struct{C})=\efm(\Phi'')$; below we provide an intuitive explanation of why this is the case.
First, item~\eqref{item:clauses1} ensures that $<$ interprets as a linear order in each $\struct{A}\in \efm(\Phi'')$ which, for lack of additional clauses with $<$, is independent of the remaining signature; the same is true in each $\struct{A}\in \age(\struct{C})$.
Next, consider the remaining part $\tau'\cup \sigma'\cup\rho$ of the signature. If $\struct A\in\age(\struct C)$, then by definition, it does not admit a homomorphism from any member of $\mathcal F$; moreover,  its $\rho$-predicates are obtained through equation~\eqref{eq:HN} by definition, and hence it satisfies items~\eqref{item:clauses2} and~\eqref{item:clauses3}. Whence, $\struct A\in\efm{(\Phi'')}$. Conversely, if a finite structure  $\struct A$ satisfies the first-order part of $\Phi''$, then extending it by new elements so that the truth of all $\rho$-predicates is witnessed as in equation~\eqref{eq:HN} yields a structure in which the equivalence~\eqref{eq:HN} holds (because of item~\eqref{item:clauses2}) and which does not admit a homomorphism from any member from $\mathcal F$ (because of item~\eqref{item:clauses3}); hence $\struct A\in\age(\struct C)$.
 

We say that a set $S\subseteq C$ is \emph{correctly labelled} if every tuple $\bar{t}$ over $S$ matching the arity of some $X\in \sigma$ is contained either in $X_+^{\struct{C}}$ or in $X_-^{\struct{C}}$, but not both.
Consider the $(\tau\cup\sigma\cup \tau'\cup \sigma' \cup \rho \cup \{<\})$-expansion $\struct{C}_{\Phi}$ of $\struct{C}$ where each $R\in \tau\cup \sigma$ of arity $k$ interprets as the $k$-ary relation defined by the quantifier-free first-order formula
\begin{align}
R_+(x_1,\dots,x_k) \wedge \Bigl(\{x_1,\dots, x_k\} \textit{ is correctly labelled }\Bigr). \label{eq:correct}    
\end{align}
As first-order definable relations are preserved by automorphisms, $\struct{C}_{\Phi}$ is homogeneous Ramsey.


 

Finally, we obtain the sentence $\Delta(\Phi)$ from $\Phi''$  by first adding clauses defining $(\tau\cup \sigma)$-relations using equation~\eqref{eq:correct} and then existentially quantifying over all symbols in $\tau'\cup \sigma'$.
The length of $\Delta(\Phi)$ only increases by an additional multiplicative single exponential because we need to consider all subsets of $\bigl[\ar(\Phi)+\wh(\Phi)\bigr]$ for every relation symbol in $\sigma$; its width, height, and arity remain unchanged.
It follows from Theorem~\ref{thm:hubicka_nesetril} that $\efm(\Delta(\Phi))$ has the AP and the RP. 
Moreover, we have $\age(\struct{C}_{\Phi})=\efm(\Delta(\Phi))$.
It remains to show that $\fm(\Phi)=\fm(\Delta(\Phi))$. 
This follows from the fact that $\CSP(\struct{C}_{\Phi}^{\tau})=\fm(\Phi)=\age(\struct{C}_{\Phi}^{\tau})$.
\end{proof}


The next proposition shows that the property in item~\eqref{item:AP_andRP} of Proposition~\ref{prop:from_GMSNP_to_SNP_with_AP_and_RP} attained through the transformation $\Delta$ is sufficient for a reduction from containment to recolouring.
 
 \begin{proposition}    \label{prop:recolouring_containment}
  For SNP $\tau$-sentences $\Phi_1$ and $\Phi_2$ such that $\efm(\Phi_1)$ and $\efm(\Phi_2)$ both have the AP and the RP  the following are equivalent.
\begin{enumerate}
        \item \label{item:recolouring1} $\fm(\Phi_1)\subseteq \fm(\Phi_2)$.
        \item \label{item:recolouring2} There exists a recolouring from $\Phi_1$ to $\Phi_2$.
    \end{enumerate}  
\end{proposition}    
\begin{proof} Let $n\coloneqq \max(\ar(\Phi_1),\ar(\Phi_2))$.

``\eqref{item:recolouring1}$\Rightarrow$\eqref{item:recolouring2}''   
By Theorem~\ref{theorem:fraisse_2}, there exist homogeneous Ramsey structures $\struct{C}_1$ and $\struct{C}_2$ such that $\efm(\Phi_1)=\age(\struct{C}_1)$ and $\efm(\Phi_2)=\age(\struct{C}_2)$.
Then, $\age(\struct{C}_1^{\tau}) \subseteq  \age(\struct{C}_2^{\tau})$.
By the $\omega$-categoricity of $\struct{C}_2^{\tau}$,  Lemma~\ref{lemma:compactness} implies that there exists an embedding $e$ from $\struct{C}_1^{\tau}$ to $\struct{C}_2^{\tau}$. 
By Theorem~\ref{th:canonical_ramsey}, we may assume that $e$ is canonical as a function from $\struct{C}_1$ to $\struct{C}_2$ since the former is an $\omega$-categorical Ramsey structure.
Let $\xi'$ be the mapping from $\efm(\Phi_1)$ to $\efm(\Phi_2)$ defined as follows.
Given $\struct{A}\in \efm(\Phi_1)$, consider an arbitrary embedding $i$ from $\struct{A}$ to $\struct{C}_1$.
Then, we define $\xi'(\struct{A}) \in \efm(\Phi_2)$ with domain $A$ whose relations are defined through their preimages under $e\circ i$.   
Let $\xi$ be the restriction of $\xi'$ to $\colours(\Phi_1)$.
We claim that $\xi'$ arises from $\xi$ as in the definition of a recolouring. 

First, the $\tau$-reduct of any   $\struct{T}\in\colours(\Phi_1)$  and its $\xi$-image are identical since $\xi(\struct{T})=\xi'(\struct{T})$ is obtained by pulling back relations via the $\tau$-embedding $e\circ i$.  
For the second part of the definition pertaining to $\xi'$, let $\struct A\in\efm{(\Phi_1)}$, $\struct{T}\in\colours(\Phi_1)$,  and $f\in \binom{\struct A}{\struct{T}}$
be arbitrary; we claim that $f\in \binom{\xi'(\struct A)}{\xi(\struct{T})}$. By definition, the relations of $\xi'(\struct A)$ and of $\xi(\struct{T})$ are obtained by first embedding $\struct A$ and $\struct{T}$  into $\struct{C}_1$, then applying $e$, and then pulling back the relations from $\struct{C}_2$. This definition does not depend on the choice of the embeddings into $\struct{C}_1$, by the homogeneity of  $\struct{C}_1$ and the canonicity of $f$ -- the claim follows. 

``\eqref{item:recolouring2}$\Rightarrow$\eqref{item:recolouring1}''
Let $\struct{A}\in \fm(\Phi_1)$ be arbitrary; then there exists an expansion $\struct{A}'\in \efm(\Phi_1)$. By the definition of a recolouring we have $\xi'(\struct{A}')\in  \efm(\Phi_2)$. It also follows from this definition that  for all $\struct{T} \in \colours(\Phi_1)$ and every embedding $e\in \binom{\struct{A}}{\struct{T}}$ we have $e\in \binom{\xi'(\struct{A})}{\xi(\struct{T})}$. By our choice of $n$, this implies that the $\tau$-reduct of $\xi'(\struct{A}')$ coincides with $\struct A$. Hence $\xi'(\struct{A}')$ witnesses that  $\struct{A}\in \fm(\Phi_2)$.
\end{proof}


\begin{proof}[Proof of Theorem~\ref{thm:2NEXPTIME_for_GMSNP}] 
 By Corollary~\ref{cor:connected_matters_not}, we can restrict ourselves to connected GMSNP.
Now the statement follows directly from Proposition~\ref{prop:from_GMSNP_to_SNP_with_AP_and_RP} combined with Proposition~\ref{prop:recolouring_containment} and Lemma~\ref{lemma:recolouring_nexptime}.
To see this, note that, through the application of Proposition~\ref{prop:from_GMSNP_to_SNP_with_AP_and_RP}, the arity and width increase polynomially, the height increases single-exponentially, and the length increases double-exponentially.
According to Lemma~\ref{lemma:recolouring_nexptime}, the complexity of testing the existence of a recolouring only depends single-exponentially on the height, so a single-exponential increase in height is not an issue.
Moreover, the complexity only depends polynomially on the length, so a double-exponential increase in length is not an issue either.
We conclude that the total complexity is indeed $\TWONEXPTIME$.
\end{proof}

 
\section{Recolouring-ready GMSNP} \label{section:recolouring_ready}
We first introduce the notion of recolouring-readiness.   
Then, we give a high-level explanation of how to obtain recolouring-ready GMSNP sentences and elaborate on our claim that recolouring-readiness can be paired with a notion of a recolouring generalising the corresponding notion for MMSNP in a fashion that is less abstract than the notion introduced in Section~\ref{section:recolourings} and   closer to the idea of edge-recolourings as in equation~\eqref{eq:edge_recolouring} of Section~\ref{sec:contributions}.



\subsection{Recolouring-readiness} 
In the definition of recolouring-readiness, we will use the following weaker version of homogeneity, generalising the notion of \emph{1-homogeneity} of Bodirsky, Madelaine, and Mottet~\cite{bodirsky2018_article} from vertices to relational $\tau$-tuples. 
A relational structure $\struct{B}$ whose signature contains $\tau$ is \emph{$\tau$-edge-homogeneous} 
if it satisfies the homogeneity condition restricted to tuples $\bar{t}_1,\bar{t}_2$ contained in  $R^{\struct{B}}$ for some $R\in \tau$. 
\begin{remark} 
The $\tau$-reduct of a $\tau$-edge-homogeneous structure is not necessarily homogeneous.
Consider the disjoint union of the \emph{random graph} $(V;E)$ with a countably infinite set marked by a unary predicate $R$. For $\tau=\{E\}$, the $\tau$-reduct of this structure is $\tau$-edge-homogeneous but not homogeneous.
\end{remark} 
 A connected GMSNP $\tau$-sentence $\Phi$ is \emph{recolouring-ready} if there exists a $\tau$-edge-homogeneous $\omega$-categorical Ramsey structure $(\struct{C}_{\Phi},<)$  with the following properties. 
\begin{enumerate}[i.]
\item \label{item:1} $\age(\struct{C}_{\Phi},<)$ consists of all linear-order expansions of structures from $\age(\struct{C}_{\Phi})$. 
    \item \label{item:2} $\age(\struct{C}_{\Phi})$ consists of the finite models of  the first-order part of $\Phi$. 
    \item \label{item:3}  $\age(\struct{C}_{\Phi}^{\tau})=\CSP(\struct{C}_{\Phi}^{\tau})=\fm(\Phi)$.  
\end{enumerate} 
 
Theorem~\ref{thm:recolouring_readiness2} below is a detailed version of Theorem~\ref{thm:recolouring_readiness} from the introduction.
\begin{restatable}{theorem}{recolouringreadinesstwo}    \label{thm:recolouring_readiness2}   
   For every connected GMSNP $\tau$-sentence $\Phi$ there exists  a  recolouring-ready connected 
 GMSNP $\tau$-sentence $\Omega(\Phi)$ such that: 
\begin{enumerate} 
 \item \label{item:ready1} $\fm(\Omega(\Phi))=\fm(\Phi)$;
 \item \label{item:ready2} $\wh(\Omega(\Phi))\in\mathcal{O}(\wh(\Phi))$;
 \item \label{item:ready3} $\ar(\Omega(\Phi))\in\mathcal{O}(\ar(\Phi))$;
 \item \label{item:ready4} $\hh(\Omega(\Phi))\in\mathcal{O}\bigl(2^{(\wh(\Phi)+\ar(\Phi))^{\ar(\Phi)}\hh(\Phi)}\bigr)$;
 \item \label{item:ready5} $\lh(\Omega(\Phi))\in\mathcal{O}\bigl(2^{2^{(\wh(\Phi)+\ar(\Phi))\smash{^{\ar(\Phi)}}\cdot\hh(\Phi)}}\bigr)$.
\end{enumerate}   
 Moreover, $\Omega(\Phi)$ can be computed from $\Phi$ in nondeterministic triple-exponential time.

\end{restatable}  

\begin{proof}[Proof sketch]
   We only describe how $\Omega(\Phi)$ is constructed and discuss its size. The overall strategy is similar to the proof of Proposition~\ref{prop:from_GMSNP_to_SNP_with_AP_and_RP}, but with several thorny technical details. 

    First, for every $X\in\sigma$, we add a new symbol $\cplmt{X}$ of the same arity as $X$.
Then, for every $X\in\sigma$, we replace in every clause of $\Phi$ every negated $X$-atom with a positive $\cplmt{X}$-atom.
Next, we make every clause correctly labelled. Intuitively, for every clause $\phi(\bar x)$, every tuple $\bar y\subseteq \bar x$ such that there is an  atom $R(\bar z)$ in $\phi(\bar x)$ with $\bar y\subseteq \bar z$,
    and every $X\in\sigma$ whose arity matches the arity of $\bar y$, we replace $\phi(\bar x)$ with two new clauses $(\phi\wedge X(\bar y))(\bar x)$ and $(\phi\wedge \cplmt{X}(\bar y))(\bar x)$.
The process is repeated until the canonical databases of all clauses are correctly labelled in the sense of Proposition~\ref{prop:from_GMSNP_to_SNP_with_AP_and_RP}.
This step results in a doubly-exponential increase of the number of clauses, but is necessary because the definition of $\struct{C}_{\Phi}$ here is more involved than in Proposition~\ref{prop:from_GMSNP_to_SNP_with_AP_and_RP}.
Denote the resulting sentence by $\cplmt{\Phi}$ and the family of canonical databases of the 
    clauses of $\cplmt{\Phi}$ by $\cplmt{\mathcal{F}}$.
Now, for every $\struct{F}\in\cplmt{\mathcal{F}}$ and every piece $(\struct{P}, \bar t)$ of $\struct{F}$, we extend the tuple $\bar t$ with new variables in every possible way so that the arity of the resulting tuple $\bar s\supseteq \bar t$ matches the arity of some relation $R\in\tau$.
We define $\sigma_+$ as the signature consisting of all such symbols $(\struct{P}\cup\bar s,\bar s)(\bar s)$ associated with these pieces.
Note that $|\sigma_+|$ is at most the number of $(\tau\cup\cplmt{\sigma})$-structures on at most $\wh(\Phi)+\ar(\Phi)$ elements.
So, $|\sigma_+|$ is in $\mathcal{O}\bigl(2^{(\wh(\Phi)+\ar(\Phi))^{\ar(\Phi)}\hh(\Phi)}\bigr)$.
Finally, we obtain the sentence $\cplmt{\Phi}_+$ from $\cplmt{\Phi}$ by adding new clauses defining the predicates with a symbol in $\sigma_+$. 
We first add clauses stating that the canonical query of a piece $(\struct P\cup \bar s,\bar s)$ implies the predicate $(\struct P\cup \bar s,\bar s)$; that is, the implication $(\Leftarrow)$ in equation~\eqref{eq:HN} holds. 
As in item~\eqref{item:clauses2} from the proof of Proposition~\ref{prop:from_GMSNP_to_SNP_with_AP_and_RP}, we do this in a way that accounts for the fact that already present $\sigma_+$-predicates $(\struct P\cup \bar s,\bar s)(\bar{x})$ themselves encode formulas of the form $\prexists{(\struct P\cup \bar s,\bar s)(\bar{x})}$.
Similarly, we reproduce item~\eqref{item:clauses3} from the proof of Proposition~\ref{prop:from_GMSNP_to_SNP_with_AP_and_RP}; for convenience of the reader, we provide an explicit set of clauses:  
Let $n$ be the size of the largest element of $\cplmt {\mathcal{F}}$. 
We add to the first-order part of $\cplmt{\Phi}$ every clause in the signature $\tau\cup\cplmt{\sigma}_+$ of at most $n$ variables whose forbidden pattern is a conjunction of positive atoms with the following property:
replacing every subconjunction $(\struct P\cup \bar s,\bar s)(\bar{u})\wedge R(\bar u)$  (where $R(\bar u)$ holds in the piece) by $\pre{(\struct P\cup \bar s,\bar s)(\bar{u})}\wedge R(\bar u)$ yields a formula whose canonical database admits a homomorphism from a member of $\cplmt{\mathcal{F}}$. 
By construction, the sentence $\cplmt{\Phi}_+$ is still in GMSNP; we set
 $\Omega(\Phi) \coloneqq \cplmt{\Phi}_+$.
  
It can be verified that item~\eqref{item:ready1} holds, i.e.~that  $\fm(\cplmt{\Phi}_+)=\fm(\Phi)$.
Items~\eqref{item:ready2} and~\eqref{item:ready3} follow from the construction, item~\eqref{item:ready4} follows from the upper bound on $|\sigma_+|$.
The parameter $\lh(\cplmt{\Phi}_+)$ is bounded from above by the number of $(\tau\cup\cplmt{\sigma}_+)$-structures on at most $\wh(\Phi)+\ar(\Phi)$ elements, so it is in $\mathcal{O}\bigl(2^{(\wh(\Phi)+\ar(\Phi))^{\ar(\Phi)}|\sigma_+|}\bigr)$. Hence, item~\eqref{item:ready5} follows as well.  
\end{proof} 

\subsection{Recolourings for GMSNP}
Let $\struct{A}$ be a structure over a relational signature containing $\tau$.
We say that $\struct{A}$ is \emph{$\tau$-guarded} if there exist $R\in \tau$ and $\bar{t}\in R^{\struct{A}}$ such that $A\subseteq \bar{t}$. 
Now, let $\Phi_1$ and $\Phi_2$ be GMSNP $\tau$-sentences; as in Section~\ref{section:recolourings}, we set $n\coloneqq \max(\ar(\Phi_1),\ar(\Phi_2))$.  
A structure $\struct{A}$ with domain $[n]$ over a signature containing $<$ is \emph{standardly ordered} if $<^{\struct{A}}$ coincides with the natural ordering $1<\cdots < n$.
A \emph{GMSNP-recolouring} from $\Phi_1$ to $\Phi_2$ is a mapping $\xi$ from standardly ordered  $\tau$-guarded structures in $\colours(\Phi_1)^{<}$ to standardly ordered $\tau$-guarded structures in $\colours(\Phi_2)^{<}$ with the following two properties.
First, the $\tau$-reducts of any structure and its $\xi$-image are isomorphic.
Secondly, for every $\struct A\in \efm(\Phi_1)^{<}$, there is a structure $\xi'(\struct A)\in \efm(\Phi_2)^{<}$ on the same domain such that ${<}^{\struct{A}}={<}^{\xi'(\struct A)}$ and, for all standardly ordered $\tau$-guarded $\struct{T} \in \colours(\Phi_1)^{<}$ and for every embedding $e\in \binom{\struct{A}}{\struct{T}}$, we have $e\in \binom{\xi'(\struct{A})}{\xi(\struct{T})}$.  
Modulo the fact that the ordering of the colours matters in this definition, it is what one would intuitively understand under a recolouring of relational $\tau$-tuples.
The fact that the containment between recolouring-ready GMSNP sentences can be reduced to the existence of such a recolouring can be proved almost exactly as in the proof of Proposition~\ref{prop:recolouring_containment}.
\begin{restatable}{proposition}{recolouringreadycontainment}   \label{prop:recolouring_ready_containment}
    For connected recolouring-ready GMSNP $\tau$-sentences $\Phi_1$ and $\Phi_2$, the following are equivalent:
\begin{enumerate}
        \item \label{item:recolouring_containment1} $\fm(\Phi_1)\subseteq \fm(\Phi_2)$;
        \item \label{item:recolouring_containment2} There exists a GMSNP-recolouring from $\Phi_1$ to $\Phi_2$. 
    \end{enumerate}   
\end{restatable}   

  Now we compare the above defined GMSNP-recolourings, which depend on an external linear order, with the (linear-order-free) edge-recolourings from equation~\eqref{eq:edge_recolouring} in Section~\ref{sec:contributions}. 
We claim that, for connected recolouring-ready GMSNP sentences $\Phi_1$ and $\Phi_2$ over signatures $\tau\cup \sigma_1$ and $\tau\cup \sigma_2$, respectively, the two notions only differ up to a minor syntactic modification $\Omega'$: there exists a GMSNP-recolouring from $\Phi_1$ to $\Phi_2$ if and only if there exists an edge-recolouring from $\Omega'(\Phi_1)$ to $\Omega'(\Phi_2)$. 

We describe $\Omega'$. For every $\tau$-guarded $\struct{T}\in \colours(\Phi_i)^{<}$ of size $k\leq n$, we introduce a new $k$-ary existential symbol $X_{\struct{T}}$; the set of all such symbols is denoted by $\sigma_i^{\textit{n-colours}}$. The \emph{atomic diagram} of a structure $\struct{T}$ is the conjunction  extending  its canonical query by listing not only all the atoms that hold in $\struct{T}$, but also their negations~\cite{hodges_book}.
We replace the clauses of $\Phi_i$ by all possible clauses $\psi$ over $\tau\cup \sigma_i^{\textit{n-colours}}$ with at most $(\wh(\Phi_i)+2\cdot \ar(\Phi_i))$-many variables satisfying the monotonicity and the guarding axioms such that replacing every atom $X_{\struct{T}}(\bar{x})$ in the forbidden pattern of $\psi$ by the atomic diagram of $\struct{T}$ yields a formula that is not satisfiable together with the first-order part of $\Phi_i$.  
Note that a similar trick was used in the proof sketch of Proposition~\ref{prop:from_GMSNP_to_SNP_with_AP_and_RP}. Next, we introduce a new binary existential symbol $<$, add all clauses forbidding cycles in $<$ of size at most $\wh(\Phi_i)$, and for every $X_{\struct{T}}\in\sigma_i^{\textit{n-colours}}$ 
we add the clause $
    \forall x_1,\dots, x_k \big( X_{\struct{T}}(x_1,\dots,x_k) \Rightarrow   (\bigwedge\nolimits_{i<j} x_i<x_j)    \big). $ 
The resulting GMSNP sentence is denoted by  $\Omega'(\Phi_i)$. 

Note that  $\Omega'(\Phi_i)$ is logically equivalent to $\Phi_i$: any  $\struct A_i\in \efm{(\Phi_i)}$ can be turned into a model $\struct A_i^-$ of the first-order part of  $\Omega'(\Phi_i)$ without changing the $\tau$-relations by first equipping it with a linear order $<$, adding the predicates $\sigma_i^{\textit{n-colours}}$ according to their semantics, and then removing the $\sigma_i$-predicates; $\struct A_i^-$   satisfies the consistency clauses by definition. In the converse direction, we obtain a model $\struct A_i^+$ of the first-order part of $\Phi_i$ from a model $\struct A_i$ of  $\Omega'(\Phi_i)$ by the obvious replacement and by forgetting $<$, thanks to the consistency requirements. Note that it is also the consistency requirements that guarantee that the obvious replacement is not contradictory on overlapping $\tau$-guarded $n$-colours; to ensure this, we allowed clauses $\psi$ up to size $2\cdot \ar(\Phi_i)$. 


Let $\xi$ be a GMSNP-recolouring from $\Phi_1$ to $\Phi_2$; we claim it naturally induces an edge-recolouring from $\Omega'(\Phi_1)$ to $\Omega'(\Phi_2)$. Namely, for any  $\struct A_1\in \efm{(\Omega'(\Phi_1))}$,  we replace every predicate $X_{\struct C}$ in $\sigma_1^{\textit{n-colours}}$ which holds on some tuple in $\struct A_1$ by the predicate encoding the image of $\struct C$, ordered by the appearance of its elements in the predicate, under $\xi$. The resulting structure $\struct A_2$ is an element of $\efm{(\Omega'(\Phi_2))}$: suppose otherwise. Then $\struct A_2^+$ realizes  a forbidden pattern of $\Phi_2$ on some set $S=\{s_1,\ldots,s_{\wh{(\Phi_2})}\}$; without loss of generality, since $\Omega'(\Phi_2)$ forbids cycles of size at most $\wh(\Phi_2)$, we may assume that $s_i<s_j$ implies $i<j$ for all pairs $(s_i,s_j)$ guarded in that pattern. Let $\struct S$ be the structure induced by $S$ in $\struct A_1^+$, equipped with the order $s_1<\cdots<s_{\wh{(\Phi_2})}$; then $\xi'(\struct S)$, where $\xi'$ is obtained from $\xi$ by the definition of a GMSNP-recolouring, is a model of the first-order part of $\Phi_2$ which agrees with $\struct A_2^+$ on guarded tuples, a contradiction.

 Conversely,  given an edge-recolouring from $\Omega'(\Phi_1)$ to $\Omega'(\Phi_2)$, we trivially get that $\fm(\Phi_1)\subseteq \fm(\Phi_2)$, which means that there exists a GMSNP-recolouring from $\Phi_1$ to $\Phi_2$ due to Proposition~\ref{prop:recolouring_ready_containment} because $\Phi_1$ and $\Phi_2$ are recolouring-ready. 


 

\section{Conclusion}

We proved the decidability of the containment problem for GMSNP, thereby  settling an open question posed in~\cite{bienvenu2014,bouhris_lutz2016}.
Our decision procedure runs in non-deterministic double-exponential time, which exactly matches the lower bound on the complexity obtained in~\cite{bouhris_lutz2016}.
 

In the proof of Theorem~\ref{thm:2NEXPTIME_for_GMSNP}, our main result, we employ structural Ramsey theory to effectively reduce from the containment problem for GMSNP to the problem of testing the existence of a recolouring between SNP sentences.
As mentioned in the introduction, the use of structural Ramsey theory is only one of the possible ways to outsource combinatorics.
In fact, in all works on the containment problem for MMSNP except for~\cite{bodirsky2018_article} a different tool was used, 
commonly known as the \emph{sparse incomparability lemma}~\cite[Theorem~1]{kun2013} (Feder and Vardi originally used a weaker, randomised version of this result, which they attributed to Erd\H{o}s~\cite[Theorem~5]{federvardi1998}). 
It would be interesting to know if this alternative approach can also be used to analyse the complexity of containment for GMSNP, perhaps in combination with the reduction to \emph{relativised emptiness} from~\cite{bouhris_lutz2016}. 

Regarding our approach using structural Ramsey theory, one can clearly see that our methods have the potential to work in a broader setting than GMSNP.
More specifically, by Proposition~\ref{prop:recolouring_containment}, the $\TWONEXPTIME$ upper bound on the complexity of containment holds for all pairs of SNP sentences whose first-order part defines a class of finite structures with the AP and the RP.
The issue with this statement is that the said fragment of SNP does not have any known explicit description;
it might be difficult to judge Proposition~\ref{prop:recolouring_containment} as a stand-alone contribution 
since the complexity of recognizing which SNP sentences fall within its scope might be high, potentially even undecidable.
For a discussion of the complexity of related meta problems, see~\cite{rydval:LIPIcs.ICALP.2024.150} (cf.~also~\cite{rydval_arxiv}).
We would be interested in locating virtually any fragment of existential second-order logic that properly generalises GMSNP, can be embedded into SNP with AP and RP similarly as GMSNP, and whose syntax is efficiently verifiable as in the case of GMSNP.  

    
 
   
 






\bibliographystyle{plain}
\bibliography{CONTAINMENT}


\newpage 
\appendix 

 

\section{Containment for GMSNP}
 
\subsection{A consequence of the canonization lemma}\label{apsection:ramsey_canonical}

In this section, we show how to obtain Theorem~\ref{th:canonical_ramsey} from Theorem~5 in~\cite{bodirsky_pinsker_ramsey_canonical}.
By the theorem of Kechris, Pestov, and Todor{\v c}evi{\'c}~(Theorem~4.8 in~\cite{kechris2005fraisse}), a homogeneous structure $\struct{B}$ with a countable relational signature is Ramsey if and only if $\Aut(\struct{B})$ is \emph{extremely amenable}, and hence the property only depends on $\Aut(\struct{B})$ viewed as an abstract topological group.  
We will only use this correspondence as a blackbox to link Theorem~\ref{th:canonical_ramsey} to Theorem~5 in~\cite{bodirsky_pinsker_ramsey_canonical}. 

 

\canonlemma*
 

 
\begin{proof} 

Let $f'$ be an embedding from $\struct{A}'$ to $\struct{B}'$. 
In Theorem~5 in~\cite{bodirsky_pinsker_ramsey_canonical}, we select $\mathbf{G}\coloneqq \Aut(\struct{A})$ and $\mathbf{H}\coloneqq \Aut(\struct{B})$.
By definition, the age of the (homogeneous) expansion $\struct{B}_{\text{fo}}$ of $\struct{B}$ by all first-order definable relations has the Ramsey property, and $\Aut(\struct{B}_{\text{fo}})=\Aut(\struct{B})$.
Using K\H{o}nig's tree lemma, one can show that there exists a linear order $<$ over $B$ that is preserved by each automorphisms of $\struct{B}$, see, e.g.,~\cite[Proposition~2]{bodirsky2015ramsey}. 
Since $\struct{B}$ is $\omega$-categorical, by the theorem of Engeler, Ryll-Nardzewski and Svenonius~\cite{hodges_book}, $<$ is first-order definable in $\struct{B}$.
This means that there is a linear order among the relations of $\struct{B}_{\text{fo}}$.
Hence, by Theorem~4.8 in~\cite{kechris2005fraisse}, $\mathbf{G}$ is extremely amenable.
We remark that~\cite{kechris2005fraisse} uses the ``isomorphic substructure'' version of the Ramsey property while we use the ``embedding'' version, which is, in general, different.
However, the two versions coincide over ordered structures, which is exactly our case.
Since the prerequisites of Theorem~5 in~\cite{bodirsky_pinsker_ramsey_canonical} are satisfied, there exists a mapping 
\begin{align}
f\in \overline{\{ \beta  \circ  f' \circ  \alpha  \mid  \alpha  \in  \Aut(\struct{A}), \beta  \in  \Aut(\struct{B})\}} \label{eq:closure}
\end{align}
that is canonical from $\struct{A}$ to $\struct{B}$.
The ``overline'' notation in eq.~\eqref{eq:closure} stands for the \emph{closure} w.r.t.\ the topology of pointwise convergence;
for a set $C$ of functions from $X$ to $Y$, $\cplmt{C}$ consists of all  $g \colon X \rightarrow Y$ such that, for every finite $S\subseteq X$, there exists $f\in C$ satisfying $f|_S=g|_S$.
From this definition it is easy to see that $f$ is an embedding from $\struct{A}'$ to $\struct{B}'$. 
\end{proof} 



\subsection{From GMSNP to SNP} \label{section:appendix_gmsnp_to_snp}


\SNPAPRP* 

\begin{proof}
Let $\Phi$ be an arbitrary connected GMSNP $\tau$-sentence.
We first obtain the signatures $\tau'$ and $\sigma'$ by introducing, for every $R\in \tau\cup \sigma$, two new symbols $R_+$ and $R_-$ of the same arity. 
Next, we obtain an auxiliary GMSNP $\tau'$-sentence $\Phi'$ from $\Phi$ as follows.
For each forbidden pattern $\phi$ of $\Phi$, sentence $\Phi'$ contains the forbidden pattern $\phi'$ obtained by replacing each positive atom $R(\bar{x})$ with $R_+(\bar{x})$ and each negative atom $\neg R(\bar{x})$ with $R_-(\bar{x})$. 

Let $\mathcal{F}$ be the set of canonical databases for the forbidden patterns of $\Phi'$ (which are just conjunctions of positive $\tau'\cup \sigma'$-atoms). 
Consider the $\tau'$-sentence $\Phi''$ obtained from $\Phi'$ by including the following new clauses. 
\begin{enumerate}[i.]
\item \label{apitem:clauses1} Clauses defining the linear order using irreflexivity, transitivity, and
    \[
    \forall x,y,z\;   \neg\, {<}(x,x) \wedge    \big( {<}(x,y) \vee (x=y) \vee  {<}(y,x) \big) \wedge  \big( {<}(x,y) \wedge {<}(y,z) \Rightarrow  {<}(x,z) \big).
    \]
    \item \label{apitem:clauses2} Every clause $\phi$ in the signature $\tau'\cup \sigma' \cup \rho$ of the form $\psi(\bar{x},\bar{y})\Rightarrow (\struct{P}',\bar{t}')(\bar{x})$ (for $(\struct{P}',\bar{t}')\in \rho$) with at most $\wh(\Phi)$-many variables, where $\psi$ is a conjunction of positive atoms with the following property: 
replacing every atomic subformula $(\struct P ,\bar t)(\bar{u})$ in $\psi$ by $\pre{(\struct P ,\bar t)(\bar{u})}$ yields a $(\tau'\cup \sigma')$-formula $\psi^{-1}$ such that there exists a homomorphism $h$ from the canonical database of $\pre{(\struct{P}',\bar{t}')(\bar{x})}$ to the canonical database of $\psi^{-1}$ satisfying $h(\bar{x})=\bar{x}$.
    \item \label{apitem:clauses3} Every clause $\phi$ in the signature $\tau'\cup \sigma' \cup \rho$ with at most $\wh(\Phi)$-many variables whose forbidden pattern is a conjunction of positive atoms with the following property: 
replacing every atomic subformula $(\struct P ,\bar t)(\bar{u})$ in $\phi$ by $\pre{(\struct P ,\bar t)(\bar{u})}$ yields a formula whose canonical database admits a homomorphism from a member of $\mathcal{F}$.
    \end{enumerate}

Before we proceed further, let us assess the size of $\Phi''$ in detail.
The number of variables per clauses remains in $\mathcal{O}(\wh(\Phi))$.
The arity of the symbols from $\rho$ is in $\mathcal{O}\bigl(\ar(\Phi)+\wh(\Phi)\bigr)$, because $\Phi''$ inherits all symbols from $\Phi'$ and gains additional symbols whose arity is bounded by the domain size of structures in $\mathcal{F}$.
The number of relation symbols increases exponentially in $\wh(\Phi)$ and polynomially in the remaining parameters, more specifically it is in $\mathcal{O}\bigl(\hh(\Phi)+\lh(\Phi)\cdot 2^{\wh(\Phi)}\bigr)$; the reason is that the pieces of structures in $\mathcal{F}$ are generated by all possible substructures.
Regarding the number of clauses: Item~\eqref{apitem:clauses1} produces constant number of clauses and items~\eqref{apitem:clauses2} and~\eqref{apitem:clauses3} produce $\mathcal{O}\bigl(2^{(\hh(\Phi)+\lh(\Phi))\cdot 2^{\wh(\Phi)+\ar(\Phi)}} \bigr)$ many clauses.
The reason for the double-exponential blow-up in item~\eqref{apitem:clauses3} is that there are as many new clauses as there are structures of size at most $\wh(\Phi)$ over the signature of $\Phi''$.
Similarly, also item~\eqref{apitem:clauses2} yields a double-exponential blow-up; here the number from item~\eqref{apitem:clauses3} is additionally multiplied with the number of symbols in $\rho$ (i.e., pieces of structures in $\mathcal{F}$), which is in $\mathcal{O}\bigl(\lh(\Phi)\cdot 2^{\wh(\Phi)}\bigr)$.

Note that all structures in $\mathcal{F}$ are connected since $\Phi$ is connected.
By Theorem~\ref{thm:hubicka_nesetril}, the class $\mathcal{K}^{<}_{\mathrm{HN}}(\mathcal{F})$ over the signature $\tau'\cup\sigma'\cup \rho \cup \{<\}$ has the AP and the RP.
Theorem~\ref{theorem:fraisse_2} then implies that there exists a homogeneous Ramsey structure $\struct{C}$ with $\age(\struct{C})=\mathcal{K}^{<}_{\mathrm{HN}}(\mathcal{F})$.
By the construction of $\Phi''$, we have that $\age(\struct{C})=\efm(\Phi'')$ (Claim~\ref{claim:age_coloured}); before we give a rigorous proof, we provide an intuitive explanation of why this is the case.
First, item~\eqref{item:clauses1} ensures that $<$ interprets as a linear order in each $\struct{A}\in \efm(\Phi'')$ which, for lack of additional clauses with $<$, is independent of the remaining signature; the same is true in each $\struct{A}\in \age(\struct{C})$.
Next, consider the remaining part $\tau'\cup \sigma'\cup\rho$ of the signature. If $\struct A\in\age(\struct C)$, then by definition, it does not admit a homomorphism from any member of $\mathcal F$; moreover,  its $\rho$-predicates are obtained through equation~\eqref{eq:HN} by definition, and hence it satisfies items~\eqref{item:clauses2} and~\eqref{item:clauses3}. Whence, $\struct A\in\efm{(\Phi'')}$. Conversely, if a finite structure  $\struct A$ satisfies the first-order part of $\Phi''$, then extending it by new elements so that the truth of all $\rho$-predicates is witnessed as in equation~\eqref{eq:HN} yields a structure in which the equivalence~\eqref{eq:HN} holds (because of item~\eqref{item:clauses2}) and which does not admit a homomorphism from any member from $\mathcal F$ (because of item~\eqref{item:clauses3}); hence $\struct A\in\age(\struct C)$.
 
\begin{claim} \label{claim:age_coloured}
    $\age(\struct{C})=\efm(\Phi'')$
\end{claim}
\begin{claimproof} First, we show that every finite model of the first-order part of $\Phi''$ can be embedded into $\struct{C}$. 
To this end, let $\struct{A}\in \efm(\Phi'')$ be arbitrary.
Let $\phi$ be the canonical query of the $(\tau'\cup \sigma' \cup \rho)$-reduct of $\struct{A}$, and let $\phi^{-1}$ be the formula obtained by replacing each subformula $(\struct P,\bar t)(\bar{u})$ in $\phi$ by $\pre{(\struct P,\bar t)(\bar{u})}$.
Now, let $\struct{A}'$ be the canonical database of $\phi^{-1}$, viewed as a structure over the signature $\tau'\cup \sigma'$.
Since $\struct{A}$ satisfies every clause from item~\eqref{apitem:clauses3} for all possible variable substitutions, we have $\struct{A}'\in \Forb_h(\mathcal{F})$.
Let $\struct{A}''$ be the $(\tau'\cup \sigma' \cup \rho)$-expansion of $\struct{A}'$ where $\rho$-relations are defined using eq.~\eqref{eq:HN}.
Clearly, the substructure of $\struct{A}''$ on $A$ has all relational $\rho$-tuples of $\struct{A}$.
Since $\struct{A}$ satisfies every clause from item~\eqref{apitem:clauses2} for all possible variable substitutions, $\struct{A}$ also has all relational $\rho$-tuples of the substructure of $\struct{A}''$ on $A$.
We conclude that the $(\tau'\cup \sigma' \cup \rho)$-reduct of $\struct{A}$ is in $\mathcal{K}_{\mathrm{HN}}(\mathcal{F})$.
Since $\struct{A}$ satisfies the sentence in item~\eqref{apitem:clauses1}, $<$ interprets as a linear order in $\struct{A}$, and hence  $\struct{A}\in  \age(\struct{C})=\mathcal{K}^{<}_{\mathrm{HN}}(\mathcal{F})$.  

Next, we show that every element of $\age(\struct{C})$ satisfies the first-order part of $\Phi''$.
To this end, let $\struct{A}\in \age(\struct{C})=\mathcal{K}^{<}_{\mathrm{HN}}(\mathcal{F})$ be arbitrary.
Then, by Theorem~\ref{thm:hubicka_nesetril}, there exists a structure $\struct{A}'\in \Forb_h(\mathcal{F})$, a $\rho$-expansion $\struct{A}''$ of $\struct{A}'$ satisfying eq.~\eqref{eq:HN}, and a linear-order expansion $\struct{A}'''$ of $\struct{A}''$ such that $\struct{A}$ is a substructure of $\struct{A}'''$.
The clauses of $\Phi''$ stemming from $\Phi'$ are satisfied in $\struct{A}$ for all possible variable substitutions because $\struct{A}'\in \Forb_h(\mathcal{F})$.
We continue with the clauses coming from items~\eqref{apitem:clauses1},~\eqref{apitem:clauses2}, and~\eqref{apitem:clauses3}.
The sentence in item~\eqref{apitem:clauses1} clearly holds in $\struct{A}$ because $<$ interprets in $\struct{A}'''$ as a linear order on $A$. 
The structure $\struct{A}$ satisfies every clause from item~\eqref{apitem:clauses2} for all possible variable substitutions because $\struct{A}''$ satisfies eq.~\eqref{eq:HN}.
For item~\eqref{apitem:clauses3}, suppose, on the contrary, that there exists a clause $\phi$ whose forbidden pattern is a conjunction of positive atoms with the property as in item~\eqref{apitem:clauses3} and a tuple $\bar{a}$ over $A$ such that $\struct{A}\centernot{\models} \phi(\bar{a})$.
Since $\struct{A}''$ is defined from $\struct{A}'$ using eq.~\eqref{eq:HN}, the structure $\struct{A}'$ admits a homomorphism from a member of $\mathcal{F}$ (witnessed by the tuple $\bar{a}$ as well as the existential witnesses for eq.~\eqref{eq:HN}. 
This is a contradiction to $\struct{A}'\in \Forb_h(\mathcal{F})$, hence the clauses in item~\eqref{apitem:clauses3} hold for $\struct{A}$ as well (for all possible variable substitutions). 
\end{claimproof}




We say that a set $S\subseteq C$ is \emph{correctly labelled} if every tuple $\bar{t}$ over $S$ matching the arity of some $X\in \sigma$ is contained either in $X_+^{\struct{C}}$ or in $X_-^{\struct{C}}$, but not both.
Consider the $(\tau\cup\sigma\cup \tau'\cup \sigma' \cup \rho \cup \{<\})$-expansion $\struct{C}_{\Phi}$ of $\struct{C}$ where each $R\in \tau\cup \sigma$ of arity $k$ interprets as the $k$-ary relation defined by the quantifier-free first-order formula
\begin{align*}
R_+(x_1,\dots,x_k) \wedge \Bigl(\{x_1,\dots, x_k\} \textit{ is correctly labelled }\Bigr).  
\end{align*} 
As first-order definable relations are preserved by automorphisms, $\struct{C}_{\Phi}$ is homogeneous Ramsey.


 

Finally, we obtain the sentence $\Delta(\Phi)$: by additionally defining $(\tau\cup \sigma)$-relations using eq.~\eqref{eq:correct} and existentially quantifying over all symbols in $\tau'\cup \sigma$.
The length of $\Delta(\Phi)$ only increases by an additional multiplicative single exponential because we need to consider all subsets of $\bigl[\ar(\Phi)+\wh(\Phi)\bigr]$ for every relation symbol in $\sigma$; its width, height, and arity remain unchanged.
It follows from Theorem~\ref{thm:hubicka_nesetril} that $\efm(\Delta(\Phi))$ has the AP and the RP. 
Moreover, we have $\age(\struct{C}_{\Phi})=\efm(\Delta(\Phi))$.
It remains to show that $\fm(\Phi)=\fm(\Delta(\Phi))$.  
This is a direct consequence of the following claim.

\begin{claim}\label{claim:appendix}
    $\CSP(\struct{C}_{\Phi}^{\tau})=\fm(\Phi)=\age(\struct{C}_{\Phi}^{\tau})$.
\end{claim}
\begin{claimproof} 
Clearly, $\age(\struct{C}_{\Phi}^{\tau}) \subseteq \CSP(\struct{C}_{\Phi}^{\tau})$.
Next, we prove $\CSP(\struct{C}_{\Phi}^{\tau})\subseteq \fm(\Phi)$.
Suppose that $\struct{A}\in \CSP(\struct{C}_{\Phi}^{\tau})$, i.e., there exists a homomorphism $h\colon \struct{A}\rightarrow \struct{C}_{\Phi}^{\tau}$. 
We define $\smash{\overline{\struct{A}}}$ as the expansion of $\struct{A}$ to the signature of $\struct{C}_{\Phi}$ obtained by pulling back the relations from $\struct{C}_{\Phi}$ through $h$.
By definition, $h$ is a homomorphism from $\smash{\overline{\struct{A}}}$ to $\struct{C}_{\Phi}$.
Let $\neg \big( \psi_1\wedge \cdots \wedge  \psi_k \wedge \neg \psi_{k+1} \wedge \cdots \wedge \neg \psi_{\ell}\big)$ be a clause in $\Phi$, where each $\psi_i$ is a positive atomic formula.
Suppose that, for some tuple $\bar{a}$  over $A$, we have $\smash{\overline{\struct{A}}}\models \psi_1\wedge \cdots \wedge \psi_k(\bar{a})$.
Since $h$ is a homomorphism, we have $\struct{C}_{\Phi}\models \psi_1\wedge \cdots \wedge \psi_k(h(\bar{a}))$.
For every atom $\psi$ of the form $R(\bar{x})$ for $R\in \tau\cup \sigma$, we define $\psi^+$ as $R_+(\bar{x})$ and $\psi^-$ as $R_-(\bar{x})$.
By the definition of $\struct{C}_{\Phi}$, more specifically by~eq.~\eqref{eq:correct}, we have $\struct{C}_{\Phi}\models \psi^+_1\wedge \cdots \wedge \psi^+_k(h(\bar{a}))$.
Since $\mathcal{F}$ contains a structure associated with the forbidden pattern $\psi^+_1\wedge \cdots \wedge  \psi^+_k \wedge \psi^-_{k+1} \wedge \cdots \wedge  \psi^-_{\ell}$ and $\age(\struct{C})=\mathcal{K}^{<}_{\mathrm{HN}}(\mathcal{F})$, we must have 
$\struct{C}_{\Phi}\models \neg \psi^-_{k+1}\vee \cdots \vee \neg \psi^-_{\ell}(h(\bar{a}))$, i.e., there exists $i\in [\ell]\setminus [k]$
such that $\struct{C}_{\Phi}\models \neg \psi^-_{i}(h(\bar{a}))$.
Since $\Phi$ satisfies the guarding axiom, there exists $j \in [k]$ such that all variables $\bar{x}_i$ of $\psi_{i}$ are among the variables $\bar{x}_j$ of $\psi_{j}$.
By the assumption that the set of all entries in $h(\bar{x}_j)$ is correctly labelled, we have $\struct{C}_{\Phi}\models \psi^+_{i}(h(\bar{a}))$. 
As a subset of a correctly labelled set, the set of all entries in  $h(\bar{x}_i)$ is also correctly labelled.
Hence, by definition we have $\struct{C}_{\Phi}\models \psi_{i}(h(\bar{a}))$. 
Since $\Phi$ is monotone, $\psi_{i}$ is of the form $X(\bar{x})$ for $X\in \sigma$.
Hence, by the definition of $\smash{\overline{\struct{A}}}$, we have $\smash{\overline{\struct{A}}}\models  \psi_{i}(h(\bar{a}))$.
This means that $\smash{\overline{\struct{A}}}^{\tau\cup \sigma}$ provides the desired expansion of $\struct{A}$ in $\efm(\Phi)$.

Finally, we show $\fm(\Phi)\subseteq \age(\struct{C}_{\Phi}^{\tau})$.
Suppose that $\struct{A}\models \Phi$, and let $\struct{A}_{\Phi}$ be a $\tau\cup \sigma$-expansion of $\struct{A}$ witnessing this fact. 
We define $\struct{A}'$ as the $(\tau'\cup \sigma')$-structure with domain $A$ and where $R_+$ interprets as $R^{\struct{A}_{\Phi}}$ and $R_-$ as the complement of $R^{\struct{A}_{\Phi}}$ in $\struct{A}_{\Phi}$.
Then clearly $\struct{A}'\in \efm(\Phi')$.
Since the relations of $\struct{A}'$ satisfy the correct labelling condition,  $\struct{A}'$ is a reduct of a substructure $\smash{\overline{\struct{A}}}$ of $\struct{C}_{\Phi}$.
Clearly, the $\tau$-reduct of $\smash{\overline{\struct{A}}}$ is isomorphic to $\struct{A}$.
It follows that $\struct{A}\in \age(\struct{C}_{\Phi}^{\tau})$.  
\end{claimproof}
This finishes the proof.
\end{proof}


 




\section{Recolouring-ready GMSNP}

The present section is devoted to the proof of Theorem~\ref{thm:recolouring_readiness2}.
\recolouringreadinesstwo*
 

Recall the definition of a GMSNP-recolouring from Section~\ref{section:recolouring_ready}. 
Proposition~\ref{prop:recolouring_ready_containment} (restated below) can be proved essentially as Proposition~\ref{prop:recolouring_containment}; we include a proof for the convenience of the reader.

\recolouringreadycontainment* 
\begin{proof} Let $n\coloneqq \max(\ar(\Phi_1),\ar(\Phi_2))$.

``\eqref{item:recolouring_containment1}$\Rightarrow$\eqref{item:recolouring_containment2}''   
Let $(\struct{C}_{\Phi_1},<)$ and $(\struct{C}_{\Phi_2},<)$ be the two structures witnessing the recolouring-readiness of $\Phi_1$ and $\Phi_2$, respectively. 
Then, $\age(\struct{C}_{\Phi_1}^{\tau}) \subseteq  \age(\struct{C}_{\Phi_2}^{\tau})$.
By the properties (i) and (iii) of recolouring-readiness, we moreover have $\age(\struct{C}_{\Phi_1}^{\tau},<)\subseteq \age(\struct{C}_{\Phi_2}^{\tau},<)$.  
By the $\omega$-categoricity of $(\struct{C}_{\Phi_2}^{\tau},<)$,  Lemma~\ref{lemma:compactness} implies that there exists an embedding $e$ from $(\struct{C}_{\Phi_1}^{\tau},<)$ to $(\struct{C}_{\Phi_2}^{\tau},<)$.
By Theorem~\ref{th:canonical_ramsey}, we may assume that $e$ is canonical as a function from $(\struct{C}_1,<)$ to $(\struct{C}_2,<)$ since the former is an $\omega$-categorical Ramsey structure.
Let $\xi'$ be the mapping from $\efm(\Phi_1)^{<}$ to $\efm(\Phi_2)^{<}$ defined as follows.
Given $\struct{A}\in \efm(\Phi_1)^{<}$, consider an arbitrary embedding $i$ from $\struct{A}$ to $(\struct{C}_1,<)$.
Then, we define $\xi'(\struct{A}) \in \efm(\Phi_2)^{<}$ with domain $A$ whose relations are first defined through their preimages under $e\circ i$ and then pruned by removing all tuples that are not $\tau$-guarded from all relations other than $<$. 
Since $\Phi_2$ satisfies the monotonicity and the guarding axioms, the images of $\xi'$ are indeed in $\efm(\Phi_2)^{<}$.
Let $\xi$ be the restriction of $\xi'$ to standardly ordered $\tau$-guarded structures in $\colours(\Phi_1)^{<}$.
We claim that $\xi'$ arises from $\xi$ as in the definition of a recolouring. 

First, the $\tau$-reduct of any standardly ordered $\tau$-guarded structure $\struct{T}\in\colours(\Phi_1)^{<}$  and its $\xi$-image are identical since $\xi(\struct{T})=\xi'(\struct{T})$ is obtained by pulling back relations via the $\tau$-embedding $e\circ i$.  
For the second part of the definition pertaining to $\xi'$, let $\struct A\in\efm{(\Phi_1)}^{<}$, standardly ordered $\tau$-guarded $\struct{T}\in\colours(\Phi_1)^{<}$,  and $f\in \binom{\struct A}{\struct{T}}$
be arbitrary; we claim that $f\in \binom{\xi'(\struct A)}{\xi(\struct{T})}$.
By definition, the relations of $\xi'(\struct A)$ and of $\xi(\struct{T})$ are obtained by first embedding $\struct A$ and $\struct{T}$  into $(\struct{C}_1,<)$, then applying $e$, and then pulling back and pruning the relations from $(\struct{C}_2,<)$. 
This definition does not depend on the choice of the embeddings into $(\struct{C}_1,<)$, by the $\tau$-edge-homogeneity of $(\struct{C}_1,<)$ and the canonicity of $f$ -- the claim follows. 

``\eqref{item:recolouring_containment2}$\Rightarrow$\eqref{item:recolouring_containment1}''
Let $\struct{A}\in \fm(\Phi_1)$ be arbitrary; then there exists an expansion $\struct{A}'\in \efm(\Phi_1)^{<}$. By the definition of a recolouring we have $\xi'(\struct{A}')\in  \efm(\Phi_2)^{<}$. It also follows from this definition that  for all $\struct{T} \in \colours(\Phi_1)$ and every embedding $e\in \binom{\struct{A}}{\struct{T}}$ we have $e\in \binom{\xi'(\struct{A})}{\xi(\struct{T})}$. By our choice of $n$, this implies that the $\tau$-reduct of $\xi'(\struct{A}')$ coincides with $\struct A$. Hence $\xi'(\struct{A}')$ witnesses that  $\struct{A}\in \fm(\Phi_2)$.
\end{proof}

 
Finally, we prove Theorem~\ref{thm:recolouring_readiness2}.
\begin{proof}[Proof of Theorem~\ref{thm:recolouring_readiness2}] We divide the proof into six clearly labelled paragraphs (Steps~1--6).

{\emph{Step 1: Colour complements.}} We first obtain the signature $\cplmt{\sigma} \supseteq \sigma$ by introducing, for every $X\in \sigma$, a new symbol $\cplmt{X}$ of the same arity. 
Then we replace, for every $X\in \sigma$, each positive atom $X(\bar{x})$ in each clause of $\Phi$ by the negative atom $\neg \cplmt{X}(\bar{x})$. 
The GMSNP sentence $\cplmt{\Phi}$ is then obtained by moreover including clauses of the form 
\begin{equation}
     \neg \big(  R(\bar{x}) \wedge  \neg X(\bar{y}) \wedge \neg  \cplmt{X}(\bar{y})\big) \qquad \text{and} \qquad  \neg \big(   R(\bar{x}) \wedge X(\bar{y}) \wedge \cplmt{X}(\bar{y})\big) \label{eq:correctly_labeled}
 \end{equation}  
for all symbols $R\in \tau$ and $X\in \sigma$, where $\bar{y}\subseteq \bar{x}$ are tuples of fresh variables matching the arities of $R$ and $X$.  Since $\Phi$ satisfies the guarding axiom, we have $\fm(\cplmt{\Phi})=\fm(\Phi)$. 
Note that $\lh(\cplmt{\Phi})\in \mathcal{O}(\lh(\Phi))$, $\ar(\cplmt{\Phi})=\ar(\Phi)$, $\wh(\cplmt{\Phi})=\wh(\Phi)$, and $\hh(\cplmt{\Phi})=2\cdot\hh(\Phi)$.

 
{\emph{Step 2: Correct labellings.}}
Let $\struct B$ be a structure over any relational signature containing $\tau\cup \cplmt{\sigma}$.
We call a tuple $\bar{s}$ over $B$ $(\tau\cup \cplmt{\sigma})$-\emph{guarded} in $\struct{B}$ if there exists $R\in \tau\cup \cplmt{\sigma}$ and $\bar{t}\in R^{\struct{B}}$ such that $\bar{s}\subseteq \bar{t}$.
We call a structure $\struct B$  \emph{correctly labelled} if every tuple $\bar{s}$ over $B$ $(\tau\cup \cplmt{\sigma})$-\emph{guarded} in $\struct{B}$ and matching the arity of some $X\in \sigma$ is contained either in $X^{\struct{B}}$ or in $\cplmt{X}^{\struct{B}}$, but not both. 
Note that,  before the addition of clauses of the form~\eqref{eq:correctly_labeled} 
to $\cplmt{\Phi}$, the forbidden patterns were conjunctions of positive $(\tau\cup \cplmt{\sigma})$-atoms.
Let $\cplmt{\mathcal{F}}$ be the set of all correctly labelled $(\tau\cup\cplmt{\sigma})$-structures that can be obtained from the canonical databases of such  forbidden patterns by adding tuples to $\cplmt{\sigma}$-predicates. 

{\emph{Step 3: Guarded pieces.}} Before applying  Theorem~\ref{thm:hubicka_nesetril} essentially to $\cplmt{\mathcal{F}}$, we will view the structures therein formally in an extended signature as follows.
For every piece $(\struct P,\bar t)$ of a structure $\struct S$ in $\cplmt{\mathcal{F}}$, consider all correctly labelled extensions $\struct S'$ of $\struct S$ by the elements of a tuple $\bar s\supseteq \bar t$ such that all elements of $\bar s\setminus \bar t$ are fresh and  such that $R(\bar s)$ holds for some $R\in \tau$. 
 For every such extension $\struct S'$, we add its piece $(\struct P\cup\bar s,\bar s)$ to the  signature  $\sigma_+$, view the structures in $\cplmt{\mathcal{F}}$ as ($\tau\cup\cplmt{\sigma}\cup\sigma_+$)-structures,  and say that the original piece $(\struct P,\bar t)$ is \emph{guarded} by $(\struct P\cup\bar s,\bar s)$ in $\sigma_+$.  
Note that we do not add any structures to $\cplmt{\mathcal{F}}$. 
The size $|\sigma_+|$ is less than the number of $(\tau\cup\cplmt{\sigma})$-structures on at most $M+k$ elements, where $M\coloneqq\wh(\Phi)$ and $k\leq\ar(\Phi)$ is the maximal arity of a $\tau$-relation.
So, $|\sigma_+|$ has an upper bound $(M+k)\cdot 2^{(M+k)^k\hh(\cplmt{\Phi})}$.


{\emph{Step 4: The AP and the RP.}}
Let $\mathcal G$ be the set of all structures $\struct{S}$ with domain $\bar s$ for which there exists a unique $R\in\tau$ and $(\struct P\cup\bar s,\bar s)\in \sigma_+$ as above such that $R(\bar s)$ and $(\struct P\cup\bar s,\bar s)(\bar s)$ are the only atoms holding in $\struct{S}$. 
Let $<$, $\rho$, and  $\mathcal{K}^{<}_{\mathrm{HN}}$ be as in~Theorem~\ref{thm:hubicka_nesetril}  for the set  $\cplmt{\mathcal{F}}\cup\mathcal G$.  
Let $\mathcal K$ be the subclass of all correctly labelled elements of $\mathcal{K}^{<}_{\mathrm{HN}}$. Let us remark that the predicates in $\rho$ are disjoint from those in $\sigma_+$, since they denote pieces of structures in the signature $\tau\cup\cplmt{\sigma}\cup\sigma_+$ (even if the structures of  $\cplmt{\mathcal{F}}$ have empty $\sigma_+$-relations).
The following auxiliary statement is a straightforward consequence of the two facts that $\mathcal{K}^{<}_{\mathrm{HN}}$ has the AP and the RP, and that the structures in $\mathcal{K}$ and $\cplmt{\mathcal{F}}$ are correctly labelled. 
 
\begin{claim}
  \label{lemma:AP}  
  $\mathcal{K}$ has the AP and the RP.
\end{claim}  

 Since $\mathcal{K}$ trivially has \emph{joint embedding property} (cf.~\cite{hodges_book}), the AP is in fact implied by the RP~\cite{nesetril2005}. 
For illustrative purposes, we choose not to rely on this fact and instead first prove the AP as a special case of the RP. We also remark that the  AP follows immediately from the fact that the class provided by Theorem~\ref{thm:hubicka_nesetril} has the \emph{amalgamation property}, but we chose to present the proof of the AP as otherwise we  would have to prove the RP anyway.
\begin{claimproof}[Proof of Claim~\ref{lemma:AP}]
Let $\struct{C}$ and $\struct{D}$ be arbitrary elements of $\mathcal{K}$ whose substructures on $C\cap D$ are identical.
Clearly, $\struct{C}$ and $\struct{D}$ belong to  $\mathcal{K}^{<}_{\mathrm{HN}}$, and,
by Theorem~\ref{thm:hubicka_nesetril}, $\mathcal{K}^{<}_{\mathrm{HN}}$ has the AP.
Hence, there exists an amalgamation witness $\struct{W'}\in \mathcal{K}^{<}_{\mathrm{HN}}$ for $(\struct{C},\struct{D})$ such that $\struct C$ and $\struct D$ are substructures of $\struct{W'}$. 
We obtain $\struct W$ from $\struct W'$ by removing all tuples from relations with a symbol in $\tau$ witnessing that $\struct W'$ is incorrectly labelled.
We claim that \eqref{eq:HN} of Theorem~\ref{thm:hubicka_nesetril} still holds. Indeed, note first that all predicates in $\rho$ are pieces of structures in $\cplmt{\mathcal{F}}$, since the structures of $\mathcal{G}$ do not contain any pieces. 
Now if a $\rho$-predicate holds for a tuple in $\struct W'$, then the witness (according to the equivalence in \eqref{eq:HN} of Theorem~\ref{thm:hubicka_nesetril}) of this fact remains a witness in $\struct W$  because all witnesses in $\cplmt{\mathcal{F}}$ are correctly labelled, and therefore they remain unaltered.  Conversely, if a $\rho$-predicate does not hold for a tuple in $\struct W'$, then it also does not hold in $\struct W$, as the removal only reduces witnesses.  
It is now easy to see that $\struct W$ belongs to $\mathcal{K}$.
Also, since $\struct{C}$ and $\struct{D}$ are correctly labelled, no tuple that is contained entirely in $C$ or $D$ is ever removed, and hence  the modified structure $\struct W$  is still an amalgamation witness for $(\struct{C},\struct{D})$.

The RP can be shown in exactly the same way as the AP, by removing tuples from relations with a symbol in $\tau$ from a Ramsey witness $\struct W'$ in $\mathcal{K}^{<}_{\mathrm{HN}}$ for $(\struct{C},\struct{D})$ and $k\in \mathbb{N}$.
One important detail is that the removal of tuples might introduce new copies of $\struct{C}$.
But note that these copies cannot be contained in any old copy of $\struct{D}$ because it is correctly labelled.
\end{claimproof} 
 
{\emph{Step 5: The final first-order expansion.}}
Let $\struct U$ be the Fra\"{i}ss\'{e}  limit of $\mathcal K$. Then  $\age(\struct U^{\tau\cup\cplmt{\sigma}})$ consists  precisely of the models of the first-order part of $\cplmt{\Phi}$; however,  the  expansion of $\struct U^{\tau\cup\cplmt{\sigma}}$ by $<$ might not be $\tau$-edge homogeneous. 
We will resolve this by adding redefined relations with symbols in $\sigma_+$, and then modifying $\cplmt{\Phi}$ accordingly. 

As for the former, consider every $(\struct P\cup\bar s,\bar s)$ in $\sigma_+$ obtained by extending a piece $(\struct P,\bar t)$ by the tuple   $\bar s$ and imposing   $R(\bar s)$ for some $R\in \tau$. On tuples in $R^{\struct{U}}$, the corresponding predicate currently never holds, as ensured by $\mathcal G$ above; on all other tuples, the predicate is random in the sense that no restrictions have been imposed in the construction of $\struct U$. 
We now add  all tuples in $R^{\struct{U}}$ to the relation interpreting $(\struct P\cup\bar s,\bar s)$  for which the implication $(\Leftarrow)$ in  \eqref{eq:HN} of Theorem~\ref{thm:hubicka_nesetril} requires it, thereby obtaining a structure $\struct{U_{\mo}}$. Note that the $\sigma_+$-relations of $\struct{U_{\mo}}$ are first-order definable from those of $\struct U$, and vice-versa; hence, the two structures have the same automorphism group.
Denote $ \cplmt{\sigma}_+\coloneqq {\cplmt{\sigma}\cup\sigma_+}$.
All $\rho$-relations being first-order definable in $\struct U^{\tau\cup \cplmt{\sigma}_+}$, we next conclude  that $\Aut(\struct U_{\mo}^{\tau\cup \cplmt{\sigma}_+},<)=\Aut(\struct{U})$. 
It follows immediately that   $(\struct U_{\mo}^{\tau\cup \cplmt{\sigma}_+},<)$ is Ramsey and $\omega$-categorical. 
It remains to prove that it is $\tau$-edge homogeneous; this can be done using the two facts that $\struct{U}$ is homogeneous and that the pieces of structures in $\cplmt{\mathcal{F}}$ are guarded in  $\sigma_+$.  
 

\begin{claim}    \label{lemma:tau_edge_homogeneity}  
 $(\struct U_{\mo}^{\tau\cup \cplmt{\sigma}_+},<)$ is $\tau$-edge homogeneous. 
\end{claim} 
\begin{claimproof} Let $i$ be a partial isomorphism on $(\struct U_{\mo}^{\tau\cup\cplmt{\sigma}_+},<)$, defined on  a tuple $\bar u$ which is contained in some $\tau$-relation. By the homogeneity of $\struct U$, the map $i$ extends to an automorphism of $\struct U$, and hence of $(\struct U_{\mo}^{\tau\cup\cplmt{\sigma}_+},<)$ which has the same automorphisms, if $i$ is also a partial isomorphism on $\struct U$. 
The only potential obstacle to this are the predicates with a symbol in $\sigma_+$ (since these have been modified passing from $\struct U$ to $\struct U_{\mo}$) and in $\rho$ (since we are considering the  reduct without the $\rho$-relations). 

As for the former, suppose that for some tuple $\bar u'\subseteq\bar u$, we have that $(\struct P\cup \bar s,\bar s)(\bar u')$ holds in $\struct U$, where $(\struct P\cup \bar s,\bar s)$ is a  $\sigma_+$-symbol   extending a $\rho$-piece $(\struct P,\bar t)$ with $R(\bar s)$ for some $R\in \tau$. Since the construction of the original $\sigma_+$-relations involved the set $\mathcal G$, this implies that $R^{\struct U}(\bar u')$ does not hold, as atomic formulas with symbols $R$ and $(\struct P\cup \bar s,\bar s)$ never hold in $\struct{U}$ simultaneously. Hence, in the construction of $\struct U_{\mo}$, the relation interpreting $(\struct P\cup \bar s,\bar s)$ is neither modified on $\bar u'$ nor on its image under $i$, and since $i$ is a partial isomorphism on $\struct U_{\mo}^{\tau\cup\cplmt{\sigma}_+}$, we have that $(\struct P\cup \bar s,\bar s)(i(\bar u'))$ holds also in $\struct U$. Together with the same argument for  the inverse of $i$ we get that $i$ is a partial isomorphism of $\struct{U}$ even with respect to the original $\sigma_+$-relations.

Now consider the  case of $\rho$-relations. 


Suppose that, for some tuple $\bar u'\subseteq\bar u$ and for some $(\struct P,\bar t)(\bar x)\in\rho$, $(\struct P,\bar t)(\bar u')$ holds in $\struct{U}$.
As $\bar u\in R^\struct{U}$ for some $R\in\tau$, we have that $(\struct P\cup \bar s,\bar s)(\bar u)$ holds in $\struct{U}_{\mo}$, where $\bar s$ extends $\bar t$ in the same way as $\bar u$ extends $\bar u'$.
As $i$ is a partial isomorphism, we also have that $(\struct P\cup \bar s,\bar s)(i(\bar u))$ holds in $\struct{U}_{\mo}$, which implies that $(\struct P,\bar t)(i(\bar u'))$ holds in $\struct{U}$.

Again, with the same argument for the inverse of $i$, we conclude that $i$ is indeed a partial isomorphism on $\struct U$.
\end{claimproof}

 
{\emph{Step 6: Back to GMSNP.}}
As announced in the previous step, we shall now expand $\cplmt{\Phi}$ by new clauses defining the predicates with a symbol in $\sigma_+$. 
Let $n$ be the size of the largest element of $\cplmt {\mathcal{F}}$. 
We add to the first-order part of $\cplmt{\Phi}$ the following.
\begin{enumerate}[i.] 
    \item \label{apitem:gmsnpclauses1} Every clause in the signature $\tau\cup\cplmt{\sigma}_+$ of the form $
    \psi(\bar{x},\bar{y}) \wedge R'(\bar x) \Rightarrow (\struct P'\cup \bar s',\bar s')(\bar{x})$ with at most $n$ variables, where $R'\in \tau$ and $R'(\bar s')$
    holds in the piece $(\struct P'\cup \bar s',\bar s') \in \sigma_+$ and $\psi$ is a conjunction of positive atoms with the following property: 
replacing every subconjunction $(\struct P\cup \bar s,\bar s)(\bar{u})\wedge R(\bar u)$   by $\pre{(\struct P\cup \bar s,\bar s)(\bar{u})}\wedge R(\bar u)$ yields a   $(\tau\cup \cplmt{\sigma}_+)$-formula $\psi^{-1}$ such that there exists a homomorphism $h$ from the canonical database of $\pre{(\struct P'\cup \bar s',\bar s')(\bar{x})}$ to the canonical database of $\psi^{-1}$ satisfying $h(\bar{x})=\bar{x}$.    
    \item \label{apitem:gmsnpclauses2}  Every clause in the signature $\tau\cup\cplmt{\sigma}_+$ of at most $n$ variables whose forbidden pattern is a conjunction of positive atoms with the following property:
    replacing every subconjunction $(\struct P\cup \bar s,\bar s)(\bar{u})\wedge R(\bar u)$   by $\pre{(\struct P\cup \bar s,\bar s)(\bar{u})}\wedge R(\bar u)$ yields a formula whose canonical database admits a homomorphism from a member of $\cplmt{\mathcal{F}}$. 
    \end{enumerate}


\begin{claim} 
    $\age(\struct U_{\mo}^{\tau\cup\cplmt{\sigma}_+})=\efm(\cplmt{\Phi}_+)$.
\end{claim}
\begin{claimproof}  
First, we show that every finite model of the first-order part of $\cplmt{\Phi}_+$ can be embedded into $\struct U_{\mo}^{\tau\cup\cplmt{\sigma}_+}$. 
To this end, let $\struct{A}\in \efm(\cplmt{\Phi}_+)$ be arbitrary.
Let $\phi$ be its canonical query, and modify $\phi$ by replacing conjuncts of the form $(\struct P\cup \bar s,\bar s)(\bar u)\wedge R(\bar u)$ with canonical conjunctive queries of the corresponding $(\tau\cup\cplmt{\sigma})$-structures $(\struct P\cup \bar s,\bar s)$.
We denote the resulting $(\tau\cup\cplmt{\sigma})$-formula by $\phi^{-1}$.
Let $\struct A'$ be the canonical database of $\phi^{-1}$, viewed as a $(\tau\cup\cplmt{\sigma}_+)$-structure. 
Note that, for every tuple $\bar u$ of elements of $\struct{A}'$, whenever $(\struct P\cup \bar s,\bar s)(\bar u)$ holds in $\struct{A}'$, then $R(\bar u)$ does not hold in $\struct{A}'$, where $(\struct P\cup \bar s,\bar s)\in\sigma_+$ is obtained from a piece $(\struct P,\bar t)$ by imposing $R$ on $\bar s\supseteq \bar t$. Hence, $\struct A'$ is contained in $\Forb_h(\mathcal G)$.
Moreover, $\struct A'$ is in $\Forb_{h}(\cplmt{\mathcal{F}})$ because $\struct{A}$ satisfies the clauses in item~\eqref{apitem:gmsnpclauses2} for all possible variable substitutions. 
It is also correctly labelled since  $\struct A$ is (being a model of the first-order part of $\cplmt{\Phi}_+$) and since all elements of $\cplmt{\mathcal{F}}$ are (by definition). Expanding $\struct A'$ by relations in $\rho$ according to~\eqref{eq:HN} of Theorem~\ref{thm:hubicka_nesetril}  and by an arbitrary linear order $<$, we therefore obtain an embedding $i$ into  $\struct{U}$. 

We claim that $i$ restricted to the domain $A$ of $\struct A$  is an embedding of  $\struct A$ into ${\struct U^{\tau\cup\cplmt{\sigma}_+}_{\mo}}$, showing that  $\struct A$ indeed belongs to $\age(\struct U_{\mo}^{\tau\cup\cplmt{\sigma}_+})$. 
Since only relations with a symbol in $\sigma_+$ were modified in $\struct{U}_{\mo}$, we must only verify this for such relations.
Moreover, we must only consider particular $\tau$-guarded tuples in said relations.
To this end, choose any $(\struct P\cup\bar s,\bar s)\in\sigma_+$ obtained by extending a piece $(\struct P,\bar t)$ by the tuple  $\bar s$ and imposing   $R(\bar s)$ for some $R\in \tau$. 
Let $\bar u$ be a tuple over $A$ such that $R(\bar u)$ holds in $\struct{A}$.


First, suppose that $(\struct P\cup\bar s,\bar s)(\bar u)$ holds in $\struct{A}$.
Then, by the construction of $\struct A'$, there exists a tuple $\bar u'$ over $A$ with $\bar u'\subseteq \bar u$  and such that  $\prexists{(\struct P,\bar t)(\bar{u}')}$ holds in $\struct A'$.
Since $i$ is a homomorphism, we have that $\prexists{(\struct P,\bar t)(i(\bar{u}'))}$ holds in $\struct U$. 
By the construction of $\struct{U}_{\mo}$, it follows that $(\struct P\cup\bar s,\bar s)(i(\bar u))$ holds in $\struct{U}_{\mo}$.


Second, suppose that $(\struct P\cup\bar s,\bar s)(i(\bar u))$ holds in $\struct{U}_{\mo}$.
By the construction of $\struct{U}_{\mo}$, it follows that $\prexists{(\struct P,\bar t)(i(\bar{u}'))}$ holds in $\struct U$ for a tuple $\bar u'$ over $A$ with $\bar u'\subseteq \bar u$.
Since $\struct U$ satisfies eq.~\eqref{eq:HN} of Theorem~\ref{thm:hubicka_nesetril}, also $(\struct P,\bar t)(i(\bar{u}'))$ holds in $\struct U$.
Since $i$ is an embedding with respect to  relations with a symbol in $\rho$, we have that $(\struct P,\bar t)(\bar u')$ holds in the $\rho$-expansion of $\struct{A}'$ witnessing the existence of $i$.
But since~\eqref{eq:HN} of Theorem~\ref{thm:hubicka_nesetril} also determines the relations with a symbol in $\rho$ in the said expansion of $\struct{A}'$, it must be the case that $\prexists{(\struct P,\bar t)(\bar{u}')}$ holds in $\struct A'$.
Since $\struct{A}$ satisfies the clauses in item~\eqref{apitem:gmsnpclauses1} for all possible variable substitutions,  it follows that $(\struct P\cup\bar s,\bar s)(\bar u)$ holds in $\struct{A}$. 



Next, we show that every element of $\age(\struct U_{\mo}^{\tau\cup\cplmt{\sigma}_+})$ satisfies the first-order part of $\cplmt{\Phi}_+$.
To this end, let $\struct{A}\in \age(\struct U_{\mo}^{\tau\cup\cplmt{\sigma}_+})$ be arbitrary; without loss of generality, $\struct{A}$ is a substructure of $\struct U_{\mo}^{\tau\cup\cplmt{\sigma}_+}$.
Then there exists a larger finite substructure $\struct{A}'$ of $\struct U_{\mo}^{\tau\cup\cplmt{\sigma}_+}$ extending $\struct{A}$ such that the existential witnesses for the primitive positive definitions of the $\cplmt{\sigma}_+$-relations of $\struct{A}$ in $\struct{U}$ are contained in $A'$.
The way how $\cplmt{\sigma}_+$-relations are defined in $\struct U_{\mo}^{\tau\cup\cplmt{\sigma}_+}$ from $\struct{U}$ over $A'$ and how $\struct{U}$ is constructed from $\cplmt{\mathcal{F}}\cup \mathcal{G}$ ensures that $\struct{A}$ satisfies the clauses in items~\eqref{apitem:gmsnpclauses1} and~\eqref{apitem:gmsnpclauses2} for all possible variable assignments.
Hence $\struct{A}\in \efm(\cplmt{\Phi}_+)$.
\end{claimproof}



 
Note that $\wh(\cplmt{\Phi}_+) = \wh(\Phi) = M$, $\ar(\cplmt{\Phi}_+)=(\Phi)$, and  $\hh(\cplmt{\Phi}_+) = |\sigma_+|$.
The size $\lh(\cplmt{\Phi}_+)$ is bounded from above by the number of $(\tau\cup\cplmt{\sigma}_+)$-structures of size at most $M+k$, so it is bounded by $2^{M^k|\sigma_+|}$. 
The statement of the theorem now follows by defining  $\Omega(\Phi)\coloneqq\cplmt{\Phi}_+$; we have established that $\fm(\cplmt{\Phi}_+)=\fm(\Phi)$. 
The property of recolouring-readiness of $\Omega(\Phi)$ is witnessed by setting $(\struct C_\Phi,<)\coloneqq(\struct U^{\tau\cup\cplmt{\sigma}_+},<)$.  
\end{proof}
  
\end{document}
